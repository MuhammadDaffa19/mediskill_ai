<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MediSkill AI Assistant</title>
    <style>
        :root{
        --bg:#e9eef6;
        --panel:#eef4fb;
        --neu-light:#ffffff;
        --brand1:#0ea5e9;
        --brand2:#6366f1;
        --muted:#566274;
        --text:#0f172a;
        }

        /* Overlay / card */
        .ms-overlay {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(4,8,20,0.35);
        z-index: 99999;
        padding: 20px;
        }

        .ms-card {
        width: min(960px,100%);
        max-width: 960px;
        border-radius: 18px;
        background: var(--panel);
        display: flex;
        overflow: hidden;
        box-shadow: 8px 8px 18px rgba(168,179,196,0.35), -8px -8px 18px rgba(255,255,255,0.8);
        height: 520px;
        box-sizing: border-box;
        }

        /* LEFT panel: avatar + description */
        .ms-left {
        width: 40%;
        min-width: 300px;
        padding: 28px 26px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 14px;
        background: linear-gradient(135deg, var(--brand1), var(--brand2));
        color: white;
        position: relative;
        box-sizing: border-box;
        }

        /* Avatar container — perfect circle, no gap */
        .ms-ai-photo {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;                   /* ensure no internal spacing */
        background: transparent;
        box-shadow: 0 8px 18px rgba(0,0,0,0.16);
        border: 6px solid rgba(255,255,255,0.08); /* subtle ring */
        box-sizing: border-box;
        flex-shrink: 0;
        }

        /* <img> must fully fill the circle without gaps */
        .ms-ai-photo img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        }

        /* Left description card — readable, wrapped, and scrollable if long */
        .ms-left-desc {
        color: rgba(255,255,255,0.95);
        font-size: 13px;
        line-height: 1.5;
        max-width: 240px;         /* line-length comfortable */
        text-align: center;
        padding: 12px 14px;
        background: rgba(255,255,255,0.06);
        border-radius: 12px;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
        word-wrap: break-word;
        max-height: 220px;        /* prevent left panel growing too tall */
        overflow-y: auto;         /* allow internal scroll for long text */
        -webkit-overflow-scrolling: touch;
        box-sizing: border-box;
        }

        /* subtle fade-in helper for left description */
        .ms-left-desc.fade-in { opacity: 0; transform: translateY(6px); transition: opacity .36s ease, transform .36s ease; }
        .ms-left-desc.fade-in.visible { opacity: 1; transform: translateY(0); }

        /* RIGHT panel: slides + fixed controls/footer */
        .ms-right {
        flex: 1;
        padding: 18px 22px;
        display: flex;
        flex-direction: column;
        min-width: 360px;
        height: 100%;
        box-sizing: border-box;
        }

        /* wrapper controlling internal scroll and sticky controls */
        .ms-slides-wrap {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1 1 auto;
        min-height: 0; /* important for correct overflow inside flex */
        }

        /* internal scroll area for slides */
        .ms-slides {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 6px 6px 12px 6px;
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
        }

        /* --- Fix: header layout + close button positioning --- */
        .ms-header {
        display: flex;
        align-items: flex-start;      /* top align sehingga tombol di pojok atas */
        justify-content: space-between;
        gap: 12px;
        padding: 6px 0 12px 0;
        box-sizing: border-box;
        }

        /* style untuk teks header (jaga jarak kiri) */
        .ms-header > div {
        display: flex;
        flex-direction: column;
        gap: 2px;
        }

        /* Make close button compact, consistently aligned at top-right */
        .ms-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        min-height: 36px;
        padding: 6px 10px;
        border-radius: 10px;
        background: var(--panel);
        color: var(--text);
        font-weight: 700;
        box-shadow: 6px 6px 12px rgba(168,179,196,0.28), -6px -6px 12px rgba(255,255,255,0.9);
        border: none;
        cursor: pointer;
        margin-left: 12px;            /* dorong ke kanan */
        flex-shrink: 0;
        }

        /* Jika layout jadi rapat di layar kecil, pastikan tombol tetap di baris yang sama */
        @media (max-width:880px){
        .ms-header { align-items: center; padding-bottom:8px; }
        .ms-close { min-width: 34px; min-height: 34px; padding:6px 8px; }
        }

        /* --- Fix: left paragraph readability --- */
        .ms-left-desc {
        color: rgba(255,255,255,0.96);
        font-size: 14px;
        line-height: 1.55;          /* baca lebih nyaman */
        text-align: center;         /* tetap gaya sebelumnya */
        
        /* spacing */
        padding: 14px 16px;
        margin-top: 12px;

        /* batas lebar agar paragraf tidak terlalu panjang */
        max-width: 250px;

        /* hilangkan scroll sepenuhnya */
        max-height: none;
        overflow: visible;

        /* tampilan kotak */
        background: rgba(255,255,255,0.06);
        border-radius: 12px;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);

        word-break: break-word;
        white-space: normal;         /* pastikan text wrap normal */
        }

        /* Jika ingin teks lebih ke kiri pada layar sangat lebar, tambahkan sedikit padding lateral */
        @media (min-width: 1100px) {
        .ms-left-desc { max-width: 300px; }
        }

        /* mobile tweak: jangan kebesaran */
        @media (max-width:420px){
        .ms-left-desc { font-size:13px; max-width: 90%; padding:10px; line-height:1.5; }
        }

        /* Slide styles */
        .ms-slide { display: none; padding: 6px; box-sizing: border-box; }
        .ms-slide.active { display: block; }
        .ms-slide-content { display:flex; flex-direction:column; justify-content:center; gap:10px; min-height:260px; box-sizing:border-box; }
        .ms-slide-inner { display:flex; flex-direction:column; gap:10px; padding-right:6px; max-height: calc(100%); overflow:auto; box-sizing:border-box; }
        .ms-emoji { font-size:34px; }
        .ms-slide-title { font-size:16px; font-weight:700; color:var(--text); margin-bottom:6px; }
        .ms-slide-desc { color:var(--muted); line-height:1.6; margin-bottom:12px; white-space: normal; word-break: break-word; }

        /* lists inside description */
        .ms-slide-desc ul { margin:8px 0 0 18px; padding-left: 0; line-height:1.45; }

        /* feature grid under some slides */
        .ms-feature-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:8px; box-sizing:border-box; }
        .ms-feature { background:var(--neu-light); border-radius:12px; padding:10px; display:flex; gap:8px; align-items:center; box-shadow:6px 6px 12px rgba(168,179,196,0.35), -6px -6px 12px rgba(255,255,255,0.9); }
        .ms-feature .icon { width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:white; font-weight:700; }

        /* Controls and footer always visible (outside scroll area) */
        .ms-controls { display:flex; align-items:center; justify-content:space-between; gap:12px; padding-top:8px; flex: none; box-sizing:border-box; }
        .ms-footer { display:flex; align-items:center; justify-content:space-between; gap:12px; padding-top:6px; flex:none; box-sizing:border-box; }

        /* dot indicators */
        .ms-dots { display:flex; gap:8px; align-items:center; }
        .ms-dot { width:10px; height:10px; border-radius:50%; background:var(--neu-light); box-shadow: inset 3px 3px 6px rgba(168,179,196,0.4), inset -3px -3px 6px rgba(255,255,255,0.9); opacity:0.6; }
        .ms-dot.active { background:linear-gradient(135deg,var(--brand1),var(--brand2)); opacity:1; }

        /* Buttons */
        .ms-btn { padding:8px 12px; border-radius:12px; border:none; font-weight:700; cursor:pointer; }
        .ms-btn.ghost { background:var(--panel); box-shadow:6px 6px 12px rgba(168,179,196,0.28), -6px -6px 12px rgba(255,255,255,0.9); color:var(--text); }
        .ms-btn.primary { background:linear-gradient(135deg,var(--brand1),var(--brand2)); color:white; box-shadow:0 8px 20px rgba(99,102,241,0.08); }

        .ms-never { display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; }
        .ms-close { background:var(--panel); border-radius:10px; padding:8px 10px; border:none; box-shadow:6px 6px 12px rgba(168,179,196,0.28), -6px -6px 12px rgba(255,255,255,0.9); cursor:pointer; }

        /* small responsive tweaks */
        @media (max-width:880px){
        .ms-card { flex-direction: column; width:100%; height:100vh; border-radius:12px; }
        .ms-left { width:100%; min-height:160px; padding:18px; }
        .ms-left-desc { max-width: 90%; font-size:13px; max-height:140px; }
        .ms-ai-photo { width:96px; height:96px; }
        .ms-feature-grid { grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); }
        }
        @media (max-width:420px){
        .ms-emoji { font-size:28px; }
        .ms-slide-title { font-size:15px; }
        }

        /* ensure box-sizing */
        * { box-sizing: border-box; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ===== GLOBAL / BACKGROUND ===== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: url("/static/images/background_aurex.png") no-repeat center center fixed;
            background-size: cover;
            transition: background-color .25s ease, color .25s ease;
        }

        /* Dark-mode body background fallback */
        body.dark {
            background-color: #0b1220;
            color: #e6eef8;
        }

        .has-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 12.5px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-icon {
            font-size: 14px;
            line-height: 1;
        }

        .has-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .icon-bubble {
            position: absolute;
            font-size: 20px;
            width: 38px;
            height: 38px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.35);
            animation: bubbleFloat 18s ease-in-out infinite;
        }

        .bubble-1 { left: 12%; top: 18%; }
        .bubble-2 { right: 12%; top: 45%; animation-delay: 10s; }
        .bubble-3 { left: 12%; top: 75%;  animation-delay: 20s; }

        @keyframes bubbleFloat {
            0%   { transform: translateY(0); opacity: 0.7; }
            50%  { transform: translateY(-18px); opacity: 1; }
            100% { transform: translateY(0); opacity: 0.7; }
        }

        /* ===== CARD UTAMA (GLASS) ===== */
        .container {
            position: relative;
            z-index: 5;
            width: 100%;
            max-width: 880px;
            background: linear-gradient(145deg,
                        rgba(255, 255, 255, 0.98),
                        rgba(240, 249, 255, 0.96));
            border-radius: 26px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow:
                0 20px 55px rgba(15, 23, 42, 0.4),
                0 0 0 1px rgba(148, 163, 184, 0.18);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 97vh;
            max-height: 700px;
            backdrop-filter: blur(20px);
            transition: background .25s ease, color .25s ease;
        }

        body.dark .container {
            background: linear-gradient(145deg,
                        rgba(10, 14, 20, 0.92),
                        rgba(16, 24, 32, 0.94));
            border: 1px solid rgba(255,255,255,0.04);
            box-shadow: 0 12px 50px rgba(2,6,23,0.75);
        }

        .container::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border-top: 1px solid rgba(255, 255, 255, 0.9);
            pointer-events: none;
        }

        /* Tombol di header: sedikit lebih kecil tapi tetap jelas */
        .header .controls-fab,
        .header .btn-settings {
            padding: 6px 12px;
            font-size: 11px;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.25);
        }

        /* Ikon lingkaran di dalam tombol */
        .header .controls-fab-icon,
        .header .btn-settings .btn-icon {
            width: 18px;
            height: 18px;
            font-size: 11px;
        }

        .header-left { display:flex; align-items:center; gap:10px; }

        .header-icon {
            width: 55px;
            height: 55px;
            border-radius: 999px;
            background-image: url('/static/images/profile.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.40);
            flex-shrink: 0;
        }

        /* ===== HEADER – FINAL LAYOUT ===== */
        .header {
            background: linear-gradient(135deg,
                        #0ea5e9 0%,
                        #4f46e5 45%,
                        #e0f2fe 100%);
            color: #ffffff;
            padding: 12px 22px 10px 22px;   /* tidak terlalu tinggi */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;        /* kiri & kanan rata atas */
        }

        /* kiri tetap seperti yang sudah ada */
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* HEADER – kanan */
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px; /* jarak antara baris tombol dan baris badge */
        }

        /* baris tombol */
        .header-actions {
            display: flex;
            gap: 6px;
        }

        /* baris badge */
        .header-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        /* badge kecil menyatu dengan background header */
        .header-badges .badge-pill {
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 999px;
            background: transparent; /* tidak ada blok fill di belakang */
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: none;
            color: #e5edff;
            opacity: 0.95;
        }

        .header-badges .badge-pill .icon {
            font-size: 11px;
        }

        body.dark .header-badges .badge-pill {
            color: #c7d2fe;
            border-color: rgba(191, 219, 254, 0.45);
        }

        .header-left-text h1 { font-size:20px; font-weight:600; margin-bottom:3px; }
        .header-left-text span { font-size:12px; opacity:0.95; }

        .header-buttons { display:flex; gap:8px; align-items:center; }

        .btn-reset, .btn-clear, .btn-toggle {
            background: rgba(255, 255, 255, 0.18);
            color: #f9fafb;
            border: none;
            padding: 7px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.25s;
        }

        .btn-reset:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .btn-clear:hover { background: rgba(248,113,113,0.55); transform: translateY(-1px); }

        .dark-toggle-on { background: rgba(255,255,255,0.28); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        /* ===== TOP BADGES ===== */
        .top-badges {
            display:flex; gap:10px; padding:6px 26px 12px 26px;
            background: linear-gradient(to right, rgba(239,246,255,0.92), rgba(224,242,254,0.92));
        }
        body.dark .top-badges {
            background: linear-gradient(to right, rgba(8,12,20,0.6), rgba(16,24,32,0.6));
        }

        .badge-pill {
            display:inline-flex; align-items:center; gap:6px; padding:6px 12px;
            border-radius:999px; font-size:11px; color:#1e3a8a; background:#ffffff;
            box-shadow:0 2px 6px rgba(148,163,184,0.45);
        }
        body.dark .badge-pill { background: rgba(255,255,255,0.04); color: #cfe8ff; box-shadow:none; }

        /* ===== FEATURE SECTIONS ===== */
        .feature-sections {
            display:grid; grid-template-columns:1fr 1fr; gap:16px;
            padding:12px 26px 10px 26px; background: rgba(248,250,252,0.96);
            border-bottom:1px solid rgba(226,232,240,0.9);
        }
        body.dark .feature-sections { background: transparent; border-bottom:1px solid rgba(255,255,255,0.04); }

        .section-block { display:flex; flex-direction:column; gap:8px; }
        .section-title { font-size:13px; font-weight:600; color:#1e3a8a; display:flex; align-items:center; gap:6px; }
        body.dark .section-title { color: #cfe8ff; }

        .chip-row { display:flex; flex-wrap:wrap; gap:8px; }
        .chip { padding:7px 14px; border-radius:999px; font-size:12px; border:1px solid #dbeafe; background:#f9fafb; color:#0f172a; box-shadow:0 2px 5px rgba(148,163,184,0.35); cursor:pointer; transition:all 0.2s; }
        .chip:hover { background: #e0f2fe; transform: translateY(-1px); }
        .chip.primary { background:#e0ecff; border-color:#93c5fd; color:#1d4ed8; font-weight:500; }
        body.dark .chip { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.03); color:#cfe8ff; box-shadow:none; }
        body.dark .chip.primary { background: rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.18); color:#cfe8ff; }

        /* ===== CHAT AREA (SCROLL ONLY CHAT) ===== */
        .chat-wrapper { flex:1; display:flex; flex-direction:column; padding:10px 20px 0 20px; background: rgba(248,250,252,0.96); overflow:hidden; }
        body.dark .chat-wrapper { background: linear-gradient(180deg, rgba(6,10,20,0.4), rgba(8,12,20,0.6)); }

        .mode-tabs-wrapper { display:flex; justify-content:center; margin-bottom:8px; }
        .mode-tabs { display:inline-flex; background:#e2e8ff; border-radius:999px; padding:4px; gap:4px; }
        .mode-tab { border:none; padding:6px 14px; border-radius:999px; font-size:12px; cursor:pointer; background:transparent; color:#4a4a6a; transition:all .2s; display:flex; align-items:center; gap:5px; }
        .mode-tab span.icon { font-size:14px; }
        .mode-tab.active { background:#ffffff; color:#2563eb; box-shadow:0 2px 6px rgba(129,140,248,0.6); font-weight:600; }
        body.dark .mode-tabs { background: rgba(255,255,255,0.04); }
        body.dark .mode-tab { color:#cfe8ff; }

        .subchips-row { display:flex; justify-content:center; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
        .subchip { padding:5px 12px; border-radius:999px; font-size:11px; border:1px solid #e2e8f0; background:#ffffff; color:#4b5563; cursor:pointer; }
        body.dark .subchip { background: rgba(255,255,255,0.02); color:#cfe8ff; border-color: rgba(255,255,255,0.03); }

        .chat-container { flex:1; overflow-y:auto; padding:14px 10px; background: linear-gradient(to bottom, #f5f5fb 0%, #e0f2fe 45%, #f9fafb 100%); }
        body.dark .chat-container { background: transparent; }

        /* ===== BUBBLE CHAT ===== */
        .message { margin-bottom:16px; display:flex; animation: slideIn .3s ease-out; }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0); } }

        .message.user { justify-content:flex-end; }
        .message-content { max-width:70%; padding:14px 18px; border-radius:18px; word-wrap:break-word; line-height:1.6; font-size:14px; }
        .message.user .message-content { background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: #f9fafb; border-bottom-right-radius:4px; box-shadow:0 4px 12px rgba(37,99,235,0.55); }
        .message.ai .message-content { background:#ffffff; color:#0f172a; border-bottom-left-radius:4px; box-shadow:0 2px 7px rgba(15,23,42,0.12); }
        body.dark .message.ai .message-content { background: rgba(255,255,255,0.02); color: #dbeafe; box-shadow: none; }

        .message-time { font-size:10px; color:#a0aec0; margin-top:6px; display:block; }
        body.dark .message-time { color: #9fb7e6; }

        .empty-state { text-align:center; color:#a0aec0; padding:30px 20px; }
        body.dark .empty-state { color: #7ea3da; }

        /* =========================================
        BUBBLE CHAT MEWAH – USER & AI
        ========================================= */
        /* spacing antar pesan */
        .chat-container {
            padding: 24px 28px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* wrapper setiap message */
        .message {
            position: relative;
            display: flex;
            /* ➜ PERLEBAR WADAH BUBBLE */
            max-width: 88%;
        }

        /* AI di kiri, user di kanan */
        .message.ai {
            align-self: flex-start;
            padding-left: 44px;           /* ruang avatar AI */
        }

        .message.user {
            align-self: flex-end;
            padding-right: 4px;
        }

        /* BUBBLE DASAR */
        .message .message-content {
            position: relative;
            padding: 14px 18px 18px;
            font-size: 14px;
            line-height: 1.65;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);

            /* ➜ BIAR TEKS MENGALIR NATURAL */
            max-width: 100%;
            word-break: normal;
            white-space: normal;
        }

        /* ➜ BATAS LEBAR SPESIFIK PER BUBBLE */
        .message.ai .message-content {
            max-width: 720px;   /* AI boleh lebih lebar */
            width: auto;
        }

        .message.user .message-content {
            max-width: 560px;   /* user sedikit lebih ramping */
            width: auto;
        }

        /* AI BUBBLE – glassy putih kebiruan */
        .message.ai .message-content {
            background:
                radial-gradient(circle at 0% 0%, rgba(129, 140, 248, 0.16), transparent 55%),
                radial-gradient(circle at 100% 0%, rgba(56, 189, 248, 0.16), transparent 60%),
                #ffffff;
            border-radius: 22px 22px 22px 10px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: #0f172a;
        }

        /* USER BUBBLE – gradient biru ungu */
        .message.user .message-content {
            background: linear-gradient(135deg, #4f46e5, #0ea5e9);
            border-radius: 22px 22px 10px 22px;
            color: #ffffff;
            box-shadow: 0 16px 40px rgba(37, 99, 235, 0.55);
            border: 1px solid rgba(191, 219, 254, 0.25);
        }

        /* waktu pesan: kecil & soft */
        .message-time {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            opacity: 0.6;
        }

        /* di bubble user: waktu di kanan & sedikit lebih terang */
        .message.user .message-time {
            text-align: right;
            color: rgba(241, 245, 249, 0.9);
        }

        /* di bubble AI: waktu di kiri dan warna abu lembut */
        .message.ai .message-time {
            text-align: left;
            color: #9ca3af;
        }

        /* LABEL KECIL DI ATAS BUBBLE (opsional, kalau mau tambah efek premium) */
        .message.ai::before,
        .message.user::before {
            position: absolute;
            top: -18px;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            letter-spacing: 0.02em;
            font-weight: 600;
        }

        /* label “MediSkill AI” */
        .message.ai::before {
            content: "MediSkill AI";
            left: 52px;
            background: rgba(15, 23, 42, 0.04);
            color: #4b5563;
        }

        /* label “Kamu” */
        .message.user::before {
            content: "Kamu";
            right: 8px;
            background: rgba(59, 130, 246, 0.12);
            color: #4b5563;
        }

        /* AVATAR AI BULAT KECIL DI KIRI BUBBLE */
        .message.ai::after {
            content: "";
            position: absolute;
            left: 0;
            top: 6px;
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: url("/static/images/profile.png") center/cover no-repeat;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
        }

        /* BUBBLE USER & AI – sedikit “melayang” saat hover (desktop) */
        @media (hover: hover) {
            .message.user .message-content:hover,
            .message.ai .message-content:hover {
                transform: translateY(-1px);
                box-shadow: 0 20px 48px rgba(15, 23, 42, 0.18);
                transition: all 0.18s ease-out;
            }
        }

        /* ganti blok .empty-state paling bawah dengan ini */
        .empty-state {
            position: absolute;
            inset: 0;                        /* penuh chat-container */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;         /* center vertical & horizontal */
            text-align: center;
            color: #a0aec0;
            padding: 18px 12px;
            font-size: 13px;
            opacity: 0.8;
            pointer-events: none;            /* tidak mengganggu scroll/klick */
        }

        .empty-state svg {
            width: 40px;
            height: 40px;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        @media (max-width: 600px) {
            .empty-state svg {
                width: 36px;
                height: 36px;
            }
            .empty-state {
                padding: 14px 8px;
                font-size: 13px;
            }
        }

        .empty-state-title {
            font-size: 20px;      /* sebelumnya umumnya 18–20px */
            font-weight: 800;    /* dipertebal sedikit biar lebih tegas */
            letter-spacing: 0.5px;
            line-height: 1.3;
            color: #0f172a;      /* tetap gelap & nyaman dibaca */
            margin-bottom: 6px;
        }

        .empty-state-subtitle {
            font-size: 14.5px;   /* naik tipis dari 13–14px */
            line-height: 1.6;
            color: #4b5563;
        }

        .empty-state-hint {
            font-size: 13.5px;   /* sebelumnya kemungkinan 11–12px */
            line-height: 1.6;
        }

        .empty-state-hint span {
            font-weight: 600;   /* biar contoh kalimatnya lebih kebaca */
        }

        body.dark .empty-state-title {
            color: #f9fafb;
        }

        body.dark .empty-state-subtitle {
            color: #9ca3af;
        }

        /* ===== INPUT AREA ===== */
        .input-container { padding:16px 20px 18px 20px; background:#ffffff; border-top:1px solid #e0e0e0; flex-shrink:0; }
        body.dark .input-container { background: rgba(6,10,20,0.6); border-top:1px solid rgba(255,255,255,0.03); }

        .input-form { display:flex; gap:10px; }
        #messageInput { flex:1; padding:11px 16px; border:2px solid #e2e8f0; border-radius:999px; font-size:14px; outline:none; transition:border-color .3s, box-shadow .3s; background:#fff; color:#0b1220; }
        body.dark #messageInput { background: rgba(255,255,255,0.03); color:#dbeafe; border-color: rgba(255,255,255,0.03); }

        #messageInput:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.12); }

        .btn-send { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); color:white; border:none; padding:11px 26px; border-radius:999px; cursor:pointer; font-size:14px; font-weight:600; transition: all .3s; }
        .btn-send:hover:not(:disabled) { transform: translateY(-1px); box-shadow:0 6px 18px rgba(37,99,235,0.55); }
        .btn-send:disabled { opacity:0.6; cursor:not-allowed; }

        /* LOADING DOTS (keperluan) */
        .aurex-dots { display:inline-block; width:46px; text-align:left; vertical-align: middle; margin-left:6px; }
        .aurex-dots span { display:inline-block; width:7px; height:7px; margin:0 2px; border-radius:50%; background:#667eea; opacity:.6; transform:scale(.7); animation:aurex-bounce 1.05s infinite; }
        .aurex-dots span:nth-child(2){ animation-delay:0.12s; }
        .aurex-dots span:nth-child(3){ animation-delay:0.24s; }
        @keyframes aurex-bounce { 0%{ transform:translateY(0) scale(.7); opacity:.5 } 40%{ transform:translateY(-6px) scale(1); opacity:1 } 100%{ transform:translateY(0) scale(.7); opacity:.5 } }

        .error-message { background: #fee2e2; color: #b91c1c; padding:10px 12px; border-radius:8px; margin-bottom:10px; border-left:4px solid #b91c1c; font-size:13px; }
        body.dark .error-message { background: rgba(200,50,50,0.12); color: #ffb4b4; border-left-color: #ff8a8a; }

        /* Scrollbar chat */
        .chat-container::-webkit-scrollbar { width:8px; }
        .chat-container::-webkit-scrollbar-track { background:#f1f59f; }
        .chat-container::-webkit-scrollbar-thumb { background:#cbd5f5; border-radius:4px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background:#a5b4fc; }
        body.dark .chat-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        body.dark .chat-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); }

        .empty-state {
            text-align: center;
            opacity: 0.55;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .empty-state svg {
            width: 42px;
            height: 42px;
            opacity: 0.65;
        }

        /* ===== RESPONSIVE – FULLSCREEN CHAT SEPERTI CHATGPT ===== */
        @media (max-width:600px) {
        
            /* body tanpa padding, supaya kontainer benar2 nempel ke tepi layar */
            body {
                padding: 0;
            }
        
            /* kartu utama jadi fullscreen */
            .container {
                width: 100%;
                max-width: 100%;
                height: 100vh;          /* penuh tinggi layar */
                max-height: none;
                border-radius: 0;       /* hilang efek card */
                box-shadow: none;
                border: none;
            }
        
            /* HEADER melebar full */
            .header {
                padding: 14px 12px;
                border-radius: 0;
            }
        
            .header-left-text h1 {
                font-size: 18px;
            }
        
            /* badges/top section ikut agak mepet kiri-kanan */
            .top-badges-row {
                padding: 8px 12px 6px 12px;
            }
        
            .feature-sections {
                grid-template-columns: 1fr;
                padding: 10px 12px 8px 12px;
                gap: 10px;
            }
        
            /* CHAT WRAPPER & CONTAINER full luas */
            .chat-wrapper {
                padding: 8px 0 0 0;
            }
        
            .chat-container {
                border-radius: 0;
                padding: 14px 12px;
                min-height: auto;
                box-shadow: none;
            }
        
            /* BUBBLE CHAT lebih lebar supaya tidak terlalu tinggi */
            .message {
                max-width: 100%;
            }
        
            .message.ai {
                padding-left: 40px;   /* avatar 32px + sedikit jarak */
            }
        
            .message .message-content {
                max-width: 100%;
                font-size: 13.5px;
                padding: 12px 14px 16px;
            }
        
            /* INPUT AREA full width di bawah, ala chatgpt */
            .input-container {
                padding: 10px 12px 12px 12px;
                border-radius: 0;
            }
        
            .input-form {
                gap: 8px;
            }
        
            #messageInput {
                font-size: 14px;
                padding: 10px 14px;
            }
        
            .btn-send {
                padding: 10px 20px;
                font-size: 14px;
                white-space: nowrap;
                border-radius: 999px;
            }
        }
        
        /* ==========================
        Interface Components CSS
        (Append this after your existing styles)
        ========================== */
        .interface-wrapper {
            margin: 4px 0 14px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            padding: 0 12px;
            /* bikin lebarnya mirip bubble AI */
            max-width: 72%;
        }

        /* di mobile biar tetap pas */
        @media (max-width: 600px) {
            .interface-wrapper {
                max-width: 86%;
                padding: 0 8px;
            }
        }

        /* Tombol quickpanel + tombol panel konteks di bawah AI bubble */
        .global-open-btn-wrap {
            display:flex;
            justify-content:center;
            align-items:center;
            gap:6px;
            padding:8px 0;
            flex-wrap:wrap;
        }

        .global-open-btn {
            padding:6px 12px;
            border-radius:999px;
            border:none;
            cursor:pointer;
            font-weight:600;
            font-size:12px;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color:#ffffff;
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.45);
            display:inline-flex;
            align-items:center;
            gap:6px;
        }

        .global-open-btn::before {
            content:"⚡";
            font-size:13px;
        }

        /* tombol kedua/ketiga di samping: sedikit lebih kalem */
        .global-open-btn-secondary {
            background: #ffffff;
            color:#1e293b;
            box-shadow: 0 2px 6px rgba(148,163,184,0.4);
        }

        .global-open-btn-secondary::before {
            content:"";
        }

        body.dark .global-open-btn {
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }
        body.dark .global-open-btn-secondary {
            background: rgba(15,23,42,0.9);
            color:#e5edff;
        }

        /* Generic small card used by interfaces (keeps consistent with existing .card) */
        .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(248,250,255,0.98));
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,0.06);
        padding: 12px;
        box-shadow: 0 6px 16px rgba(15,23,42,0.06);
        transition: transform .12s ease, box-shadow .12s ease;
        }

        /* Dark-mode adjustments */
        body.dark .interface-wrapper .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border: 1px solid rgba(255,255,255,0.03);
        box-shadow: none;
        }

        /* ==== QUICKPANEL V2 – AUREX STYLE ==== */
        /* Kartu utama QuickPanel (di dalam modal) */
        .card.global-panel {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px 16px 14px 16px;
            border-radius: 22px;
            background: radial-gradient(circle at top left,
                        rgba(224, 242, 254, 0.96) 0%,
                        rgba(239, 246, 255, 0.98) 40%,
                        #ffffff 100%);
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.35),
                0 0 0 1px rgba(255, 255, 255, 0.75);
            overflow: hidden;
        }

        /* highlight garis halus di atas card */
        .card.global-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border-top: 1px solid rgba(255, 255, 255, 0.95);
            pointer-events: none;
        }

        /* DARK MODE */
        body.dark .card.global-panel {
            background: radial-gradient(circle at top left,
                        rgba(15, 23, 42, 0.96) 0%,
                        rgba(15, 23, 42, 0.98) 40%,
                        #020617 100%);
            border-color: rgba(51, 65, 85, 0.9);
            box-shadow:
                0 18px 40px rgba(0, 0, 0, 0.9),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        /* ===== HEADER GREETING ===== */
        .global-panel-header {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 18px;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 60%, #a5b4fc 100%);
            box-shadow: 0 10px 26px rgba(37, 99, 235, 0.7);
            color: #ffffff;
            overflow: hidden;
        }

        /* efek glow lembut di belakang header */
        .global-panel-header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left,
                        rgba(255, 255, 255, 0.4),
                        transparent 55%);
            opacity: 0.9;
            pointer-events: none;
        }

        .greeting-icon {
            position: relative;
            z-index: 1;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.92);
            color: #0f172a;
            font-size: 22px;
            box-shadow:
                0 8px 18px rgba(15, 23, 42, 0.45),
                0 0 0 4px rgba(191, 219, 254, 0.8);
            flex-shrink: 0;
        }

        .global-panel-title,
        .global-panel-subtitle {
            position: relative;
            z-index: 1;
        }

        .global-panel-title {
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .global-panel-subtitle {
            font-size: 12px;
            opacity: 0.95;
        }

        /* DARK */
        body.dark .global-panel-header {
            background: linear-gradient(135deg, #0f679a 0%, #4338ca 55%, #7c3aed 100%);
            box-shadow: 0 16px 38px rgba(15, 23, 42, 0.95);
        }

        body.dark .greeting-icon {
            background: rgba(248, 250, 252, 0.96);
            box-shadow:
                0 8px 18px rgba(0, 0, 0, 0.8),
                0 0 0 4px rgba(129, 140, 248, 0.85);
        }

        /* ===== NOTICE BANNER (jam konsultasi) ===== */
        .notice-banner {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 9px 11px;
            border-radius: 14px;
            background: linear-gradient(120deg, #eef2ff 0%, #e0f2fe 80%);
            font-size: 12px;
            color: #1f2937;
            border: 1px solid rgba(148, 163, 184, 0.6);
            box-shadow: 0 6px 16px rgba(148, 163, 184, 0.35);
        }

        .notice-icon {
            font-size: 16px;
            margin-top: 2px;
        }

        .notice-text strong {
            font-weight: 700;
        }

        /* DARK */
        body.dark .notice-banner {
            background: linear-gradient(120deg,
                        rgba(30, 64, 175, 0.9),
                        rgba(37, 99, 235, 0.85));
            color: #e5edff;
            border-color: rgba(129, 140, 248, 0.6);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
        }

        /* ===== QUICK LINKS ===== */
        .quick-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 4px;
        }

        .ql-btn {
            position: relative;
            background: #ffffff;
            border: 1px solid rgba(148, 163, 184, 0.65);
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(148, 163, 184, 0.6);
            transition:
                transform 0.16s ease,
                box-shadow 0.16s ease,
                background 0.16s ease,
                border-color 0.16s ease;
            white-space: nowrap;
            overflow: hidden;
        }

        .ql-btn span.icon {
            font-size: 15px;
        }

        .ql-btn::after {
            /* accent highlight kecil di sisi kiri */
            content: "";
            position: absolute;
            left: 0;
            top: 40%;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.25), transparent 65%);
            opacity: 0;
            transition: opacity 0.18s ease, transform 0.18s ease;
            transform: translateX(-8px);
        }

        .ql-btn:hover {
            background: linear-gradient(135deg, #eff6ff, #e0f2fe);
            border-color: rgba(59, 130, 246, 0.85);
            box-shadow: 0 7px 18px rgba(59, 130, 246, 0.6);
            transform: translateY(-1px);
        }

        .ql-btn:hover::after {
            opacity: 1;
            transform: translateX(-2px);
        }

        /* DARK */
        body.dark .ql-btn {
            background: rgba(15, 23, 42, 0.98);
            border-color: rgba(148, 163, 184, 0.65);
            color: #e5edff;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.9);
        }

        body.dark .ql-btn:hover {
            background: linear-gradient(135deg,
                        rgba(37, 99, 235, 0.8),
                        rgba(79, 70, 229, 0.9));
            border-color: rgba(191, 219, 254, 0.9);
        }

        /* ===== SEARCH BAR (opsional) ===== */
        .global-search-wrap {
            margin-top: 6px;
            display: flex;
        }

        .global-search {
            width: 100%;
            padding: 9px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.65);
            outline: none;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.96);
            color: #0f172a;
            box-shadow: 0 3px 10px rgba(148, 163, 184, 0.5);
            transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
        }

        .global-search::placeholder {
            color: #94a3b8;
        }

        .global-search:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.28);
            background: #ffffff;
        }

        /* DARK */
        body.dark .global-search {
            border-color: rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.98);
            color: #e5edff;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.85);
        }

        /* ===== TIP CARD ===== */
        .tip-card {
            margin-top: 4px;
            font-size: 13px;
            padding: 10px 11px;
            border-radius: 14px;
            background: radial-gradient(circle at left,
                        #f9fafb 0%,
                        #eef2ff 40%,
                        #e0f2fe 100%);
            border: 1px solid rgba(148, 163, 184, 0.55);
            box-shadow: 0 6px 16px rgba(148, 163, 184, 0.40);
        }

        .tip-card-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #1d4ed8;
        }

        body.dark .tip-card {
            background: radial-gradient(circle at left,
                        rgba(15, 23, 42, 1) 0%,
                        rgba(23, 37, 84, 1) 35%,
                        rgba(17, 24, 39, 1) 100%);
            border-color: rgba(129, 140, 248, 0.85);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
            color: #e5edff;
        }

        body.dark .tip-card-title {
            color: #bfdbfe;
        }

        /* --- Fee & Packages --- */
        .fee-card h4 { margin:0 0 8px 0; font-size:15px; color:#0f172a; }
        
        /* ==== FEE & PACKAGES MODERN CARD ==== */
        .fee-card-modern {
            background: radial-gradient(circle at top left,#e0f2fe 0,#f9fafb 45%,#ffffff 100%);
            border-radius: 16px;
        }

        body.dark .fee-card-modern {
            background: radial-gradient(circle at top left,#020617 0,#020617 40%,#020617 100%);
        }

        .fee-subtitle {
            font-size: 13px;
            color: #4b5563;
            margin: 2px 0 6px 0;
        }
        body.dark .fee-subtitle { color: #9ca3af; }

        .fee-plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(210px,1fr));
            gap: 10px;
            margin-top: 6px;
        }

        /* Kartu tiap paket */
        .fee-plan-card {
            background: #f9fafb;
            border-radius: 14px;
            padding: 12px 12px 10px 12px;
            box-shadow: 0 2px 10px rgba(148,163,184,0.35);
            border: 1px solid rgba(148,163,184,0.3);

            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        body.dark .fee-plan-card {
            background: rgba(15,23,42,0.96);
            border-color: rgba(148,163,184,0.4);
            box-shadow: 0 2px 12px rgba(0,0,0,0.8);
        }

        .fee-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 6px;
        }

        .fee-plan-name {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
        }
        body.dark .fee-plan-name { color: #e5e7eb; }

        .fee-plan-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
            white-space: nowrap;
        }

        /* Harga */
        .fee-price-wrap {
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .fee-plan-price-main {
            font-size: 16px;
            font-weight: 700;
            color: #1d4ed8;
        }
        body.dark .fee-plan-price-main { color: #93c5fd; }

        .fee-plan-price-sub {
            font-size: 12px;
            color: #6b7280;
        }
        body.dark .fee-plan-price-sub { color: #9ca3af; }

        /* Benefit list */
        .fee-includes {
            margin: 2px 0 4px 0;
            padding-left: 18px;
            font-size: 13px;
            color: #374151;
        }
        .fee-includes li {
            margin-bottom: 2px;
        }
        body.dark .fee-includes { color: #d1d5db; }

        .fee-note {
            font-size: 11px;
            color: #6b7280;
        }
        body.dark .fee-note { color: #9ca3af; }

        /* CTA di dalam kartu */
        .fee-plan-cta {
            border: none;
            border-radius: 999px;
            padding: 7px 13px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg,#0ea5e9,#6366f1);
            color: #ffffff;
            box-shadow: 0 3px 10px rgba(37,99,235,0.5);
            transition: transform .15s ease, box-shadow .15s ease;

            align-self: flex-start;
            margin-top: auto;          /* ⬅ dorong tombol ke bawah */
        }

        .fee-plan-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37,99,235,0.7);
        }

        /* small action bar */
        .action-bar { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
        .btn { background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px; }
        .btn:active { transform: translateY(1px); }
        .btn-small { background: transparent; border: 1px solid rgba(15,23,42,0.06); padding:6px 8px; border-radius:6px; cursor:pointer; }
        .btn-close { background:#ef4444; color:white; border:none; padding:7px 12px; border-radius:8px; cursor:pointer; }

        /* --- Facilities Grid (versi rapi) --- */
        .facilities-card h4 {
            margin-bottom: 8px;
        }

        /* grid 2 kolom desktop, 1 kolom mobile */
        .fac-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
        }

        @media (max-width: 720px) {
            .fac-grid {
                grid-template-columns: 1fr;
            }
        }

        /* card fasilitas */
        .fac-item {
            background: linear-gradient(180deg, #ffffff, #fcfdff);
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 2px 10px rgba(148, 163, 184, 0.25);
            padding: 14px 16px 12px 16px;
            display: flex;
            flex-direction: column;
            min-height: 210px;
        }

        /* isi atas card (ikon, judul, deskripsi, benefit, dll) */
        .fac-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* header icon + title */
        .fac-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2px;
        }

        .fac-icon-circle {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            background: #eff6ff;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
            font-size: 18px;
            flex-shrink: 0;
        }

        .fac-title {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
        }

        .fac-tagline {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: #e5e7eb;
            color: #4b5563;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* deskripsi singkat */
        .fac-desc {
            font-size: 13px;
            color: #4b5563;
        }

        /* highlight paket sample */
        .fac-sample {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 10px;
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
        }

        /* list benefit */
        .fac-benefits {
            margin: 2px 0 4px 0;
            padding-left: 18px;
            font-size: 13px;
            color: #374151;
        }

        .fac-benefits li {
            margin-bottom: 2px;
        }

        /* link/detail kecil */
        .fac-detail-link {
            font-size: 12px;
            color: #2563eb;
            text-decoration: underline;
            cursor: pointer;
            align-self: flex-start;
        }

        /* availability text kecil */
        .fac-availability {
            font-size: 11px;
            color: #6b7280;
        }

        /* tombol booking – selalu di paling bawah card */
        .fac-book-btn {
            margin-top: 10px;
            width: 100%;
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #ffffff;
            box-shadow: 0 5px 14px rgba(37, 99, 235, 0.5);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .fac-book-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.7);
        }

        /* dark mode tweak */
        body.dark .fac-item {
            background: rgba(15, 23, 42, 0.96);
            border-color: rgba(148, 163, 184, 0.40);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.8);
        }
        body.dark .fac-title { color: #e5e7eb; }
        body.dark .fac-desc,
        body.dark .fac-benefits { color: #d1d5db; }
        body.dark .fac-sample { background: rgba(37, 99, 235, 0.15); color: #93c5fd; }
        body.dark .fac-tagline { background: rgba(148,163,184,0.2); color: #e5e7eb; }

        /* Upgrade UI fasilitas → mirip kartu paket biaya */
        .facility-subtitle {
            font-size: 13px;
            color: #4b5563;
            margin: 0 0 6px 0;
        }
        body.dark .facility-subtitle {
            color: #9ca3af;
        }

        /* header dalam satu kartu fasilitas */
        .fac-item-header {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .fac-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            background: #e0f2fe;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
            flex-shrink: 0;
            font-size: 18px;
        }
        body.dark .fac-item-icon {
            background: rgba(37,99,235,0.2);
        }

        .fac-item-title {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 2px;
        }
        body.dark .fac-item-title {
            color: #e5e7eb;
        }

        /* chip kecil untuk availability */
        .fac-item-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            color: #1e3a8a;
            background: #e0ecff;
        }
        body.dark .fac-item-tag {
            color: #cfe8ff;
            background: rgba(37,99,235,0.2);
        }

        /* body / deskripsi */
        .fac-item-body {
            margin-top: 6px;
            font-size: 13px;
            color: #475569;
        }
        body.dark .fac-item-body {
            color: #cbd5f5;
        }

        .fac-item-desc {
            margin: 0 0 4px 0;
        }

        /* highlight sample package */
        .fac-item-sample {
            margin-top: 4px;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 12px;
            background: #eef2ff;
            color: #1e3a8a;
            font-weight: 600;
        }
        body.dark .fac-item-sample {
            background: rgba(99,102,241,0.16);
            color: #e5edff;
        }

        /* upcoming events (khusus training) */
        .fac-item-upcoming {
            margin-top: 4px;
            padding-left: 16px;
            font-size: 12px;
            color: #4b5563;
        }
        .fac-item-upcoming li {
            margin-bottom: 2px;
        }
        body.dark .fac-item-upcoming {
            color: #d1d5db;
        }

        /* footer: tombol & info diratakan di bawah */
        .fac-item-footer {
            margin-top: auto;            /* ini yang bikin tombol nempel bawah */
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .fac-item-meta {
            font-size: 11px;
            color: #6b7280;
            max-width: 60%;
        }
        body.dark .fac-item-meta {
            color: #9ca3af;
        }

        .fac-item-btn-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        /* style tombol kecil di kartu fasilitas */
        .fac-detail-btn,
        .fac-action-btn {
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: #ffffff;
            cursor: pointer;
            white-space: nowrap;
        }
        .fac-detail-btn {
            font-weight: 600;
        }
        .fac-detail-btn:hover,
        .fac-action-btn:hover {
            background: #e0f2fe;
        }

        body.dark .fac-detail-btn,
        body.dark .fac-action-btn {
            background: rgba(15,23,42,0.95);
            color: #e5edff;
            border-color: rgba(148,163,184,0.5);
        }

        /* facility sample package */
        .sample-package { margin-top:8px; padding:8px; border-radius:8px; background:#f1f5f9; font-weight:600; font-size:13px; }
        body.dark .sample-package { background: rgba(255,255,255,0.02); color:#cfe8ff; }

        /* --- Location Directory --- */
        .loc-card h4 { margin-bottom:8px; }
        .loc-table { width:100%; border-collapse:collapse; font-size:13px; }
        .loc-table th, .loc-table td { padding:8px 10px; border-bottom:1px solid rgba(15,23,42,0.04); text-align:left; }
        .loc-table th { font-weight:700; font-size:12px; color:#334155; }

        /* events */
        .events { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
        .event-card { padding:10px; border-radius:10px; background: linear-gradient(180deg,#ffffff,#fbfdff); border:1px solid rgba(15,23,42,0.04); }
        .event-card strong { display:block; margin-bottom:6px; }

        /* filter badge (shows active filter info) */
        .filter-badge {
        display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
        background: rgba(99,102,241,0.08); color:#1e3a8a; font-weight:600; font-size:13px;
        border:1px solid rgba(99,102,241,0.12); margin-top:6px;
        }
        body.dark .filter-badge { background: rgba(99,102,241,0.14); color:#dfe9ff; border-color: rgba(99,102,241,0.22); }

        /* json dump fallback styling */
        .json-dump { background:#0f172a0f; padding:8px; border-radius:8px; font-size:12px; overflow:auto; max-height:280px; }
        body.dark .json-dump { background: rgba(255,255,255,0.03); }

        /* modal */
        .modal-overlay { position:fixed; inset:0; background: rgba(2,6,23,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
        .modal { width: min(720px, 94%); background:#fff; border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(2,6,23,0.6); }
        body.dark .modal { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#dbeafe; }

        /* highlights (small) */
        .highlights p { margin:6px 0; font-size:13px; }

        @media (max-width: 880px) {
            .fac-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
            .loc-table th, .loc-table td { padding:6px 8px; font-size:12px; }
            .action-bar { justify-content:flex-start; }
        }

        /* very small screens */
        @media (max-width: 420px) {
        .fac-grid { grid-template-columns: 1fr; }
        .card { padding:10px; border-radius:10px; }
        .filter-badge { font-size:12px; padding:5px 8px; }
        }

        /* Modal content already uses .modal and .modal-overlay in your CSS.
        Pastikan modal mengizinkan scroll (overflow:auto) dan tombol terlihat baik. */

        .modal { 
        max-height: 80vh;
        overflow: auto;
        padding: 14px;
        }

        /* Tombol quickpanel di bawah AI bubble */
        .global-open-btn-wrap {
        display:flex;
        justify-content:center;
        padding:8px 0;
        }
        .global-open-btn {
        padding:8px 14px;
        border-radius:10px;
        border:none;
        cursor:pointer;
        font-weight:600;
        }

        /* jika perlu override kecil agar btn-close matching */
        .btn-close { background:#ef4444; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }

        /* ===== PELATIHAN SOFT SKILLS – PANEL PREMIUM ===== */
        .training-card {
            background: radial-gradient(circle at top left,
                        #e0f2fe 0%,
                        #f9fafb 45%,
                        #ffffff 100%);
            border-radius: 20px;
            padding: 16px 16px 14px 16px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.35),
                0 0 0 1px rgba(255, 255, 255, 0.9);
        }

        .training-card h4 {
            margin-bottom: 2px;
            font-size: 16px;
            color: #0f172a;
        }

        .training-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        body.dark .training-card {
            background: radial-gradient(circle at top left,
                        #020617 0%,
                        #020617 45%,
                        #020617 100%);
            border-color: rgba(51, 65, 85, 0.9);
            box-shadow:
                0 18px 40px rgba(0, 0, 0, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        body.dark .training-card h4 {
            color: #e5e7eb;
        }
        body.dark .training-subtitle {
            color: #9ca3af;
        }

        /* GRID */
        .training-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 12px;
        }

        /* KARTU PROGRAM */
        .training-item {
            position: relative;
            background: linear-gradient(145deg,
                        #ffffff 0%,
                        #f5f7ff 40%,
                        #eff6ff 100%);
            border-radius: 18px;
            padding: 12px 14px 12px 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 6px 16px rgba(148, 163, 184, 0.35);
            display: flex;
            flex-direction: column;
            min-height: 170px;
            overflow: hidden;
            transition:
                transform 0.18s ease,
                box-shadow 0.18s ease,
                border-color 0.18s ease,
                background 0.18s ease;
        }

        /* aksen glow di pojok */
        .training-item::before {
            content: "";
            position: absolute;
            top: -30px;
            right: -40px;
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: radial-gradient(circle,
                        rgba(129, 140, 248, 0.32),
                        transparent 65%);
            opacity: 0.8;
            pointer-events: none;
        }

        .training-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 26px rgba(148, 163, 184, 0.6);
            border-color: rgba(59, 130, 246, 0.75);
        }

        /* DARK */
        body.dark .training-item {
            background: linear-gradient(145deg,
                        #020617 0%,
                        #020617 45%,
                        #020617 100%);
            border-color: rgba(51, 65, 85, 0.9);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.95);
        }
        body.dark .training-item::before {
            background: radial-gradient(circle,
                        rgba(79, 70, 229, 0.55),
                        transparent 65%);
        }

        /* ====== HOVER ELEVATION GLOBAL UNTUK SEMUA KARTU ====== */
        /* state normal */
        .training-item,
        .fee-plan-card,
        .fac-item {
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.35); /* slate-300-ish */
            background: radial-gradient(circle at top left,
                rgba(129, 140, 248, 0.06),
                rgba(15, 23, 42, 0.01)
            );
            box-shadow:
                0 8px 24px rgba(15, 23, 42, 0.10),
                0 0 0 1px rgba(148, 163, 184, 0.15);
            transition:
                transform 0.18s ease,
                box-shadow 0.18s ease,
                border-color 0.18s ease,
                background 0.18s ease,
                translate 0.18s ease;
        }

        /* ======================================================
        GRADASI BIRU–PUTIH UNTUK PANEL BIAYA & FASILITAS
        Disamakan dengan Pelatihan Soft Skills
        ====================================================== */

        /* PANEL BIAYA & PAKET */
        .card.fee-card,
        .card.fee-card-modern {
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 60%);
            border: 1px solid rgba(129, 140, 248, 0.35);
            box-shadow:
                0 12px 28px rgba(15, 23, 42, 0.12),
                inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }

        /* PANEL FASILITAS & LAYANAN */
        .card.facilities-card {
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 60%);
            border: 1px solid rgba(129, 140, 248, 0.35);
            box-shadow:
                0 12px 28px rgba(15, 23, 42, 0.12),
                inset 0 0 0 1px rgba(255, 255, 255, 0.7);
        }

        /* JUDUL PANEL BIAR LEBIH MENONJOL */
        .card.facilities-card > h4,
        .card.fee-card > h4 {
            color: #1e3a8a; /* biru navy */
            font-weight: 700;
        }

        /* SUBTITLE BIAR LEMBUT */
        .facility-subtitle,
        .fee-subtitle {
            color: #475569;
        }

        /* state hover / focus: sedikit terangkat */
        .training-item:hover,
        .training-item:focus-visible,
        .fee-plan-card:hover,
        .fee-plan-card:focus-visible,
        .fac-item:hover,
        .fac-item:focus-visible {
            transform: translateY(-4px);
            box-shadow:
                0 14px 30px rgba(15, 23, 42, 0.18),
                0 0 0 1px rgba(129, 140, 248, 0.50);
            border-color: rgba(129, 140, 248, 0.65);
            background: radial-gradient(circle at top left,
                rgba(129, 140, 248, 0.12),
                rgba(15, 23, 42, 0.02)
            );
        }

        /* sedikit scale halus untuk gambar/icon di dalam kartu (opsional) */
        .training-item:hover .training-icon-badge,
        .fac-item:hover .fac-icon-circle,
        .fee-plan-card:hover .fee-plan-name {
            transform: translateY(-1px);
            transition: transform 0.18s ease;
        }

        /* HEADER DALAM KARTU */
        .training-header-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 4px;
        }

        .training-icon-badge {
            width: 30px;
            height: 30px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            font-size: 18px;
            background: #e0f2fe;
            box-shadow: 0 3px 8px rgba(59, 130, 246, 0.45);
            flex-shrink: 0;
        }

        .training-title {
            font-size: 14px;
            font-weight: 700;
            margin: 0 0 2px 0;
            color: #111827;
        }

        .training-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 11px;
            margin-bottom: 3px;
        }

        /* badge mode dan durasi */
        .training-mode-pill {
            padding: 2px 8px;
            border-radius: 999px;
            background: #e0ecff;
            color: #1e3a8a;
            font-weight: 600;
        }

        .training-duration {
            color: #6b7280;
        }

        body.dark .training-icon-badge {
            background: rgba(37, 99, 235, 0.24);
        }
        body.dark .training-title {
            color: #e5e7eb;
        }
        body.dark .training-duration {
            color: #9ca3af;
        }
        body.dark .training-mode-pill {
            background: rgba(79, 70, 229, 0.3);
            color: #e5edff;
        }

        /* DESKRIPSI SINGKAT */
        .training-desc {
            font-size: 13px;
            color: #4b5563;
            margin: 0 0 4px 0;
        }

        body.dark .training-desc {
            color: #d1d5db;
        }

        /* PREVIEW BENEFIT / MATERI */
        .training-benefits-mini {
            margin: 2px 0 4px 0;
            padding-left: 16px;
            font-size: 12px;
            color: #4b5563;
        }

        .training-benefits-mini li {
            margin-bottom: 2px;
        }

        body.dark .training-benefits-mini {
            color: #cbd5f5;
        }

        /* FOOTER KARTU: harga mini + tombol */
        .training-footer {
            margin-top: auto;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .training-price-tag {
            font-size: 12px;
            color: #1e3a8a;
        }

        .training-price-tag span {
            font-weight: 700;
            color: #1d4ed8;
        }

        body.dark .training-price-tag {
            color: #cfe8ff;
        }
        body.dark .training-price-tag span {
            color: #93c5fd;
        }

        /* Tombol lihat detail */
        .training-detail-btn {
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding: 7px 12px;
            font-size: 12px;
            background: #f9fafb;
            cursor: pointer;
            transition: background 0.15s ease,
                        box-shadow 0.15s ease,
                        transform 0.1s ease,
                        border-color 0.15s ease;
            white-space: nowrap;
        }

        .training-detail-btn:hover {
            background: linear-gradient(135deg, #e0f2fe, #e5edff);
            border-color: #93c5fd;
            box-shadow: 0 4px 10px rgba(129, 140, 248, 0.65);
            transform: translateY(-1px);
        }

        body.dark .training-detail-btn {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(148, 163, 184, 0.5);
            color: #e5e7eb;
        }
        body.dark .training-detail-btn:hover {
            background: linear-gradient(135deg,
                        rgba(59, 130, 246, 0.5),
                        rgba(129, 140, 248, 0.7));
        }

        /* ======================================================
        GRADASI DI LEVEL CARD KECIL
        (Disamakan dengan Training Soft Skills)
        ====================================================== */

        /* ===== CARD DI BIAYA & PAKET ===== */
        .fee-plan-card {
            background: linear-gradient(
                145deg,
                #f8fbff 0%,
                #eef2ff 55%,
                #ffffff 100%
            );
            border: 1px solid rgba(129, 140, 248, 0.35);
            box-shadow:
                0 10px 22px rgba(15, 23, 42, 0.10),
                inset 0 0 0 1px rgba(255, 255, 255, 0.7);
            transition:
                transform 0.18s ease,
                box-shadow 0.18s ease,
                background 0.18s ease;
        }

        /* ===== CARD DI FASILITAS & LAYANAN ===== */
        .fac-item {
            background: linear-gradient(
                145deg,
                #f8fbff 0%,
                #eef2ff 55%,
                #ffffff 100%
            );
            border: 1px solid rgba(129, 140, 248, 0.35);
            box-shadow:
                0 10px 22px rgba(15, 23, 42, 0.10),
                inset 0 0 0 1px rgba(255, 255, 255, 0.7);
            transition:
                transform 0.18s ease,
                box-shadow 0.18s ease,
                background 0.18s ease;
        }

        /* ===== SAAT HOVER: LEBIH HIDUP & TERANG ===== */
        .fee-plan-card:hover,
        .fac-item:hover {
            background: linear-gradient(
                145deg,
                #eef2ff 0%,
                #e0e7ff 55%,
                #ffffff 100%
            );
        }

        /* ======= DETAIL PELATIHAN (Lihat Detail) ======= */
        .training-detail-modal {
            background: linear-gradient(145deg, #ffffff, #f3f4ff);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 18px 50px rgba(15,23,42,0.35);
            width: min(760px, 96%);
        }

        body.dark .training-detail-modal {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
            color: #e5e7eb;
        }

        .td-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 14px;
        }

        .td-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: #e0f2fe;
            font-size: 22px;
            box-shadow: 0 4px 10px rgba(59,130,246,0.35);
            flex-shrink: 0;
        }

        body.dark .td-icon {
            background: rgba(37,99,235,0.2);
        }

        .td-header-text {
            flex: 1;
        }

        .td-title {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        body.dark .td-title { color: #e5e7eb; }

        .td-subtitle {
            margin: 0;
            font-size: 13px;
            color: #4b5563;
        }

        body.dark .td-subtitle { color: #9ca3af; }

        .td-section-title {
            margin-top: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 700;
            color: #111827;
        }

        body.dark .td-section-title { color: #e5e7eb; }

        /* Kartu program individual */
        .tp-card {
            background: #f9fafb;
            border-radius: 14px;
            padding: 12px 14px 10px 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(148,163,184,0.35);
            border: 1px solid rgba(148,163,184,0.3);
        }

        body.dark .tp-card {
            background: rgba(15,23,42,0.95);
            border-color: rgba(148,163,184,0.35);
            box-shadow: 0 2px 12px rgba(0,0,0,0.8);
        }

        .tp-top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }

        .tp-name {
            font-size: 15px;
            font-weight: 700;
            color: #111827;
        }

        body.dark .tp-name { color: #e5e7eb; }

        .tp-meta {
            font-size: 12px;
            color: #4b5563;
            margin-top: 2px;
        }

        body.dark .tp-meta { color: #9ca3af; }

        .tp-mode-pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            align-self: flex-start;
        }

        /* warna badge mode */
        .tp-badge-online {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .tp-badge-offline {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #facc15;
        }

        .tp-badge-neutral {
            background: #e5e7eb;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        /* list materi / include */
        .tp-includes {
            margin: 4px 0 8px 0;
            padding-left: 18px;
            font-size: 13px;
            color: #374151;
        }

        .tp-includes li {
            margin-bottom: 2px;
        }

        body.dark .tp-includes { color: #d1d5db; }

        .tp-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .tp-price-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tp-price-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: #6b7280;
        }

        .tp-price {
            font-size: 16px;
            font-weight: 700;
            color: #1d4ed8;
        }

        body.dark .tp-price {
            color: #93c5fd;
        }

        .tp-cta-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(37,99,235,0.5);
            white-space: nowrap;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .tp-cta-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 7px 18px rgba(37,99,235,0.65);
        }

        /* tombol tutup modal detail pelatihan */
        .td-close {
            margin-top: 10px;
        }

        /* --- Training Form Modal (Premium) --- */
        .training-form-modal {
            background: linear-gradient(150deg, #ffffff, #f0f7ff);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(15,23,42,0.25);
            width: min(480px, 92%);
        }

        body.dark .training-form-modal {
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            color: #e2e8f0;
        }

        /* ===== FORM BELI PAKET (FEE) ===== */
        .fee-form-modal {
            max-width: 520px;
            width: 96%;
            background: linear-gradient(150deg, #ffffff, #f1f5ff);
            border-radius: 18px;
            padding: 18px 18px 16px 18px;
            box-shadow: 0 22px 60px rgba(15, 23, 42, 0.35);
        }
        body.dark .fee-form-modal {
            background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,1));
            color: #e5e7eb;
        }

        /* ====== MODAL RINGKASAN CEK ASURANSI ====== */
        /* Badan modal-nya */
        .modal.fee-form-modal {
            max-width: 520px;
            width: 100%;
            border-radius: 18px;
            padding: 18px 20px 16px;
            background: #ffffff;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            color: #111827;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        /* Header hijau dengan icon centang */
        .fee-form-modal .fee-form-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 14px;
            background: linear-gradient(135deg, #ecfdf3, #dcfce7);
            border: 1px solid #bbf7d0;
            margin-bottom: 16px;
        }

        .fee-form-modal .fee-form-icon {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #16a34a;
            color: #ffffff;
            font-size: 18px;
            flex-shrink: 0;
        }

        .fee-form-modal .fee-form-title {
            font-size: 16px;
            font-weight: 700;
            color: #14532d;
            margin: 0 0 4px;
        }

        .fee-form-modal .fee-form-subtitle {
            font-size: 13px;
            line-height: 1.5;
            color: #374151;
            margin: 0;
        }

        /* BOX ringkasan data */
        .insurance-summary-box {
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-top: 14px;
            margin-bottom: 14px;
        }

        .insurance-summary-title {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .insurance-summary-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
        }

        .insurance-summary-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .insurance-summary-row span:first-child {
            color: #6b7280;
            white-space: nowrap;
        }

        .insurance-summary-row span:last-child {
            color: #111827;
            font-weight: 500;
            text-align: right;
            flex: 1;
        }

        /* Bagian edukasi */
        .insurance-edu-section {
            border-radius: 14px;
            border: 1px dashed #d1d5db;
            background: #f9fafb;
            padding: 10px 12px 12px;
            margin-bottom: 10px;
        }

        .insurance-edu-title {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 6px;
        }

        .insurance-edu-list {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            color: #4b5563;
        }

        .insurance-edu-list li {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        /* Footer & tombol */
        .fee-form-modal .fee-form-footer {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .fee-form-modal .fee-form-note {
            font-size: 12px;
            line-height: 1.6;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .fee-form-modal .fee-form-actions {
            display: flex;
            justify-content: flex-end;
        }

        .fee-form-modal .insurance-summary-close {
            border: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 600;
            background: #ef4444;
            color: #ffffff;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.35);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
        }

        .fee-form-modal .insurance-summary-close:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(239, 68, 68, 0.4);
        }

        .fee-form-modal .insurance-summary-close:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.35);
        }

        /* ====== BOOKING FASILITAS – STYLE MIRIP PEMBELIAN PAKET ====== */
        .modal.purchase-modal {
            max-width: 520px;
            width: 96%;
            background: linear-gradient(150deg, #ffffff, #f1f5ff);
            border-radius: 18px;
            padding: 18px 18px 16px 18px;
            box-shadow: 0 22px 60px rgba(15, 23, 42, 0.35);
        }

        body.dark .modal.purchase-modal {
            background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,1));
            color: #e5e7eb;
        }

        /* HEADER ATAS (ikon + judul) */
        .pay-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .pay-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pay-header-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: #dbeafe;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(59,130,246,0.3);
        }

        body.dark .pay-header-icon {
            background: rgba(37,99,235,0.3);
        }

        .pay-header-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
        }

        body.dark .pay-header-title {
            color: #dbeafe;
        }

        .pay-header-sub {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        body.dark .pay-header-sub {
            color: #9ca3af;
        }

        /* KARTU RINGKASAN LAYANAN */
        .pay-summary {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: stretch;
            padding: 10px 12px;
            border-radius: 14px;
            background: #eef2ff;
            margin-bottom: 14px;
        }

        body.dark .pay-summary {
            background: rgba(37,99,235,0.18);
        }

        .pay-summary-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pay-summary-service {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
        }

        body.dark .pay-summary-service {
            color: #e5e7eb;
        }

        .pay-summary-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 11px;
        }

        .pay-summary-meta .meta-pill {
            padding: 3px 8px;
            border-radius: 999px;
            background: #e5e7eb;
            color: #374151;
        }

        .pay-summary-meta .meta-soft {
            background: #e0f2fe;
            color: #1e3a8a;
        }

        body.dark .pay-summary-meta .meta-pill,
        body.dark .pay-summary-meta .meta-soft {
            background: rgba(148,163,184,0.25);
            color: #e5e7eb;
        }

        .pay-summary-price-hint {
            font-size: 12px;
            color: #4b5563;
        }

        body.dark .pay-summary-price-hint {
            color: #cbd5f5;
        }

        .pay-summary-side {
            text-align: right;
            font-size: 11px;
            min-width: 120px;
        }

        .pay-summary-side-label {
            color: #6b7280;
            margin-bottom: 2px;
        }

        .pay-summary-side-value {
            font-weight: 700;
            color: #1e3a8a;
        }

        body.dark .pay-summary-side-value {
            color: #bfdbfe;
        }

        /* FORM BOOKING */
        .pay-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pay-grid-2 {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 640px) {
            .pay-grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .pay-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pay-field label {
            font-size: 12px;
            font-weight: 600;
            color: #1e3a8a;
        }

        body.dark .pay-field label {
            color: #cfe8ff;
        }

        .pay-field input,
        .pay-field textarea {
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            padding: 9px 10px;
            font-size: 13px;
            outline: none;
            background: #ffffff;
        }

        body.dark .pay-field input,
        body.dark .pay-field textarea {
            background: rgba(255,255,255,0.03);
            border-color: rgba(148,163,184,0.45);
            color: #e5e7eb;
        }

        .pay-field input:focus,
        .pay-field textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }

        .pay-field textarea {
            min-height: 70px;
            resize: vertical;
        }

        .pay-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        body.dark .pay-note {
            color: #9ca3af;
        }

        /* TOMBOL AKSI BAWAH */
        .pay-actions {
            margin-top: 6px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .pay-actions .btn-primary,
        .pay-actions .btn-secondary {
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 700;
            border: none;
            cursor: pointer;
        }

        .pay-actions .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: white;
            box-shadow: 0 7px 18px rgba(37,99,235,0.6);
        }

        .pay-actions .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(37,99,235,0.75);
        }

        .pay-actions .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }

        body.dark .pay-actions .btn-secondary {
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
        }

        .fee-form-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .fee-form-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: #dbeafe;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(59,130,246,0.3);
        }
        body.dark .fee-form-icon {
            background: rgba(37,99,235,0.3);
        }
        .fee-form-title {
            margin: 0 0 2px 0;
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
        }
        body.dark .fee-form-title {
            color: #dbeafe;
        }
        .fee-form-subtitle {
            margin: 0;
            font-size: 12px;
            color: #6b7280;
        }
        body.dark .fee-form-subtitle {
            color: #9ca3af;
        }

        /* ringkasan paket */
        .fee-form-summary {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            padding: 10px 12px;
            border-radius: 14px;
            background: #eff6ff;
            margin-bottom: 14px;
        }
        body.dark .fee-form-summary {
            background: rgba(37,99,235,0.18);
        }
        .fee-form-summary-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }
        body.dark .fee-form-summary-title {
            color: #e5e7eb;
        }
        .fee-form-summary-meta {
            margin-top: 4px;
            font-size: 11px;
            color: #4b5563;
            display: flex;
            flex-wrap: wrap;
            gap: 4px 10px;
        }
        body.dark .fee-form-summary-meta {
            color: #cbd5f5;
        }
        .fee-form-summary-price {
            text-align: right;
            font-size: 12px;
            color: #6b7280;
        }
        .fee-form-summary-price strong {
            display: block;
            font-size: 18px;
            color: #1d4ed8;
        }
        body.dark .fee-form-summary-price strong {
            color: #93c5fd;
        }

        /* form fields */
        .fee-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .fee-form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .fee-form-field label {
            font-size: 12px;
            font-weight: 600;
            color: #1e3a8a;
        }
        body.dark .fee-form-field label {
            color: #cfe8ff;
        }
        .fee-form-field input,
        .fee-form-field textarea {
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            padding: 9px 10px;
            font-size: 13px;
            outline: none;
            background: #ffffff;
        }
        body.dark .fee-form-field input,
        body.dark .fee-form-field textarea {
            background: rgba(255,255,255,0.03);
            border-color: rgba(148,163,184,0.45);
            color: #e5e7eb;
        }
        .fee-form-field input:focus,
        .fee-form-field textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }
        .fee-form-field textarea {
            min-height: 64px;
            resize: vertical;
        }

        .fee-form-row {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 640px) {
            .fee-form-row {
                grid-template-columns: 1fr;
            }
        }

        /* footer & tombol */
        .fee-form-footer {
            margin-top: 4px;
            padding-top: 8px;
            border-top: 1px solid rgba(226,232,240,0.9);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        body.dark .fee-form-footer {
            border-top-color: rgba(51,65,85,1);
        }
        .fee-form-note {
            font-size: 11px;
            color: #6b7280;
        }
        body.dark .fee-form-note {
            color: #9ca3af;
        }
        .fee-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .fee-form-submit {
            border: none;
            border-radius: 999px;
            padding: 9px 18px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: white;
            box-shadow: 0 7px 18px rgba(37,99,235,0.6);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .fee-form-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(37,99,235,0.75);
        }

        /* toast sukses */
        .fee-toast {
            position: fixed;
            left: 50%;
            bottom: 22px;
            transform: translateX(-50%);
            background: #16a34a;
            color: #ecfdf5;
            padding: 10px 16px;
            border-radius: 999px;
            font-size: 13px;
            box-shadow: 0 10px 26px rgba(22,163,74,0.7);
            z-index: 9999;
            max-width: 90%;
            text-align: center;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .fee-toast.hide {
            opacity: 0;
            transform: translateX(-50%) translateY(10px);
        }
        body.dark .fee-toast {
            background: #22c55e;
            color: #052e16;
        }

        .purchase-summary-box {
            background: #eef2ff;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .purchase-service-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .purchase-service-meta {
            font-size: 11px;
            color: #6b7280;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .purchase-price-row {
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        .purchase-price-main {
            font-weight: 700;
        }

        .review-header h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
        }
        .review-header p {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #6b7280;
        }
        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        .review-block {
            background: #f9fafb;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(148,163,184,0.3);
        }
        .review-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .review-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 2px;
        }
        .review-row span:first-child {
            color: #6b7280;
        }
        .review-total-box {
            background: #eef2ff;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .review-total-label {
            font-size: 12px;
            color: #4b5563;
        }
        .review-total-amount {
            font-size: 18px;
            font-weight: 700;
        }
        .review-total-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .review-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ===== Payment Receipt – Detail & Layout ===== */
        .payment-receipt-modal {
            max-width: 520px;
            border-radius: 20px;
        }

        .receipt-body {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .receipt-highlight {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 12px;
            background: linear-gradient(90deg, #e0f2fe, #eef2ff);
        }

        .receipt-highlight-method {
            font-size: 13px;
            font-weight: 600;
            color: #1d4ed8;
        }

        .receipt-highlight-amount {
            font-size: 18px;
            font-weight: 800;
            color: #1e3a8a;
        }

        .receipt-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(148,163,184,0.3);
        }

        .receipt-section-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #111827;
        }

        .receipt-detail-grid {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .receipt-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .receipt-detail-row span:first-child {
            color: #6b7280;
        }

        .receipt-detail-total {
            font-weight: 700;
            color: #1e3a8a;
        }

        .receipt-status-chip {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #facc15;
        }

        .receipt-instruction {
            font-size: 12px;
            color: #4b5563;
        }
        .receipt-instruction ol {
            margin: 6px 0 4px 18px;
            padding: 0;
        }
        .receipt-instruction li {
            margin-bottom: 3px;
        }

        .receipt-footer-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .receipt-download-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #e0f2fe;
            color: #1d4ed8;
        }

        .receipt-download-btn:hover {
            background: #bfdbfe;
        }

        .receipt-close-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #ef4444;
            color: white;
        }

        /* Toast notifikasi download */
        .receipt-toast {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(15,23,42,0.95);
            color: #e5e7eb;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(15,23,42,0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 10000;
        }

        .receipt-toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ====== PAYMENT RECEIPT MODAL ====== */
        .payment-receipt-modal {
            max-width: 620px;
            background: linear-gradient(145deg, #ffffff, #f3f4ff);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 18px 50px rgba(15,23,42,0.35);
        }
        body.dark .payment-receipt-modal {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
            color: #e5e7eb;
        }

        .receipt-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        .receipt-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: #dbeafe;
            box-shadow: 0 3px 10px rgba(59,130,246,0.4);
            font-size: 24px;
        }
        body.dark .receipt-icon {
            background: rgba(37,99,235,0.3);
        }
        .receipt-title {
            margin: 0 0 3px 0;
            font-size: 18px;
            font-weight: 700;
        }
        .receipt-subtitle {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
        }
        body.dark .receipt-subtitle {
            color: #9ca3af;
        }

        .receipt-highlight {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: radial-gradient(circle at left, #e0f2fe 0, #eef2ff 35%, #ffffff 100%);
        }
        body.dark .receipt-highlight {
            background: radial-gradient(circle at left, #020617 0, #020617 40%, #020617 100%);
        }
        .receipt-highlight-title {
            font-size: 13px;
            font-weight: 600;
            color: #1d4ed8;
        }
        body.dark .receipt-highlight-title {
            color: #bfdbfe;
        }
        .receipt-highlight-amount {
            font-size: 18px;
            font-weight: 700;
            color: #1d4ed8;
        }
        body.dark .receipt-highlight-amount {
            color: #93c5fd;
        }

        .receipt-main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .receipt-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(148,163,184,0.3);
        }
        body.dark .receipt-section {
            background: rgba(15,23,42,0.95);
            border-color: rgba(148,163,184,0.4);
        }
        .receipt-section-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 2px;
        }
        .receipt-row span:first-child {
            color: #6b7280;
        }
        body.dark .receipt-row span:first-child {
            color: #9ca3af;
        }

        .receipt-steps {
            padding-left: 18px;
            margin: 4px 0 4px 0;
            font-size: 12px;
        }
        .receipt-steps li {
            margin-bottom: 2px;
        }

        .receipt-method-info ul {
            padding-left: 18px;
            margin: 4px 0 4px 0;
            font-size: 12px;
        }
        .receipt-method-info li {
            margin-bottom: 2px;
        }
        .receipt-va-box {
            margin: 4px 0 6px;
            padding: 8px 10px;
            border-radius: 10px;
            background: #eef2ff;
        }
        body.dark .receipt-va-box {
            background: rgba(37,99,235,0.25);
        }
        .receipt-va-bank {
            font-size: 11px;
            color: #374151;
        }
        body.dark .receipt-va-bank {
            color: #e5e7eb;
        }
        .receipt-va-number {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .receipt-small-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        body.dark .receipt-small-note {
            color: #9ca3af;
        }

        .receipt-footer {
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
        }
        .receipt-footer-text {
            font-size: 11px;
            color: #6b7280;
        }
        body.dark .receipt-footer-text {
            color: #9ca3af;
        }
        .receipt-footer-actions {
            display: flex;
            gap: 6px;
        }
        .receipt-close-btn {
            padding: 8px 14px;
        }

        /* ===== MANFAAT ASURANSI (DI DALAM MODAL CEK ASURANSI) ===== */
        .insurance-benefits-box {
            margin-top: 6px;
            margin-bottom: 8px;
            padding: 10px 10px;
            border-radius: 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }
        body.dark .insurance-benefits-box {
            background: rgba(15,23,42,0.9);
            border-color: rgba(148,163,184,0.4);
        }

        .insurance-benefits-placeholder {
            font-size: 12px;
            color: #6b7280;
        }
        body.dark .insurance-benefits-placeholder {
            color: #9ca3af;
        }

        .insurance-benefits-header {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 6px;
        }
        .insurance-benefits-header strong {
            font-size: 13px;
            color: #111827;
        }
        .insurance-benefits-header span {
            font-size: 11px;
            color: #6b7280;
        }
        body.dark .insurance-benefits-header strong {
            color: #e5e7eb;
        }
        body.dark .insurance-benefits-header span {
            color: #9ca3af;
        }

        .insurance-benefits-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .insurance-benefits-table th,
        .insurance-benefits-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }
        .insurance-benefits-table th {
            text-align: left;
            font-weight: 600;
            color: #1f2937;
        }
        .insurance-benefits-table td {
            color: #4b5563;
        }
        body.dark .insurance-benefits-table th {
            color: #e5e7eb;
            border-bottom-color: rgba(148,163,184,0.4);
        }
        body.dark .insurance-benefits-table td {
            color: #cbd5f5;
            border-bottom-color: rgba(148,163,184,0.2);
        }

        /* ===========================================
        PEMBELIAN PAKET LAYANAN – MODAL & HEADER
        =========================================== */

        .modal.fee-purchase-modal {
            max-width: 560px;
            width: 96%;
            background: linear-gradient(150deg, #ffffff, #f1f5ff);
            border-radius: 18px;
            padding: 18px 18px 16px 18px;
            box-shadow: 0 22px 60px rgba(15, 23, 42, 0.35);
        }

        body.dark .modal.fee-purchase-modal {
            background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,1));
            color: #e5e7eb;
        }

        .tf-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .tf-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            background: #dbeafe;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(59,130,246,0.3);
        }

        body.dark .tf-icon {
            background: rgba(37,99,235,0.3);
        }

        .tf-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
            margin: 0 0 2px 0;
        }

        .tf-subtitle {
            font-size: 12px;
            color: #6b7280;
        }

        .tf-subtitle span {
            font-weight: 600;
            color: #111827;
        }

        body.dark .tf-title {
            color: #dbeafe;
        }

        body.dark .tf-subtitle {
            color: #9ca3af;
        }

        /* ===========================================
        RINGKASAN PAKET (atas form)
        =========================================== */

        .purchase-summary-box {
            padding: 10px 12px;
            border-radius: 14px;
            background: #eef2ff;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        body.dark .purchase-summary-box {
            background: rgba(37,99,235,0.18);
        }

        .purchase-service-name {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
        }

        body.dark .purchase-service-name {
            color: #e5e7eb;
        }

        .purchase-service-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 11px;
            color: #6b7280;
        }

        .purchase-service-meta span {
            padding: 2px 8px;
            border-radius: 999px;
            background: #e5e7eb;
        }

        body.dark .purchase-service-meta {
            color: #9ca3af;
        }

        body.dark .purchase-service-meta span {
            background: rgba(148,163,184,0.25);
            color: #e5e7eb;
        }

        .purchase-price-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-top: 4px;
            font-size: 12px;
        }

        .purchase-price-main {
            font-size: 15px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .purchase-price-sub {
            font-size: 11px;
            color: #6b7280;
        }

        /* ===========================================
        FORM STEP 1
        =========================================== */

        .tf-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 4px;
        }

        .tf-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tf-field label {
            font-size: 12px;
            font-weight: 600;
            color: #1e3a8a;
        }

        body.dark .tf-field label {
            color: #cfe8ff;
        }

        .tf-field input,
        .tf-field textarea,
        .tf-field select {
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            padding: 9px 10px;
            font-size: 13px;
            outline: none;
            background: #ffffff;
        }

        body.dark .tf-field input,
        body.dark .tf-field textarea,
        body.dark .tf-field select {
            background: rgba(255,255,255,0.03);
            border-color: rgba(148,163,184,0.45);
            color: #e5e7eb;
        }

        .tf-field input:focus,
        .tf-field textarea:focus,
        .tf-field select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
        }

        .tf-field textarea {
            min-height: 70px;
            resize: vertical;
        }

        /* METODE PEMBAYARAN */

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .payment-option {
            display: flex;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            cursor: pointer;
        }

        .payment-option input[type="radio"] {
            margin-top: 2px;
        }

        .payment-option-main {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
        }

        .payment-option-sub {
            font-size: 11px;
            color: #6b7280;
        }

        .payment-ewallet-extra {
            margin-top: 6px;
            padding: 6px 8px;
            border-radius: 10px;
            background: #eef2ff;
            font-size: 11px;
        }

        .payment-ewallet-label {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .payment-ewallet-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 12px;
            font-size: 11px;
        }

        .payment-ewallet-list label {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .payment-ewallet-extra.payment-ewallet-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* KODE DISKON + TOTAL */

        .discount-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .tf-price-box {
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 14px;
            background: #eef2ff;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tf-price {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .tf-price-note {
            font-size: 11px;
            color: #6b7280;
        }

        /* TOMBOL STEP 1 */

        .tf-submit-btn {
            margin-top: 8px;
            width: 100%;
            border-radius: 999px;
            padding: 9px 16px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #ffffff;
            box-shadow: 0 8px 22px rgba(37,99,235,0.6);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .tf-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 28px rgba(37,99,235,0.75);
        }

        /* ===========================================
        STEP INDICATOR + REVIEW (STEP 2)
        =========================================== */

        #step2-wrapper {
            margin-top: 4px;
        }

        /* indikator 2 langkah – boleh taruh di atas step1 & step2 jika mau
        (opsional, tapi kelihatan cakep) */
        .review-header {
            margin-bottom: 10px;
            position: relative;
            padding-bottom: 6px;
        }

        .review-header h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 2px 0;
            color: #1e3a8a;
        }

        .review-header p {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        /* grid dua kolom */
        .review-grid {
            display: grid;
            grid-template-columns: 1.1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 640px) {
            .review-grid {
                grid-template-columns: 1fr;
            }
        }

        .review-block {
            border-radius: 14px;
            background: #f9fafb;
            padding: 10px 12px;
        }

        body.dark .review-block {
            background: rgba(15,23,42,0.8);
        }

        .review-title {
            font-size: 12px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }

        body.dark .review-title {
            color: #e5e7eb;
        }

        .review-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .review-row span:first-child {
            color: #6b7280;
        }

        .review-row span:last-child {
            font-weight: 500;
        }

        /* total box */

        .review-total-box {
            border-radius: 14px;
            background: #eef2ff;
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .review-total-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .review-total-amount {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 4px;
        }

        .review-total-note {
            font-size: 11px;
            color: #6b7280;
        }

        /* tombol bawah step 2 */

        .review-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .review-actions .btn-close,
        .review-actions .tf-submit-btn {
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 700;
            border: none;
            cursor: pointer;
        }

        .review-actions .btn-close {
            background: #e5e7eb;
            color: #111827;
        }

        body.dark .review-actions .btn-close {
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
        }

        .tf-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .tf-icon {
            width: 48px;
            height: 48px;
            display: grid;
            place-items: center;
            background: #dbeafe;
            border-radius: 12px;
            font-size: 24px;
            box-shadow: 0 3px 8px rgba(15,23,42,0.15);
        }

        body.dark .tf-icon {
            background: rgba(255,255,255,0.08);
        }

        .tf-title {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
        }

        body.dark .tf-title {
            color: #dbeafe;
        }

        .tf-subtitle {
            font-size: 13px;
            opacity: 0.8;
        }

        .tf-subtitle span {
            background: #2563eb;
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 11px;
        }

        .tf-form {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .tf-field {
            display: flex;
            flex-direction: column;
        }

        .tf-field label {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            color: #1e3a8a;
        }

        body.dark .tf-field label {
            color: #cfe8ff;
        }

        .tf-field input,
        .tf-field textarea {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #cbd5e1;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
            background: #ffffff;
        }

        body.dark .tf-field input,
        body.dark .tf-field textarea {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.08);
            color: #dbeafe;
        }

        .tf-field input:focus,
        .tf-field textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
        }

        .tf-price-box {
            background: #eef2ff;
            padding: 14px;
            border-radius: 12px;
            margin-top: 4px;
            box-shadow: 0 2px 8px rgba(59,130,246,0.15);
        }

        body.dark .tf-price-box {
            background: rgba(99,102,241,0.1);
        }

        .tf-price {
            font-size: 20px;
            font-weight: 700;
            margin-top: 4px;
            color: #1e40af;
        }

        body.dark .tf-price {
            color: #cfe8ff;
        }

        .tf-price-note {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
        }

        .tf-submit-btn {
            margin-top: 8px;
            padding: 12px;
            width: 100%;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: white;
            box-shadow: 0 8px 20px rgba(59,130,246,0.4);
            transition: 0.2s;
        }

        .tf-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 26px rgba(59,130,246,0.55);
        }

        .booking-benefits {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(129, 140, 248, 0.06);
            border: 1px solid rgba(129, 140, 248, 0.25);
        }

        .booking-benefits-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 8px;
            color: #111827;
        }

        body.dark .booking-benefits {
            background: rgba(55, 65, 81, 0.9);
            border-color: rgba(129, 140, 248, 0.5);
        }

        .booking-benefits-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .booking-benefits-table th,
        .booking-benefits-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.4);
            vertical-align: top;
        }

        .booking-benefits-table th {
            text-align: left;
            font-weight: 600;
            color: #4b5563;
        }

        body.dark .booking-benefits-table th {
            color: #e5e7eb;
        }

        .booking-benefits-table tr:last-child td {
            border-bottom: none;
        }

        .form-helper {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* ===== TOOLTIP MINI (ICON ❓) ===== */
        .tooltip-label {
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2563eb;
            color: #ffffff;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        /* Tooltip bubble */
        .tooltip-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: #ffffff;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
            width: 220px;
            max-width: 260px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease, transform 0.15s ease;
            z-index: 50;
            text-align: left;
        }

        /* Arrow kecil */
        .tooltip-icon::before {
            content: "";
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px;
            border-style: solid;
            border-color: #111827 transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s ease;
        }

        /* Hover desktop */
        .tooltip-icon:hover::after,
        .tooltip-icon:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Mode aktif untuk mobile (via JS) */
        .tooltip-icon.active::after,
        .tooltip-icon.active::before {
            opacity: 1;
            visibility: visible;
        }

        /* ====== RINGKASAN PAKET DI FORM FEE ====== */
        .fee-form-summary {
            margin-top: 6px;
            margin-bottom: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: #eef2ff;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: flex-start;
            box-shadow: 0 2px 8px rgba(129,140,248,0.35);
        }
        body.dark .fee-form-summary {
            background: rgba(15,23,42,0.9);
            box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        .fee-form-summary-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .fee-form-summary-title {
            font-weight: 700;
            font-size: 14px;
        }
        .fee-form-summary-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 11px;
        }
        .fee-form-summary-meta span {
            padding: 2px 6px;
            border-radius: 999px;
            background: #e5e7eb;
            color: #374151;
        }
        body.dark .fee-form-summary-meta span {
            background: rgba(148,163,184,0.25);
            color: #e5e7eb;
        }

        .fee-form-summary-price {
            text-align: right;
            font-size: 12px;
        }
        .fee-form-summary-price span {
            display: block;
            color: #6b7280;
        }
        .fee-form-summary-price strong {
            font-size: 16px;
            color: #1d4ed8;
        }
        body.dark .fee-form-summary-price strong {
            color: #93c5fd;
        }

        /* ====== METODE PEMBAYARAN ====== */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .payment-ewallet-extra {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #e5e7eb;
            font-size: 11px;
        }
        .payment-ewallet-label {
            display: block;
            margin-bottom: 4px;
            color: #6b7280;
        }
        .payment-ewallet-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .payment-ewallet-list label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }
        body.dark .payment-ewallet-extra {
            border-top-color: rgba(148,163,184,0.5);
        }
        body.dark .payment-ewallet-list label {
            background: rgba(15,23,42,0.9);
            border-color: rgba(148,163,184,0.5);
        }

        .payment-option {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            cursor: pointer;
        }
        .payment-option input {
            margin-top: 4px;
        }
        .payment-option-main {
            font-size: 13px;
            font-weight: 600;
        }
        .payment-option-sub {
            font-size: 11px;
            color: #6b7280;
        }
        .payment-option-disabled {
            opacity: 0.6;
            cursor: default;
        }
        body.dark .payment-option {
            background: rgba(15,23,42,0.95);
            border-color: rgba(148,163,184,0.5);
        }

        .payment-ewallet-extra.payment-extra-disabled,
        .payment-va-extra.payment-extra-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .pay-info-block {
            margin-top: 16px;
            padding: 14px 16px;
            border-radius: 12px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }

        .pay-info-title {
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .pay-info-text {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .pay-info-estimate {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .pay-info-estimate strong {
            font-size: 14px;
            color: #1d4ed8;
        }

        .pay-info-estimate-note {
            font-size: 12px;
            color: #6b7280;
            margin-left: 4px;
        }

        .pay-benefits-list {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            color: #374151;
        }

        .pay-benefits-list li {
            margin-bottom: 4px;
        }

        .pay-confirm-check {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-top: 10px;
            font-size: 12px;
            color: #111827;
        }

        .pay-confirm-check input {
            margin-top: 3px;
        }

        /* ====== DISKON & TOTAL ====== */
        .discount-row {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
        }
        .discount-row input {
            flex: 1;
        }
        .discount-apply-btn {
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #ffffff;
            white-space: nowrap;
        }

        .discount-info {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        body.dark .discount-info {
            color: #9ca3af;
        }

        .discount-summary,
        .discount-total {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-top: 2px;
        }

        .discount-summary span:first-child {
            color: #6b7280;
        }
        .discount-summary span:last-child {
            color: #b91c1c;
            font-weight: 600;
        }

        .discount-total span:first-child {
            font-weight: 600;
        }
        .discount-total span:last-child {
            font-weight: 700;
            color: #1d4ed8;
        }
        body.dark .discount-total span:last-child {
            color: #93c5fd;
        }

        /* ===== TOP BADGES ROW (rapi + ruang untuk tombol) ===== */
        .top-badges-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 26px 6px 26px;
            background: linear-gradient(to right,
                        rgba(239, 246, 255, 0.96),
                        rgba(224, 242, 254, 0.96));
        }
        body.dark .top-badges-row {
            background: linear-gradient(to right,
                        rgba(8, 12, 20, 0.8),
                        rgba(15, 23, 42, 0.85));
        }

        /* badges tetap seperti sebelumnya, tapi boleh sedikit lebih kompak */
        .top-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* ===== TOMBOL KECIL (TOOLBAR) ===== */
        .controls-fab {
            border: none;
            outline: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            background: radial-gradient(circle at left,
                        #e0f2fe 0%,
                        #eef2ff 40%,
                        #ffffff 100%);
            color: #0f172a;
            box-shadow: 0 5px 14px rgba(148, 163, 184, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.7);
            transition:
                transform 0.16s ease,
                box-shadow 0.16s ease,
                background 0.16s ease,
                border-color 0.16s ease;
        }

        .controls-fab-icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            font-size: 11px;
            background: #2563eb;
            color: #ffffff;
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.7);
        }

        .controls-fab-label {
            font-weight: 600;
        }

        .controls-fab:hover {
            transform: translateY(-1px);
            box-shadow: 0 9px 20px rgba(148, 163, 184, 0.85);
            border-color: #3b82f6;
        }

        .controls-fab.active {
            background: radial-gradient(circle at left,
                        #dbeafe 0%,
                        #e0f2fe 40%,
                        #ffffff 100%);
            border-color: #3b82f6;
        }

        /* DARK */
        body.dark .controls-fab {
            background: radial-gradient(circle at left,
                        rgba(15, 23, 42, 1),
                        rgba(15, 23, 42, 0.98));
            color: #e5edff;
            border-color: rgba(51, 65, 85, 0.9);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
        }
        body.dark .controls-fab-icon {
            background: #4f46e5;
        }

        /* ===== PANEL OVERLAY UNTUK CHIPS (tidak menggeser chat) ===== */
        .controls-panel {
            position: absolute;
            left: 50%;
            top: 150px; /* kira-kira di bawah badges & toolbar */
            transform: translateX(-50%) translateY(-10px);
            width: calc(100% - 56px);
            max-width: 840px;
            opacity: 0;
            pointer-events: none;
            transition:
                opacity 0.22s ease,
                transform 0.22s ease;
            z-index: 40;
        }

        .controls-panel.open {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        /* Kartu di dalam overlay */
        .controls-card {
            background: linear-gradient(145deg,
                        rgba(255, 255, 255, 0.98),
                        rgba(240, 249, 255, 0.98));
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.35),
                0 0 0 1px rgba(255, 255, 255, 0.9);
            overflow: hidden;
            padding: 10px 14px 10px 14px;
        }

        body.dark .controls-card {
            background: linear-gradient(145deg,
                        rgba(15, 23, 42, 0.98),
                        rgba(15, 23, 42, 1));
            border-color: rgba(51, 65, 85, 0.95);
            box-shadow:
                0 20px 50px rgba(0, 0, 0, 0.95),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        /* header kecil di dalam panel */
        .controls-card-header {
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.9);
            margin-bottom: 6px;
        }

        .controls-card-title {
            font-size: 13px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .controls-card-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        body.dark .controls-card-title {
            color: #e5edff;
        }
        body.dark .controls-card-subtitle {
            color: #9ca3af;
        }

        /* feature sections di dalam panel: padding lebih kecil & tanpa background abu */
        .controls-card .feature-sections.controls-feature-sections {
            padding: 6px 4px 4px 4px;
            background: transparent;
            border-bottom: none;
        }

        /* subchips dalam panel */
        .controls-subchips {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 4px 0 4px 0;
            flex-wrap: wrap;
        }

        /* footer tip */
        .controls-card-footer {
            margin-top: 4px;
            padding-top: 6px;
            font-size: 11px;
            border-top: 1px dashed rgba(148, 163, 184, 0.7);
            color: #6b7280;
        }
        .controls-card-footer span {
            font-weight: 600;
        }
        body.dark .controls-card-footer {
            border-top-color: rgba(148, 163, 184, 0.9);
            color: #9ca3af;
        }

        /* area chat lebih lega */
        .chat-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 26px 0 26px;   /* padding atas agak kecil, samping tetap nyaman */
            background: rgba(248, 250, 252, 0.96);
            overflow: hidden;
        }

        body.dark .chat-wrapper {
            background: linear-gradient(180deg,
                        rgba(6, 10, 20, 0.4),
                        rgba(8, 12, 20, 0.7));
        }

        /* jarak tabs dengan chat jangan terlalu boros tinggi */
        .mode-tabs-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        /* tinggi minimal konten chat – bikin terasa luas */
        .chat-container {
            position: relative;
            border-radius: 18px;
            background: #f9fafb;
            box-shadow: 0 1px 0 rgba(148, 163, 184, 0.2) inset;
            padding: 18px 20px;
            overflow-y: auto;
            min-height: 420px;  /* ⬅️ kamu bisa naikkan ke 460–480 kalau mau lebih tinggi lagi */
        }

        /* responsif */
        @media (max-width: 600px) {
            .controls-panel {
                top: 140px;
                width: calc(100% - 32px);
            }
            .controls-fab-label {
                display: none; /* di hp cukup ikon ☰ saja */
            }
        }

        /* Tombol utama Pengaturan (gear) */
        .btn-settings {
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: radial-gradient(circle at left,
                        #e0f2fe 0%,
                        #eef2ff 40%,
                        #ffffff 100%);
            color: #0f172a;
            box-shadow: 0 5px 14px rgba(148, 163, 184, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.7);
            transition:
                transform 0.16s ease,
                box-shadow 0.16s ease,
                background 0.16s ease,
                border-color 0.16s ease;
        }

        .btn-settings .btn-icon {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            font-size: 11px;
            background: #2563eb;
            color: #ffffff;
            box-shadow: 0 3px 8px rgba(37, 99, 235, 0.7);
        }

        .btn-settings:hover {
            transform: translateY(-1px);
            box-shadow: 0 9px 20px rgba(148, 163, 184, 0.85);
            border-color: #3b82f6;
        }

        .btn-settings.active {
            background: radial-gradient(circle at left,
                        #dbeafe 0%,
                        #e0f2fe 40%,
                        #ffffff 100%);
            border-color: #3b82f6;
        }

        /* DARK MODE tombol gear */
        body.dark .btn-settings {
            background: radial-gradient(circle at left,
                        rgba(15, 23, 42, 1),
                        rgba(15, 23, 42, 0.98));
            color: #e5edff;
            border-color: rgba(51, 65, 85, 0.9);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.9);
        }
        body.dark .btn-settings .btn-icon {
            background: #4f46e5;
        }

        /* Dropdown pengaturan */
        .settings-menu {
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            min-width: 190px;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(148, 163, 184, 0.7);
            padding: 6px 6px;
            display: none;        /* default: hidden */
            z-index: 60;
        }

        .settings-menu.open {
            display: block;
        }

        .settings-menu button {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 13px;
            text-align: left;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #0f172a;
        }

        .settings-menu button:hover {
            background: #eff6ff;
        }

        /* DARK dropdown */
        body.dark .settings-menu {
            background: rgba(15,23,42,0.98);
            border-color: rgba(51,65,85,0.95);
        }
        body.dark .settings-menu button {
            color: #e5e7eb;
        }
        body.dark .settings-menu button:hover {
            background: rgba(30,64,175,0.6);
        }

        /* Susunan dalam header */
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Kolom kanan: tombol + badge jadi lebih rapat dan tidak makan tinggi */
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        /* Baris tombol di kanan atas: jadi anchor untuk dropdown */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
            position: relative;      /* ⬅ PENTING: anchor untuk .settings-menu */
        }

        /* === FIX LAYOUT HEADER & BADGE KECIL === */
        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        /* kanan header: susun vertikal tombol (atas) dan badge (bawah) */
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        /* baris tombol kanan atas */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* baris badge kecil */
        /* HANYA untuk di header; tidak ganggu badge lain */
        .header-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 4px;
        }

        /* badge di header: kecil, tanpa background bar, cuma outline putih tipis */
        .header-badges .badge-pill {
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 999px;
            background: transparent; /* penting: hilangkan fill */
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: none;
            color: #e5edff;
            opacity: 0.95;
        }

        .header-badges .badge-pill .icon {
            font-size: 11px;
        }

        body.dark .header-badges .badge-pill {
            color: #c7d2fe;
            border-color: rgba(191, 219, 254, 0.45);
        }

        /* kecilkan tombol supaya header tidak makan tinggi */
        .header .controls-fab,
        .header .btn-settings {
            padding: 6px 12px;
            font-size: 11px;
        }

        .header .controls-fab-icon,
        .header .btn-settings .btn-icon {
            width: 18px;
            height: 18px;
            font-size: 11px;
        }

            /* =====================================================
               MOBILE STABLE LAYOUT (AMAN & TIDAK TERPOTONG)
               ===================================================== */
            @media (max-width: 768px) {
            
              /* =====================
                 GLOBAL
                 ===================== */
              html, body {
                height: 100%;
                overflow: hidden;
              }
            
              body {
                background: linear-gradient(135deg, #4facfe, #00f2fe);
              }
            
              /* =====================
                 APP CONTAINER
                 ===================== */
              .container {
                height: 100%;
                max-width: 100%;
                display: flex;
                flex-direction: column;
                margin: 0;
                border-radius: 0;
              }
            
              /* =====================
                 HEADER (BOLEH TINGGI)
                 ===================== */
              .header {
                flex-shrink: 0;
                padding: 18px 16px 14px;
                gap: 12px;
              }
            
              .header-main {
                align-items: flex-start;
              }
            
              .header h1 {
                font-size: 20px;
                line-height: 1.3;
              }
            
              .header-right {
                gap: 6px;
              }
            
              /* tombol boleh scroll horizontal */
              .header-actions {
                display: flex;
                gap: 8px;
                overflow-x: auto;
                scrollbar-width: none;
              }
            
              .header-actions::-webkit-scrollbar {
                display: none;
              }
            
              .header-actions button {
                flex-shrink: 0;
                padding: 7px 12px;
                font-size: 12px;
                border-radius: 999px;
              }
            
              /* badge turun ke baris bawah */
              .header-badges {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
              }
            
              /* =====================
                 TAB
                 ===================== */
              .tabs {
                flex-shrink: 0;
                padding: 12px;
              }
            
              /* =====================
                 CHAT AREA (FLEXIBLE)
                 ===================== */
              .chat-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
                padding: 12px 12px 0;
                overflow: hidden;
              }
            
              .chat-container {
                flex: 1;
                overflow-y: auto;
                border-radius: 18px;
                padding: 16px;
              }
            
              /* =====================
                 INPUT AREA (SELALU TERLIHAT)
                 ===================== */
              .input-area {
                flex-shrink: 0;
                padding: 12px;
                padding-bottom: env(safe-area-inset-bottom);
                background: #ffffff;
              }
            
              .input-area input {
                height: 44px;
                font-size: 14px;
              }
            
              .input-area button {
                height: 44px;
                font-size: 14px;
              }
            
              /* =================================================
                 ONBOARDING / PANDUAN (FULL & AMAN)
                 ================================================= */
              body.ms-onboard-open {
                overflow: hidden;
              }
            
              .ms-overlay {
                position: fixed;
                inset: 0;
                z-index: 99999;
                background: rgba(0,0,0,0.35);
              }
            
              .ms-card {
                height: 100%;
                width: 100%;
                display: flex;
                flex-direction: column;
                border-radius: 0;
              }
            
              .ms-left {
                flex-shrink: 0;
                padding: 16px;
              }
            
              .ms-right {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                padding: 14px;
              }
            
              /* HANYA INI YANG SCROLL */
              .ms-slides {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
              }
            
              .ms-controls,
              .ms-footer {
                flex-shrink: 0;
              }
            
            }
    </style>
</head>
<body>
    <div id="ms-onboard-root"></div>
    <!-- CARD -->
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-main">
                <!-- KIRI: logo + judul -->
                <div class="header-left">
                    <div class="header-icon"></div>
                    <div class="header-left-text">
                        <h1>MediSkill AI Assistant</h1>
                        <span>Medis, Kesehatan, Soft Skills, dan Produktivitas</span>
                    </div>
                </div>

                <!-- KANAN: tombol + badges, rapat dan tidak makan tempat -->
                <div class="header-right">
                    <!-- baris atas: tombol -->
                    <div class="header-actions">
                        <!-- tombol kecil (toolbar) untuk buka panel chips -->
                        <button
                            id="toggleControlsBtn"
                            class="controls-fab"
                            type="button"
                            aria-label="Tampilkan Mode & Rekomendasi Cepat"
                        >
                            <span class="controls-fab-icon">☰</span>
                            <span class="controls-fab-label">Rekomendasi Cepat</span>
                        </button>

                        <!-- Tombol gear utama -->
                        <button
                            id="settingsToggle"
                            class="btn-settings has-icon"
                            type="button"
                            title="Pengaturan"
                        >
                            <span class="btn-icon">⚙️</span>
                            <span class="btn-text">Pengaturan</span>
                        </button>

                        <!-- Dropdown pengaturan -->
                        <div id="settingsMenu" class="settings-menu">
                            <button type="button" onclick="resetChat()">
                                🔄 Reset Chat
                            </button>
                            <button type="button" onclick="clearAll()">
                                🧹 Hapus Semua Data
                            </button>
                            <button type="button" id="darkToggle">
                                <span id="darkToggleIcon">🌙</span>
                                <span id="darkToggleText">Dark</span>
                            </button>
                        </div>
                    </div>

                    <!-- baris bawah: 3 badge kecil (TANPA class top-badges!) -->
                    <div class="header-badges">
                        <div class="badge-pill">
                            <span class="icon">✔</span>
                            <span>Evidence-Based Medicine</span>
                        </div>
                        <div class="badge-pill">
                            <span class="icon">🔒</span>
                            <span>Data Aman & Privat</span>
                        </div>
                        <div class="badge-pill">
                            <span class="icon">🎯</span>
                            <span>Soft Skills & Produktivitas</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL CHIPS / SUBCHIPS SEBAGAI OVERLAY (tidak menggeser chat) -->
        <div id="controlsPanel" class="controls-panel">
            <div class="controls-card">
                <div class="controls-card-header">
                    <span class="controls-card-title">Mode & Rekomendasi Cepat</span>
                    <span class="controls-card-subtitle">
                        Pilih kategori & prompt siap pakai untuk memulai percakapan.
                    </span>
                </div>

                <!-- FEATURE SECTIONS (chips besar) -->
                <div class="feature-sections no-scroll controls-feature-sections">
                    <div class="section-block">
                        <div class="section-title"><span class="icon">🩺</span> Medis & Kesehatan</div>
                        <div class="chip-row">
                            <div class="chip primary" data-mode="medis" data-template="Saya ingin konsultasi keluhan saya: ">
                                Tanya Keluhan
                            </div>
                            <div class="chip" data-mode="medis" data-template="Tolong berikan rekomendasi obat yang aman untuk: ">
                                Rekomendasi Obat
                            </div>
                            <div class="chip" data-mode="medis" data-template="Tolong jelaskan mengenai penyakit: ">
                                Edukasi Penyakit
                            </div>
                            <div class="chip" data-mode="medis" data-template="Bagaimana cara menerapkan gaya hidup sehat untuk: ">
                                Gaya Hidup Sehat
                            </div>
                        </div>
                    </div>
                    <div class="section-block">
                        <div class="section-title"><span class="icon">💼</span> Soft Skills & Produktivitas</div>
                        <div class="chip-row">
                            <div class="chip primary" data-mode="soft" data-template="Saya ingin bantuan mengatur manajemen waktu untuk: ">
                                Time Management
                            </div>
                            <div class="chip" data-mode="soft" data-template="Saya ingin membangun kebiasaan baru: ">
                                Habit Building
                            </div>
                            <div class="chip" data-mode="soft" data-template="Saya ingin menjaga kesehatan mental terkait: ">
                                Mental Wellness
                            </div>
                            <div class="chip" data-mode="soft" data-template="Saya ingin menyusun goal yang jelas untuk: ">
                                Goal Setting
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUBCHIPS (PROMPT LEBIH SPESIFIK) -->
                <div class="controls-subchips" id="subchips-medis">
                    <div class="subchip" data-mode="medis" data-template="Keluhan utama saya adalah: ">Keluhan</div>
                    <div class="subchip" data-mode="medis" data-template="Saya memiliki riwayat alergi: ">Alergi</div>
                    <div class="subchip" data-mode="medis" data-template="Saya ingin memperbaiki gaya hidup saya, terutama pada: ">
                        Gaya Hidup
                    </div>
                </div>
                <div class="controls-subchips" id="subchips-soft" style="display:none;">
                    <div class="subchip" data-mode="soft" data-template="Goal utama saya saat ini: ">Goal Saya</div>
                    <div class="subchip" data-mode="soft" data-template="Tantangan saya dalam manajemen waktu: ">
                        Manajemen Waktu
                    </div>
                    <div class="subchip" data-mode="soft" data-template="Kondisi mental yang sedang saya rasakan: ">
                        Mental Wellness
                    </div>
                </div>

                <div class="controls-card-footer">
                    💡 <span>Tips:</span> tekan salah satu chip untuk mengisi prompt secara otomatis, lalu lanjutkan dengan
                    detail versi Anda.
                </div>
            </div>
        </div>

        <!-- CHAT WRAPPER: mode tabs tetap di tengah, tidak ikut toolbar -->
        <div class="chat-wrapper">
            <div class="mode-tabs-wrapper">
                <div class="mode-tabs">
                    <button class="mode-tab active" data-mode="medis">
                        <span class="icon">🩺</span> Medis & Kesehatan
                    </button>
                    <button class="mode-tab" data-mode="soft">
                        <span class="icon">💼</span> Soft Skills & Produktivitas
                    </button>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-card">
                        <div class="empty-state-text">
                            <h2 class="empty-state-title">Mulai percakapan dengan MediSkill AI</h2>
                            <p class="empty-state-subtitle">
                                Ceritakan keluhan medis, tantangan produktivitas, atau hal yang lagi kamu pikirin.
                                Pakai bahasa santai juga boleh 😊
                            </p>
                        </div>

                        <div class="empty-state-hint">
                            Tips: kamu bisa mulai dengan kalimat seperti
                            <span>“Aku lagi ngerasain…”</span> atau <span>“Gue lagi kesulitan buat…”</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INPUT -->
        <div class="input-container">
            <div id="errorContainer"></div>
            <form class="input-form" id="chatForm">
                <input type="text" id="messageInput" placeholder="Ketik keluhan atau pertanyaan medis Anda..." autocomplete="off" required />
                <button type="submit" class="btn-send" id="sendBtn">Kirim</button>
            </form>
        </div>
    </div>

    <script>
        /* ============================================================
        FINAL MEDISKILL AI – ONBOARDING SCRIPT (STABLE SINGLE FILE)
        - Auto-show on first visit
        - No reload loop / no flicker
        - Header Panduan injection (copy style when possible)
        - Floating trigger only if header lacks Panduan
        ============================================================ */
        (function () {
            const KEY = "ms_onboard_v1";
            const FLOAT_ID = "ms-onboard-trigger";
            const HEADER_BTN_ID = "ms-onboard-header-btn";

            /* ------------------ utility: find header container ------------------ */
            function findHeaderContainer() {
                return document.querySelector(".header .header-actions")
                    || document.querySelector(".header-actions")
                    || document.querySelector("header")
                    || document.querySelector(".topbar")
                    || document.querySelector(".app-header")
                    || document.querySelector(".controls")
                    || document.querySelector(".navbar .actions")
                    || document.body;
            }

            /* ------------------ header Panduan detection ------------------ */
            function headerHasPanduanEl() {
                const header = findHeaderContainer();
                if (!header) return null;
                // 1) id
                const byId = header.querySelector("#" + HEADER_BTN_ID);
                if (byId) return byId;
                // 2) aria-label or text content match within header only
                const candidates = header.querySelectorAll("button, a, [role='button'], div, span");
                for (const el of candidates) {
                    try {
                        const aria = (el.getAttribute && el.getAttribute("aria-label")) || "";
                        const txt = (el.innerText || el.textContent || "").trim();
                        if (/panduan/i.test(aria) || /(^|[^A-Za-z0-9])panduan([^A-Za-z0-9]|$)/i.test(txt)) return el;
                    } catch (e) { /* ignore */ }
                }
                return null;
            }

            /* ------------------ remove existing floating trigger ------------------ */
            function removeFloatingTrigger() {
                const t = document.getElementById(FLOAT_ID) || document.querySelector("[data-ms-onboard-trigger]");
                if (t) t.remove();
            }

            /* ------------------ copy style from similar header button ------------------ */
            function copyStyleToBtn(btn) {
                const header = findHeaderContainer();
                if (!header || !btn) return;
                const candidates = header.querySelectorAll("button, a");
                let src = null;
                for (const c of candidates) {
                    const t = (c.innerText || c.textContent || "").trim();
                    const aria = (c.getAttribute && c.getAttribute("aria-label")) || "";
                    if (/Rekomendasi Cepat|Rekomendasi|Pengaturan|Settings/i.test(t) || /rekomendasi|pengaturan|settings/i.test(aria)) {
                        src = c;
                        break;
                    }
                }
                if (src && src.classList && src.classList.length) {
                    try { btn.className = src.className + " ms-onboard-header-btn"; } catch (e) { /* ignore */ }
                } else {
                    // fallback look
                    btn.style.padding = "8px 12px";
                    btn.style.borderRadius = "999px";
                    btn.style.border = "1px solid rgba(15,23,42,0.08)";
                    btn.style.background = "linear-gradient(135deg, rgba(255,255,255,0.95), rgba(245,247,255,0.95))";
                    btn.style.boxShadow = "0 6px 16px rgba(2,6,23,0.08)";
                    btn.style.fontWeight = "700";
                }
            }

            /* ------------------ bind Panduan click (idempotent) ------------------ */
            function bindHeaderClick(button) {
                if (!button) return;
                if (button.dataset.bound === "1") return;
                button.dataset.bound = "1";
                // NOT passive — we call preventDefault
                button.addEventListener("click", function (e) {
                    if (e && e.preventDefault) e.preventDefault();
                    // open overlay without reload
                    removeExistingOverlay();
                    buildOnboarding();
                }, false);
            }

            /* ------------------ inject header Panduan button if missing ------------------ */
            function injectHeaderPanduanButton() {
                const exists = headerHasPanduanEl();
                if (exists) {
                    bindHeaderClick(exists);
                    removeFloatingTrigger();
                    return;
                }

                const header = findHeaderContainer();
                if (!header) return;

                // create button
                const btn = document.createElement("button");
                btn.id = HEADER_BTN_ID;
                btn.setAttribute("aria-label", "Panduan MediSkill AI");
                btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:8px"><span style="font-size:14px">💬</span><span>Panduan</span></span>';
                copyStyleToBtn(btn);

                // attempt insertion near a similar control
                let inserted = false;
                try {
                    const headerChildren = header.querySelectorAll("button, a, [role='button']");
                    for (const c of headerChildren) {
                        const t = (c.innerText || c.textContent || "").trim();
                        if (/Rekomendasi Cepat|Rekomendasi|Pengaturan|Settings/i.test(t)) {
                            c.insertAdjacentElement("afterend", btn);
                            inserted = true;
                            break;
                        }
                    }
                } catch (e) { inserted = false; }

                if (!inserted) {
                    try { header.appendChild(btn); } catch (e) { /* ignore */ }
                }

                bindHeaderClick(btn);
                removeFloatingTrigger();
            }

            /* ------------------ ensure floating trigger only if header lacks Panduan ------------------ */
            function ensureFloatingTrigger() {
                if (headerHasPanduanEl()) {
                    const fl = document.getElementById(FLOAT_ID);
                    if (fl) fl.remove();
                    return;
                }
                if (document.getElementById(FLOAT_ID)) return;

                const t = document.createElement("button");
                t.id = FLOAT_ID;
                t.className = "ms-btn ghost";
                t.style.position = "fixed";
                t.style.right = "16px";
                t.style.bottom = "16px";
                t.style.zIndex = 99998;
                t.style.padding = "10px 14px";
                t.style.borderRadius = "999px";
                // match header look if possible - minimal style
                t.style.background = "linear-gradient(135deg,#ffffff,#f5f7ff)";
                t.style.boxShadow = "0 6px 16px rgba(0,0,0,0.08)";
                t.style.border = "1px solid rgba(0,0,0,0.06)";
                t.style.fontWeight = "700";

                t.innerHTML = "💬 Panduan";
                // NOT passive — to be consistent if preventDefault used later
                t.addEventListener("click", function (ev) {
                    if (ev && ev.preventDefault) ev.preventDefault();
                    removeExistingOverlay();
                    buildOnboarding();
                }, false);

                document.body.appendChild(t);
            }

            /* ------------------ remove any existing overlay ------------------ */
            function removeExistingOverlay() {
                const old = document.querySelector(".ms-overlay");
                if (old) old.remove();
            }

            /* ------------------ slides content (user-friendly) ------------------ */
            const slidesContent = [
                {
                    emoji: '🤖',
                    title: 'Introduction',
                    desc:
                        'MediSkill AI adalah asisten virtual yang membantu menjawab pertanyaan kesehatan ringan, memberikan informasi layanan, dan memberi panduan awal sebelum Anda pergi ke fasilitas kesehatan. MediSkill AI tidak menggantikan dokter, tetapi membantu Anda memahami langkah pertama yang sebaiknya diambil.'
                },

                {
                    emoji: '☰',
                    title: 'Rekomendasi Cepat',
                    desc:
                        'Di bagian atas chat terdapat tombol-tombol kecil (chip) seperti “Tanya Keluhan” atau “Rekomendasi Obat”. Tombol ini memudahkan Anda memulai percakapan tanpa perlu mengetik panjang. Cukup tekan tombolnya, dan sistem akan langsung memberi bantuan.'
                },

                {
                    emoji: '⚙️',
                    title: 'Pengaturan',
                    desc:
                        'Di menu Pengaturan Anda bisa melakukan beberapa hal penting: mengulang percakapan dari awal (Reset Chat), menghapus data yang tersimpan di perangkat (Hapus Data), dan mengaktifkan Mode Gelap agar tampilan lebih nyaman di mata, terutama di malam hari.'
                },

                {
                    emoji: '📘',
                    title: 'Tombol Panduan',
                    desc:
                        'Jika sewaktu-waktu Anda bingung menggunakan fitur MediSkill AI, cukup tekan tombol “Panduan” di bagian atas layar. Panduan ini bisa dibuka kapan saja dan menjelaskan fungsi-fungsi utama dengan sederhana.'
                },

                {
                    emoji: '⚡',
                    title: 'Panel Pintas di Chat',
                    desc:
                        'Saat AI memberikan balasan, terkadang muncul tombol biru “Lihat Panel Pintas MediSkill AI”. Panel ini berisi menu cepat untuk memilih layanan tanpa harus mengetik. Cocok untuk pengguna yang ingin navigasi praktis.'
                },

                {
                    emoji: "🧭",
                    title: "Kategori Utama",
                    desc: `
                        Panel Pintas berisi beberapa pilihan utama yang membantu Anda menemukan layanan dengan cepat:
                        <br><br>
                        <ul style="margin-left:16px; padding-left:16px; line-height:1.45;">
                            <li><strong>Tanya Dokter</strong> – konsultasi keluhan ringan</li>
                            <li><strong>Info Biaya</strong> – melihat paket & perkiraan harga layanan</li>
                            <li><strong>Cek Fasilitas</strong> – melihat layanan seperti Telemed, Lab, Fisioterapi, dll.</li>
                            <li><strong>Pelatihan</strong> – pengembangan soft skills & kursus singkat</li>
                            <li><strong>About</strong> – informasi tentang aplikasi MediSkill AI</li>
                        </ul>
                    `,
                    features: true
                },

                {
                    emoji: '💳',
                    title: 'Info Biaya',
                    desc:
                        'Di bagian Info Biaya, Anda dapat melihat penjelasan paket layanan, estimasi biaya, dan opsi pembayaran. Tersedia juga tombol “Cek Asuransi” untuk mengetahui apakah layanan tertentu dapat ditanggung oleh asuransi yang Anda miliki.'
                },

                {
                    emoji: '🏥',
                    title: 'Fasilitas & Layanan',
                    desc:
                        'Di sini Anda bisa mengenal berbagai jenis layanan seperti Telemedicine (konsultasi online), Laboratorium, Fisioterapi, hingga Konseling Psikologi. Setiap layanan memiliki penjelasan singkat agar Anda mudah memilih sesuai kebutuhan.'
                },

                {
                    emoji: '🎓',
                    title: 'Pelatihan Soft Skills',
                    desc:
                        'Fitur ini membantu Anda meningkatkan keterampilan penting seperti manajemen waktu, komunikasi, pengambilan keputusan, hingga persiapan presentasi. Materinya dibuat singkat dan mudah dipahami, cocok untuk pelajar, pekerja, maupun orang tua.'
                },

                {
                    emoji: 'ℹ️',
                    title: 'Tentang MediSkill AI',
                    desc:
                        'MediSkill AI dibuat untuk membantu siapa saja mendapatkan informasi awal yang jelas dan ramah. Fokusnya adalah memberi arahan sederhana agar Anda tidak bingung dalam mengambil langkah pertama. Aplikasi ini bukan alat diagnosis medis.'
                },

                {
                    emoji: '✨',
                    title: 'Siap Mulai?',
                    desc:
                        'Anda dapat menutup panduan ini dan mulai bertanya apa saja—mulai dari keluhan kesehatan ringan, informasi layanan, hingga panduan keterampilan. Jika butuh bantuan lagi, cukup tekan tombol “Panduan”.'
                }
            ];

            function buildOnboarding() {

                document.body.classList.remove("ms-onboard-open");

                // remove any existing overlay first
                removeExistingOverlay();

                // --- Build overlay (overlay HTML) ---
                const overlay = document.createElement("div");
                overlay.className = "ms-overlay";

                overlay.innerHTML = `
                <div class="ms-card" role="dialog" aria-modal="true" aria-label="Panduan MediSkill AI">
                    <div class="ms-left">
                        <div class="ms-ai-photo" aria-hidden="true">
                            <!-- gunakan <img> agar src dapat dimuat + fallback akan di-handle via JS -->
                            <img src="/static/images/profile.png" alt="MediSkill AI">
                        </div>

                        <p class="ms-left-desc">
                            MediSkill AI membantu menjawab pertanyaan kesehatan ringan, memberi informasi layanan & perkiraan biaya,
                            serta memberikan panduan singkat untuk meningkatkan keterampilan kerja dan produktivitas sehari-hari.
                            Ikuti panduan ini untuk mengenal fitur utama dengan mudah.
                        </p>
                    </div>

                    <div class="ms-right">
                    <div class="ms-header">
                        <div>
                        <h3>Selamat datang</h3>
                        <p>Panduan singkat MediSkill AI</p>
                        </div>
                        <button class="ms-close" id="ms-close" aria-label="Tutup">✕</button>
                    </div>

                    <div class="ms-slides-wrap">
                        <!-- INI area yang discroll -->
                        <div class="ms-slides" id="ms-slides" tabindex="0"></div>

                        <!-- Kontrol: DI LUAR .ms-slides sehingga selalu terlihat -->
                        <div class="ms-controls">
                        <div class="ms-dots" id="ms-dots" aria-hidden="false"></div>
                        <div style="display:flex;gap:8px;align-items:center">
                            <button class="ms-btn ghost" id="ms-back">Kembali</button>
                            <button class="ms-btn ghost" id="ms-skip">Lewati</button>
                            <button class="ms-btn primary" id="ms-next">Selanjutnya</button>
                        </div>
                        </div>

                        <div class="ms-footer">
                        <label class="ms-never"><input type="checkbox" id="ms-never"> Jangan tampilkan lagi</label>
                        <!-- jika mau tambahkan ruang kecil di kanan footer -->
                        </div>
                    </div>
                    </div>
                </div>
                `;

                document.body.appendChild(overlay);
                // lock background scroll
                document.body.classList.add("ms-onboard-open");

                // ensure close button is inside header and aligned (idempotent)
                (function normalizeClosePos() {
                const overlay = document.querySelector('.ms-overlay');
                if (!overlay) return;
                const header = overlay.querySelector('.ms-header');
                const closeBtn = overlay.querySelector('.ms-close') || document.getElementById('ms-close');
                if (!header || !closeBtn) return;
                // move button into header if not already
                if (closeBtn.parentElement !== header) {
                    // remove from old parent safely
                    try { closeBtn.remove(); } catch (e) { /* ignore */ }
                    header.appendChild(closeBtn);
                }
                // ensure accessible attributes
                closeBtn.setAttribute('aria-label', 'Tutup panduan');
                })();

                // --- Create avatar with robust styling + fallback ---
                (function setupAvatar() {
                    // Replace this path with actual image path you host
                    const AVATAR_SRC = "/static/images/profile.png";

                    // find avatar container that exists in the overlay
                    const ph = document.querySelector('.ms-left .ms-ai-photo');
                    if (!ph) return;

                    // apply strict circle container styles to avoid gaps
                    ph.style.width = "110px";
                    ph.style.height = "110px";
                    ph.style.borderRadius = "50%";
                    ph.style.overflow = "hidden";
                    ph.style.display = "flex";
                    ph.style.alignItems = "center";
                    ph.style.justifyContent = "center";
                    ph.style.background = "transparent";
                    ph.style.padding = "0";
                    ph.style.boxSizing = "border-box";
                    ph.style.boxShadow = "0 8px 16px rgba(0,0,0,0.16)";
                    ph.style.border = "6px solid rgba(255,255,255,0.06)"; // subtle ring (optional)

                    // create <img> (replace existing image element if present)
                    const existingImg = ph.querySelector('img');
                    if (existingImg) existingImg.remove();

                    const img = document.createElement("img");
                    img.alt = "MediSkill AI";
                    img.decoding = "async";
                    img.loading = "eager"; // eager ensures it's loaded for overlay
                    img.src = AVATAR_SRC;

                    // ensure img fills full circle with no gap
                    img.style.width = "100%";
                    img.style.height = "100%";
                    img.style.objectFit = "cover";
                    img.style.display = "block";
                    img.style.borderRadius = "50%";
                    img.style.boxShadow = "none";
                    img.style.background = "linear-gradient(135deg,#ffffff,#f0f6ff)";

                    // fallback handler: if image fails, replace with initials fallback element
                    img.addEventListener("error", () => {
                        if (img.parentElement) img.remove();

                        const fallback = document.createElement("div");
                        fallback.style.width = "100%";
                        fallback.style.height = "100%";
                        fallback.style.borderRadius = "50%";
                        fallback.style.display = "grid";
                        fallback.style.placeItems = "center";
                        fallback.style.fontWeight = "800";
                        fallback.style.color = "#ffffff";
                        fallback.style.background = "linear-gradient(135deg,#0ea5e9,#6366f1)";
                        fallback.style.fontSize = "20px";
                        fallback.textContent = "M|AI"; // initials

                        ph.appendChild(fallback);
                    });

                    // on load: ensure any previously appended fallbacks removed
                    img.addEventListener("load", () => {
                        const existing = ph.querySelector("div");
                        if (existing && existing.tagName === "DIV" && existing.textContent === "M|AI") {
                            existing.remove();
                        }
                    });

                    // append image (fallback will attach itself on error)
                    ph.appendChild(img);

                    // optional: make descriptive paragraph styling neat
                    const leftDesc = ph.parentElement.querySelector(".ms-left-desc");
                    if (leftDesc) {
                        leftDesc.style.color = "rgba(255,255,255,0.95)";
                        leftDesc.style.fontSize = "13px";
                        leftDesc.style.lineHeight = "1.45";
                        leftDesc.style.maxWidth = "220px";
                        leftDesc.style.marginTop = "12px";
                        leftDesc.style.textAlign = "center";
                        // add subtle padding so paragraph doesn't touch avatar ring
                        leftDesc.style.padding = "6px 4px";
                    }
                })();

                // --- IMPORTANT: declare sc and dots BEFORE we use them in the forEach loop ---
                const sc = document.getElementById("ms-slides");
                const dotsContainer = document.getElementById("ms-dots");

                // build slides (slidesContent assumed to be in scope)
                slidesContent.forEach((s, i) => {
                    const slide = document.createElement("div");
                    slide.className = "ms-slide";
                    slide.dataset.index = i;

                    slide.innerHTML = `
                        <div class="ms-slide-content">
                            <div class="ms-slide-inner">
                                <div style="display:flex;gap:12px;align-items:flex-start">
                                    <div class="ms-emoji">${s.emoji}</div>
                                    <div style="flex:1">
                                        <div class="ms-slide-title">${s.title}</div>
                                        <div class="ms-slide-desc"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // set desc as HTML (so <ul> etc render correctly)
                    const descEl = slide.querySelector(".ms-slide-desc");
                    if (descEl) descEl.innerHTML = s.desc || "";

                    // if features grid is needed, append it AFTER description
                    if (s.features) {
                        const grid = document.createElement("div");
                        grid.className = "ms-feature-grid";
                        grid.innerHTML = `
                            <div class="ms-feature"><div class="icon">👩‍⚕️</div><div style="font-size:13px"><strong>Tanya Dokter</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Konsultasi keluhan singkat</div></div></div>
                            <div class="ms-feature"><div class="icon">💳</div><div style="font-size:13px"><strong>Info Biaya</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Paket & kisaran harga</div></div></div>
                            <div class="ms-feature"><div class="icon">🏥</div><div style="font-size:13px"><strong>Cek Fasilitas</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Telemed, Lab, Fisio</div></div></div>
                            <div class="ms-feature"><div class="icon">🎓</div><div style="font-size:13px"><strong>Pelatihan</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Soft skills & kursus</div></div></div>
                            <div class="ms-feature"><div class="icon">ℹ️</div><div style="font-size:13px"><strong>About</strong><div style="font-size:12px;color:var(--muted);margin-top:6px">Tentang layanan</div></div></div>
                        `;
                        slide.querySelector(".ms-slide-inner").appendChild(grid);
                    }

                    sc.appendChild(slide);

                    // create dot and attach normal click listener (NOT passive)
                    const dot = document.createElement("div");
                    dot.className = "ms-dot";
                    dot.dataset.index = i;
                    dot.addEventListener("click", function (e) {
                        // no preventDefault needed here
                        showSlide(i);
                    });
                    dotsContainer.appendChild(dot);
                });

                // control element refs
                let current = 0;
                const back = document.getElementById("ms-back");
                const next = document.getElementById("ms-next");
                const skip = document.getElementById("ms-skip");
                const close = document.getElementById("ms-close");
                const never = document.getElementById("ms-never");
                if (never) {
                    never.checked = localStorage.getItem(KEY) === "dismissed";
                }

                function showSlide(i) {
                    current = Math.max(0, Math.min(slidesContent.length - 1, i));
                    document.querySelectorAll('.ms-slide').forEach(s => s.classList.remove('active'));
                    const active = document.querySelector('.ms-slide[data-index="' + current + '"]');
                    if (active) active.classList.add('active');

                    document.querySelectorAll('.ms-dot').forEach(d => d.classList.toggle('active', +d.dataset.index === current));

                    back.style.visibility = current === 0 ? 'hidden' : 'visible';
                    next.textContent = current === slidesContent.length - 1 ? 'Selesai' : 'Selanjutnya';

                    // Jangan auto-scroll
                }

                const leftDesc = document.querySelector('.ms-left-desc');
                if (leftDesc) {
                    requestAnimationFrame(() => {
                        // small delay then add visible
                        setTimeout(() => leftDesc.classList.add('visible'), 60);
                    });
                }

                function finish() {
                    if (never && never.checked) {
                        localStorage.setItem(KEY, "dismissed");
                    } else {
                        localStorage.removeItem(KEY);   // ← user uncheck → reset
                    }
                    removeExistingOverlay();
                    ensureFloatingTrigger();
                }

                back.addEventListener("click", function () { showSlide(current - 1); });
                next.addEventListener("click", function () { current < slidesContent.length - 1 ? showSlide(current + 1) : finish(); });
                skip.addEventListener("click", finish);
                close.addEventListener("click", finish);

                // fallback avatar: jika img gagal load, tampilkan lingkaran dengan inisial
                (function avatarFallback() {
                    const ph = document.querySelector('.ms-ai-photo');
                    if (!ph) return;
                    const img = ph.querySelector('img');
                    if (!img) return;
                    img.addEventListener('error', () => {
                        try { img.remove(); } catch (e) { /* ignore */ }
                        const fallback = document.createElement('div');
                        fallback.style.width = '100%';
                        fallback.style.height = '100%';
                        fallback.style.borderRadius = '50%';
                        fallback.style.display = 'grid';
                        fallback.style.placeItems = 'center';
                        fallback.style.fontSize = '18px';
                        fallback.style.fontWeight = '800';
                        fallback.style.color = '#ffffff';
                        fallback.style.background = 'linear-gradient(135deg,#0ea5e9,#6366f1)';
                        fallback.textContent = 'M|AI';
                        ph.appendChild(fallback);
                    });
                })();

                /* =========================
                   MOBILE SWIPE GESTURE
                   ========================= */
                (function enableMobileSwipe() {
                    const container = document.getElementById("ms-slides");
                    if (!container) return;
                
                    let startX = 0;
                    let startY = 0;
                    let isSwiping = false;
                
                    const SWIPE_THRESHOLD = 50;   // jarak minimum swipe
                    const VERTICAL_LIMIT = 60;    // toleransi scroll vertikal
                
                    container.addEventListener("touchstart", function (e) {
                        if (!e.touches || e.touches.length !== 1) return;
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        isSwiping = true;
                    }, { passive: true });
                
                    container.addEventListener("touchmove", function (e) {
                        if (!isSwiping || !e.touches) return;
                
                        const dx = e.touches[0].clientX - startX;
                        const dy = e.touches[0].clientY - startY;
                
                        // jika user scroll vertikal → batalkan swipe
                        if (Math.abs(dy) > VERTICAL_LIMIT) {
                            isSwiping = false;
                            return;
                        }
                
                        // jangan preventDefault di sini agar scroll tetap natural
                    }, { passive: true });
                
                    container.addEventListener("touchend", function (e) {
                        if (!isSwiping) return;
                        isSwiping = false;
                
                        const touch = e.changedTouches && e.changedTouches[0];
                        if (!touch) return;
                
                        const dx = touch.clientX - startX;
                        const dy = touch.clientY - startY;
                
                        // pastikan swipe horizontal dominan
                        if (Math.abs(dx) > SWIPE_THRESHOLD && Math.abs(dx) > Math.abs(dy)) {
                            if (dx < 0) {
                                // swipe kiri → next
                                if (current < slidesContent.length - 1) {
                                    showSlide(current + 1);
                                }
                            } else {
                                // swipe kanan → back
                                if (current > 0) {
                                    showSlide(current - 1);
                                }
                            }
                        }
                    });
                })();

                // show first slide
                showSlide(0);
            }

            /* ------------------ initialization ------------------ */
            document.addEventListener("DOMContentLoaded", function () {
                // inject header panduan button if missing (and bind)
                injectHeaderPanduanButton();

                // ALWAYS show onboarding on load, UNLESS user explicitly opted out earlier
                const optedOut = localStorage.getItem(KEY) === "dismissed";
                if (!optedOut) {
                    buildOnboarding();
                }
                if (!optedOut) {
                    // small delay so UI paint selesai
                    setTimeout(() => {
                        try { buildOnboarding(); } catch (e) { console.warn("Onboard open failed", e); }
                    }, 80);
                } else {
                    // if user opted out, keep the floating trigger visible when header lacks button
                    ensureFloatingTrigger();
                }

                // observe header/DOM changes to keep triggers in sync
                const obs = new MutationObserver(() => {
                    try {
                        injectHeaderPanduanButton();
                        if (!headerHasPanduanEl()) ensureFloatingTrigger();
                        else removeFloatingTrigger();
                    } catch (e) { /* ignore */ }
                });
                obs.observe(document.documentElement || document.body, { childList: true, subtree: true, attributes: true });
            });

            // expose dev helper
            window._ms_removeFloatingPanduan = removeFloatingTrigger;
            // expose global show function (safe) - opens overlay without reload
            window.showMediSkillOnboarding = function () {
                removeExistingOverlay();
                buildOnboarding();
            };

        })();

        /* ============================================================
            AUREX AI — Enhanced (no typing effect), Dark Mode, no Quick Replies
            - preserve existing behavior; remove per-char typing
            - quick replies feature removed as requested
            - ADDED: interface rendering (global + 3 special)
        ============================================================ */

        let currentMode  = 'medis';
        let currentTopic = '';

        // Safety timeout for loading (ms)
        const AUREX_LOADING_TIMEOUT = 20000;

        // ====== INTERFACE PERSISTENCE (localStorage) ======
        const AUREX_INTERFACES_KEY = 'aurex_last_interfaces';

        function saveInterfacesForReload(interfaces) {
            try {
                if (!interfaces || !interfaces.length) {
                    localStorage.removeItem(AUREX_INTERFACES_KEY);
                    return;
                }
                localStorage.setItem(AUREX_INTERFACES_KEY, JSON.stringify(interfaces));
            } catch (e) {
                console.warn('Failed to save interfaces:', e);
            }
        }

        function restoreSavedInterfaces() {
            try {
                const raw = localStorage.getItem(AUREX_INTERFACES_KEY);
                if (!raw) return;

                const interfaces = JSON.parse(raw);
                if (!interfaces || !interfaces.length) return;

                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;

                // Saat reload, selalu taruh di bagian paling bawah chat
                // -> kirim anchor = null supaya renderInterfaces append ke chatContainer
                renderInterfaces(interfaces, null);
            } catch (e) {
                console.warn('Failed to restore interfaces:', e);
            }
        }

        /* --------------------------
        Secure escapeHtml: use textContent to escape,
        then convert newlines to <br> for rendering.
        Handles null/undefined gracefully.
        -------------------------- */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            const tmp = document.createElement('div');
            tmp.textContent = str;
            let escaped = tmp.innerHTML;
            // preserve newlines as <br>
            escaped = escaped.replace(/(?:\r\n|\r|\n)/g, '<br>');
            return escaped;
        }

        /* --------------------------
        Simple Markdown -> HTML converter (safe: runs after escapeHtml)
        Supports **bold** and *italic* (extendable)
        -------------------------- */
        function mdToHtml(text) {
            if (!text) return '';
            // Bold **text** (non-greedy)
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic *text*
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            return text;
        }

        // ---- SESSION ID HELPER ----
        function getSessionId() {
            const KEY = "mediskill_session_id";
        
            let id = localStorage.getItem(KEY);
            if (!id) {
                // Kalau browser support crypto.randomUUID
                if (window.crypto && window.crypto.randomUUID) {
                    id = crypto.randomUUID();
                } else {
                    // Fallback simple
                    id = "sess-" + Date.now() + "-" + Math.random().toString(16).slice(2);
                }
                localStorage.setItem(KEY, id);
            }
            return id;
        }
        
        // bikin 1 global constant yang dipakai di semua fetch
        const SESSION_ID = getSessionId();

        /* --------------------------
        Switch mode (medis / soft)
        -------------------------- */
        function switchMode(mode) {
            const tabs     = document.querySelectorAll('.mode-tab');
            const medisSub = document.getElementById('subchips-medis');
            const softSub  = document.getElementById('subchips-soft');
            const input    = document.getElementById('messageInput');

            currentMode = mode;

            tabs.forEach(t => {
                const m = t.getAttribute('data-mode');
                if (m === mode) t.classList.add('active');
                else t.classList.remove('active');
            });

            if (mode === 'medis') {
                if (medisSub) medisSub.style.display = 'flex';
                if (softSub) softSub.style.display  = 'none';
                if (input) input.placeholder = 'Ketik keluhan atau pertanyaan medis Anda...';
            } else {
                if (medisSub) medisSub.style.display = 'none';
                if (softSub) softSub.style.display  = 'flex';
                if (input) input.placeholder = 'Ceritakan tantangan, goal, atau kebiasaan yang ingin Anda bangun...';
            }
        }

        function switchToMedisMode() {
            // pakai fungsi utama yang sudah ngurus tab, subchip, placeholder, dll
            switchMode('medis');
            console.log("Mode otomatis berpindah → MEDIS & KESEHATAN");
        }

        function switchToSoftMode() {
            switchMode('soft');
            console.log("Mode otomatis berpindah → SOFT SKILLS & PRODUKTIVITAS");
        }


        /* --------------------------
        Setup on load
        -------------------------- */
        window.addEventListener('DOMContentLoaded', function () {
            setupModeTabs();
            setupChips();
            loadChatHistory();
            switchMode('medis');

            const mi = document.getElementById('messageInput');
            if (mi) mi.focus();

            if (typeof setupDarkMode === 'function') {
                setupDarkMode();
            }
            if (typeof setupControlsToolbar === 'function') {
                setupControlsToolbar();
            }
            if (typeof setupSettingsMenu === 'function') {
                setupSettingsMenu();
            }
        });

        /* --------------------------
        Mode tab handlers
        -------------------------- */
        function setupModeTabs() {
            const tabs = document.querySelectorAll('.mode-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.getAttribute('data-mode');
                    switchMode(mode);
                    const mi = document.getElementById('messageInput');
                    if (mi) mi.focus();
                });
            });
        }

        /* --------------------------
        Chips / subchips activation
        -------------------------- */
        function setupChips() {
            const chips = document.querySelectorAll('.chip, .subchip');
            const input = document.getElementById('messageInput');

            chips.forEach(chip => {
                const tpl   = chip.getAttribute('data-template');
                const mode  = chip.getAttribute('data-mode');
                const topic = chip.getAttribute('data-topic') || chip.innerText.trim();

                chip.addEventListener('click', () => {
                    if (mode) switchMode(mode);
                    currentTopic = topic;
                    if (tpl) input.value = tpl;
                    else input.value = topic;
                    input.focus();
                });
            });
        }

        // ==== QUICK TOOLBAR (Rekomendasi Cepat) ====
        function setupControlsToolbar() {
            const toggleBtn = document.getElementById('toggleControlsBtn');
            const panel     = document.getElementById('controlsPanel');

            // Kalau elemen tidak ada, diam saja
            if (!toggleBtn || !panel) return;

            // Klik tombol -> buka/tutup panel
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = panel.classList.toggle('open');
                toggleBtn.classList.toggle('active', isOpen);
            });

            // Klik di luar -> tutup panel
            document.addEventListener('click', (e) => {
                if (!panel.contains(e.target) && !toggleBtn.contains(e.target)) {
                    panel.classList.remove('open');
                    toggleBtn.classList.remove('active');
                }
            });
        }

        // ==== DROPDOWN PENGATURAN ====
        function setupSettingsMenu() {
            const btn  = document.getElementById('settingsToggle');
            const menu = document.getElementById('settingsMenu');

            // Kalau elemen tidak ada, diam saja
            if (!btn || !menu) return;

            // Klik tombol -> toggle dropdown
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !menu.classList.contains('open');
                menu.classList.toggle('open', isOpen);
                btn.classList.toggle('active', isOpen);
            });

            // Klik di luar -> tutup dropdown
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.remove('open');
                    btn.classList.remove('active');
                }
            });
        }

        /* --------------------------
        Load chat history (from backend)
        -------------------------- */
        function loadChatHistory() {
            const url = '/get_history?session_id=' + encodeURIComponent(SESSION_ID);
        
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const chatContainer = document.getElementById('chatContainer');
                    const emptyState = document.getElementById('emptyState');
        
                    // Kalau backend kirim success:false, jangan paksa baca messages
                    if (!data.success) {
                        console.error('Failed to load history:', data.error || 'unknown error');
                        return;
                    }
        
                    if (data.messages && data.messages.length > 0) {
                        if (emptyState) emptyState.style.display = 'none';
                        data.messages.forEach(msg => {
                            if (msg.is_user) {
                                appendMessage(msg.q, 'user', msg.timestamp);
                            } else {
                                appendMessage(msg.a, 'ai', msg.timestamp);
                            }
                        });
                        scrollToBottom();
                    }
                })
                .catch(err => {
                    console.error('Error loading history:', err);
                })
                .finally(() => {
                    // setelah riwayat (jika ada) selesai dimuat,
                    // baru kita kembalikan tombol/panel interface
                    restoreSavedInterfaces();
                });
        }
        
        /* --------------------------
        Append message (quick)
        - Render markdown (bold/italic) safely by escapeHtml -> mdToHtml
        -------------------------- */
        function appendMessage(text, type, timestamp = null) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) :
                                        new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            // escape then convert markdown -> safe HTML
            const safeHtml = mdToHtml(escapeHtml(text));

            messageDiv.innerHTML = `
                <div class="message-content">
                    ${safeHtml}
                    <span class="message-time">${timeStr}</span>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            // scrollToBottom();
        }

        /* --------------------------
        Create AI bubble (for loading -> instant output)
        returns wrapper node
        -------------------------- */
        function createAIBubble() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return null;

            const wrap = document.createElement('div');
            wrap.className = 'message ai';
            wrap._isLoading = false;
            wrap._loadingTimer = null;
            wrap._dotsEl = null;

            wrap.innerHTML = `
                <div class="message-content">
                    <div class="ai-text" aria-live="polite"></div>
                    <span class="message-time"></span>
                </div>
            `;

            chatContainer.appendChild(wrap);
            // scrollToBottom();   // nonaktifkan auto-scroll
            return wrap;    
        }

        /* --------------------------
        Ensure loading CSS (only once)
        -------------------------- */
        function ensureLoadingStyle() {
            if (document.getElementById('aurex-loading-style')) return;
            const s = document.createElement('style');
            s.id = 'aurex-loading-style';
            s.textContent = `
                .aurex-dots { display:inline-block; width:46px; text-align:left; vertical-align: middle; margin-left:6px; }
                .aurex-dots span { display:inline-block; width:7px; height:7px; margin:0 2px; border-radius:50%; background:#667eea; opacity:0.6; transform:scale(0.7); animation:aurex-bounce 1.05s infinite; }
                .aurex-dots span:nth-child(2){ animation-delay:0.12s; }
                .aurex-dots span:nth-child(3){ animation-delay:0.24s; }
                @keyframes aurex-bounce { 0%{ transform:translateY(0) scale(0.7); opacity:0.5 } 40%{ transform:translateY(-6px) scale(1); opacity:1 } 100%{ transform:translateY(0) scale(0.7); opacity:0.5 } }
            `;
            document.head.appendChild(s);
        }

        /* --------------------------
        startLoading: show "thinking" + dots
        -------------------------- */
        function startLoading(wrapper) {
            if (!wrapper) return;
            ensureLoadingStyle();

            if (wrapper._isLoading) return;
            wrapper._isLoading = true;
            wrapper._canceled = false;

            const span = wrapper.querySelector('.ai-text');
            const timeEl = wrapper.querySelector('.message-time');
            if (!span) return;

            span.innerHTML = 'MediSkill AI sedang berpikir';
            const dots = document.createElement('span');
            dots.className = 'aurex-dots';
            dots.innerHTML = '<span></span><span></span><span></span>';
            span.appendChild(dots);
            wrapper._dotsEl = dots;

            if (timeEl) timeEl.textContent = '';

            if (wrapper._loadingTimer) {
                clearTimeout(wrapper._loadingTimer);
                wrapper._loadingTimer = null;
            }
            wrapper._loadingTimer = setTimeout(() => {
                if (wrapper._isLoading) {
                    wrapper._canceled = true;
                    stopLoadingAndShow(wrapper, "Permintaan mengambil waktu lama. Coba lagi sebentar.");
                }
            }, AUREX_LOADING_TIMEOUT);

            // scrollToBottom();
        }

        /* --------------------------
        stopLoadingAndShow: instantly show full answer (no typing)
        - clears loading timer, removes dots, sets content
        - render markdown safely
        -------------------------- */
        function stopLoadingAndShow(wrapper, text) {
            if (!wrapper) return;

            if (wrapper._loadingTimer) {
                clearTimeout(wrapper._loadingTimer);
                wrapper._loadingTimer = null;
            }

            wrapper._isLoading = false;
            wrapper._canceled = false;

            if (wrapper._dotsEl) {
                wrapper._dotsEl.remove();
                wrapper._dotsEl = null;
            }

            const span = wrapper.querySelector('.ai-text');
            const timeEl = wrapper.querySelector('.message-time');
            if (span) {
                // escape then convert markdown -> safe HTML
                span.innerHTML = mdToHtml(escapeHtml(text));
                if (timeEl) timeEl.textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            }

            // scrollToBottom();
        }

        /* --------------------------
        Form submit handler
        -------------------------- */
        document.getElementById('chatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            sendMessageFlow(message);
        });

        /* --------------------------
        Main send flow
        - append user message, create ai bubble (loading)
        - fetch backend, then show full response instantly
        - quick replies feature REMOVED
        -------------------------- */
        async function sendMessageFlow(msg, quickpanelIntent = null) {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
        
            // Tampilkan pesan user di UI
            appendMessage(msg, 'user');
            input.disabled = true;
            sendBtn.disabled = true;
            input.value = '';
        
            const emptyStateEl = document.getElementById('emptyState');
            if (emptyStateEl) emptyStateEl.style.display = 'none';
        
            const bubble = createAIBubble();
            startLoading(bubble);
        
            try {
                const res = await fetch('/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,                  // pakai msg
                        mode: currentMode,
                        topic: currentTopic || '',
                        quickpanel_intent: quickpanelIntent,
                        session_id: SESSION_ID
                    })
                });
        
                let json;
                try {
                    json = await res.json();
                } catch (e) {
                    throw new Error('Response server tidak valid');
                }
        
                if (!res.ok || json.error) {
                    const errMsg =
                        (json && (json.error || json.message)) ||
                        `Terjadi kesalahan di server (kode ${res.status})`;
                    stopLoadingAndShow(bubble, errMsg);
                    input.disabled = false;
                    sendBtn.disabled = false;
                    return;
                }
        
                const answer = json.response || json.a || "Maaf, saya belum bisa menjawab sekarang.";
        
                // tampilkan jawaban AI
                stopLoadingAndShow(bubble, answer);
        
                // === render interfaces kalau ada ===
                try {
                    const interfaces = json.interfaces || [];
                    if (interfaces && interfaces.length) {
                        renderInterfaces(interfaces, bubble);
                        saveInterfacesForReload(interfaces);
                    }
                } catch (err) {
                    console.warn('Failed to render interfaces:', err);
                }
        
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
        
            } catch (err) {
                console.error('sendMessageFlow error:', err);
                stopLoadingAndShow(bubble, "Terjadi kesalahan jaringan, coba beberapa saat lagi.");
                input.disabled = false;
                sendBtn.disabled = false;
            }
        }

        /* --------------------------
        Reset chat
        -------------------------- */
        function resetChat() {
            if (!confirm('Apakah Anda yakin ingin mereset percakapan?')) return;
        
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: SESSION_ID   // 🔥 WAJIB dikirim
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // 🧹 bersihkan panel pintas yang disimpan
                        try {
                            localStorage.removeItem(AUREX_INTERFACES_KEY);
                        } catch (e) {
                            console.warn('Gagal menghapus interfaces dari localStorage:', e);
                        }
        
                        // 🔄 refresh halaman setelah semuanya dibersihkan
                        location.reload();
                    } else {
                        showError('Gagal mereset chat: ' + (data.error || 'unknown error'));
                    }
                })
                .catch(err => showError('Gagal mereset chat: ' + (err.message || err)));
        }
        
        /* --------------------------
        Clear all data
        -------------------------- */
        function clearAll() {
            if (!confirm('PERINGATAN: Ini akan menghapus SEMUA data termasuk knowledge base dinamis (riwayat percakapan). Lanjutkan?')) return;
            fetch('/clear_all', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('chatContainer').innerHTML = `
                            <div class="empty-state" id="emptyState">
                                ...
                            </div>
                        `;
                        currentTopic = '';
                        localStorage.removeItem(AUREX_INTERFACES_KEY);   // ⬅️ bersihkan
                        alert('Semua data berhasil dihapus!');
                    }
                })
                .catch(err => showError('Gagal menghapus data: ' + (err.message || err)));
        }

        /* --------------------------
        Scroll helper & Error
        -------------------------- */
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            if (!errorContainer) return;
            errorContainer.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
            setTimeout(() => { errorContainer.innerHTML = ''; }, 5000);
        }

        /* --------------------------
        Dark Mode (persist in localStorage)
        -------------------------- */
        const darkToggle = document.getElementById("darkToggle");
        const darkToggleIcon = document.getElementById("darkToggleIcon");
        const darkToggleText = document.getElementById("darkToggleText");

        function updateDarkToggleUI(isDark) {
            if (isDark) {
                darkToggleIcon.textContent = "☀️";
                darkToggleText.textContent = "Light";
            } else {
                darkToggleIcon.textContent = "🌙";
                darkToggleText.textContent = "Dark";
            }
        }

        // Panggil saat halaman pertama kali load juga
        updateDarkToggleUI(document.body.classList.contains("dark"));

        // Di event klik dark mode kamu:
        darkToggle.addEventListener("click", () => {
            const isDark = document.body.classList.toggle("dark");
            updateDarkToggleUI(isDark);
        });

        /* ===========================================================
        === NEW: Interface rendering functions (added below) ===
        These functions are non-intrusive — they only run after
        backend returns `json.interfaces` in /send_message response.
        They append UI elements below the AI bubble.
        =========================================================== */

        // Helper: remove existing interface wrapper following an anchor
        function removeExistingInterfaceWrapper(anchor) {
            if (!anchor || !anchor.parentNode) return;
            const next = anchor.nextSibling;
            if (next && next.classList && next.classList.contains('interface-wrapper')) {
                next.parentNode.removeChild(next);
            }
        }

        // Main: render list of interfaces (global / fee / facilities / training / location)
        function renderInterfaces(interfaces, anchor) {
            try {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;

                // host = tempat kita menempelkan interface-wrapper
                // - kalau ada anchor (bubble AI baru): taruh DI DALAM bubble
                // - kalau tidak ada anchor (misal reload): taruh di bawah chat
                let hostForWrapper = chatContainer;

                if (anchor) {
                    const msgContent = anchor.querySelector('.message-content');
                    hostForWrapper = msgContent || anchor;

                    // buang interface-wrapper lama di dalam bubble ini, biar nggak dobel
                    const old = hostForWrapper.querySelector('.interface-wrapper');
                    if (old) old.remove();
                } else {
                    // mode restoreSavedInterfaces → taruh di bagian paling bawah chat
                    const oldRoot = chatContainer.querySelector('.interface-wrapper');
                    if (oldRoot && !oldRoot.closest('.message')) {
                        oldRoot.remove();
                    }
                }

                // --- KUMPULKAN OBJEK INTERFACE ---
                let globalObj     = null;
                let feeObj        = null;
                let facilitiesObj = null;
                let trainingObj   = null;
                let locationObj   = null;
                const others      = [];

                (interfaces || []).forEach(intf => {
                    if (!intf || !intf.id) return;
                    switch (intf.id) {
                        case 'global_quickpanel':
                            globalObj = intf;
                            break;
                        case 'fee_and_packages':
                            feeObj = intf;
                            break;
                        case 'facilities_grid':
                            facilitiesObj = intf;
                            break;
                        case 'training_programs':
                            trainingObj = intf;
                            break;
                        case 'location_directory':
                            locationObj = intf;
                            break;
                        default:
                            others.push(intf);
                    }
                });

                // buat wrapper
                const wrapper = document.createElement('div');
                wrapper.className = 'interface-wrapper';

                // tombol-tombol ekstra (Info Biaya / Fasilitas / Pelatihan)
                const extraButtons = [];

                if (feeObj) {
                    extraButtons.push({
                        label: 'Panel Info Biaya',
                        onClick: () => openFeeModal(feeObj)
                    });
                }

                if (facilitiesObj) {
                    extraButtons.push({
                        label: 'Panel Fasilitas',
                        onClick: () => openFacilitiesModal(facilitiesObj)
                    });
                }

                if (trainingObj) {
                    extraButtons.push({
                        label: 'Panel Pelatihan',
                        onClick: () => openTrainingModal(trainingObj)
                    });
                }

                // GLOBAL QUICKPANEL BUTTON + extra buttons
                if (globalObj) {
                    wrapper.appendChild(renderGlobalButton(globalObj, extraButtons));
                } else {
                    // fallback kalau global_quickpanel nggak dikirim
                    extraButtons.forEach(cfg => {
                        wrapper.appendChild(renderPanelButton(cfg.label, cfg.onClick));
                    });
                }

                // lokasi (kalau ada) → tetap ditampilkan sebagai card kecil
                if (locationObj) {
                    wrapper.appendChild(renderLocationDirectory(locationObj));
                }

                // interface lain yang tidak dikenali → dump JSON
                others.forEach(intf => {
                    const pre = document.createElement('pre');
                    pre.className = 'json-dump';
                    pre.innerText = JSON.stringify(intf, null, 2);
                    wrapper.appendChild(pre);
                });

                // akhirnya: tempel wrapper ke host yang sudah ditentukan
                hostForWrapper.appendChild(wrapper);

                // scrollToBottom(); // optional
            } catch (err) {
                console.error('renderInterfaces error', err);
            }
        }

        /* ---------------------------
        GLOBAL QUICKPANEL AS MODAL (JS)
        ----------------------------*/

        function renderGlobal(obj) {
            const card = document.createElement('div');
            card.className = 'card global-panel';

            const comp = obj.components || [];
            const greeting = comp.find(c => c.kind === 'greeting_card');
            const quickLinks = comp.find(c => c.kind === 'quick_links');
            const searchBar = comp.find(c => c.kind === 'search_bar');
            const tip = comp.find(c => c.kind === 'tip_card');
            const notice = comp.find(c => c.kind === 'notice');

            // ===== GREETING HEADER =====
            if (greeting) {
                const header = document.createElement('div');
                header.className = 'global-panel-header';

                const iconWrap = document.createElement('div');
                iconWrap.className = 'greeting-icon';
                iconWrap.textContent = greeting.icon || '👋';

                const txtWrap = document.createElement('div');
                const title = document.createElement('div');
                title.className = 'global-panel-title';
                title.textContent = greeting.title || 'Halo!';

                const subtitle = document.createElement('div');
                subtitle.className = 'global-panel-subtitle';
                subtitle.textContent = greeting.subtitle || '';

                txtWrap.appendChild(title);
                txtWrap.appendChild(subtitle);

                header.appendChild(iconWrap);
                header.appendChild(txtWrap);

                card.appendChild(header);
            }

            // ===== NOTICE BANNER (jam konsultasi) =====
            if (notice) {
                const banner = document.createElement('div');
                banner.className = 'notice-banner';

                const ic = document.createElement('div');
                ic.className = 'notice-icon';
                ic.textContent = notice.icon || '⏰';

                const tx = document.createElement('div');
                tx.className = 'notice-text';
                tx.textContent = notice.text || '';

                banner.appendChild(ic);
                banner.appendChild(tx);
                card.appendChild(banner);
            }

            // ===== QUICK LINKS (tombol menu cepat) =====
            if (quickLinks && Array.isArray(quickLinks.items)) {
                const bar = document.createElement('div');
                bar.className = 'quick-links';

                quickLinks.items.forEach(it => {
                    const btn = document.createElement('button');
                    btn.className = 'ql-btn';

                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'icon';
                    iconSpan.textContent = it.icon || '•';

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'label';
                    labelSpan.textContent = it.label || '';

                    btn.appendChild(iconSpan);
                    btn.appendChild(labelSpan);

                    btn.onclick = () => {
                    // 🔹 1) cari overlay modal yang menaungi tombol ini
                    const overlay = btn.closest('.modal-overlay');

                    if (it.action && typeof it.action === 'string' && it.action.startsWith('intent:')) {
                        const intent = it.action.split(':')[1];

                        // 🔹 2) auto switch mode (seperti sebelumnya)
                        if (intent === 'ask_training') {
                            switchToSoftMode();
                        } else if (
                            intent === 'ask_price' ||
                            intent === 'ask_facilities' ||
                            intent === 'ask_doctor'
                        ) {
                            switchToMedisMode();
                        }

                        const map = {
                            'ask_price':      'Berapa kisaran biaya layanan kesehatan yang tersedia?',
                            'ask_facilities': 'Fasilitas apa saja yang tersedia di fasilitas kesehatan ini?',
                            'ask_doctor':     'Saya ingin konsultasi dengan dokter mengenai keluhan saya.',
                            'ask_training':   'Saya tertarik dengan pelatihan soft skills, ada program apa saja?',
                            'ask_help':       'Tolong jelaskan apa saja yang bisa MediSkill AI bantu dan cara menggunakan fitur-fiturnya.'
                        };

                        const q = map[intent] || it.label;
                        sendMessageFlow(q, intent);
                    } else {
                        handleAction(it.action);
                    }

                    // 🔹 3) setelah aksi dijalankan, tutup modal QuickPanel
                    if (overlay) {
                        overlay.remove();
                    }
                };

                    bar.appendChild(btn);
                });

                card.appendChild(bar);
            }

            // ===== OPTIONAL: SEARCH BAR GLOBAL =====
            if (searchBar) {
                const wrap = document.createElement('div');
                wrap.className = 'global-search-wrap';

                const input = document.createElement('input');
                input.className = 'global-search';
                input.placeholder = searchBar.placeholder || 'Tanyakan sesuatu ke MediSkill AI...';

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const val = input.value.trim();
                        if (val) {
                            sendMessageFlow(val);
                            input.value = '';
                        }
                    }
                });

                wrap.appendChild(input);
                card.appendChild(wrap);
            }

            // ===== TIP CARD =====
            if (tip) {
                let tipText = '';
                if (Array.isArray(tip.tips) && tip.tips.length) {
                    tipText = (tip.display_mode === 'random')
                        ? tip.tips[Math.floor(Math.random() * tip.tips.length)]
                        : tip.tips[0];
                }

                const tc = document.createElement('div');
                tc.className = 'tip-card';

                const titleRow = document.createElement('div');
                titleRow.className = 'tip-card-title';
                titleRow.innerHTML = (tip.icon ? `${tip.icon} ` : '') + escapeHtml(tip.title || 'Tip Hari Ini');

                const bodyRow = document.createElement('div');
                bodyRow.innerHTML = escapeHtml(tipText);

                tc.appendChild(titleRow);
                tc.appendChild(bodyRow);

                card.appendChild(tc);
            }

            return card;
        }

        /* Create and open modal showing the full global_quickpanel */
        function openGlobalQuickpanelModal(globalObj) {
            // Overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };

            // Modal container (scrollable content)
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.maxHeight = '80vh';
            modal.style.overflow = 'auto';
            modal.style.padding = '12px';

            // Header inside modal
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.marginBottom = '8px';

            const title = document.createElement('div');
            title.innerHTML = `<strong>${escapeHtml(globalObj.summary_card?.title || 'QuickPanel')}</strong><div style="font-size:12px; color: #6b7280;">${escapeHtml(globalObj.summary_card?.subtitle || '')}</div>`;
            header.appendChild(title);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn-close';
            closeBtn.innerText = 'Tutup';
            closeBtn.onclick = () => document.body.removeChild(overlay);
            header.appendChild(closeBtn);

            modal.appendChild(header);

            // Body: render the quickpanel card content using existing renderGlobal
            const contentCard = renderGlobal(globalObj);
            contentCard.style.margin = '0';
            contentCard.style.width = '100%';
            modal.appendChild(contentCard);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // set focus to first input if search present
            const firstInput = modal.querySelector('input');
            if (firstInput) firstInput.focus();
        }

        function openFeeModal(obj) {
            switchToMedisMode();
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'modal';

            modal.appendChild(renderFeeTable(obj)); // UI biaya

            const close = document.createElement('button');
            close.className = 'btn-close';
            close.innerText = "Tutup";
            close.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(close);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function openFacilitiesModal(obj) {
            switchToMedisMode();
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'modal';

            modal.appendChild(renderFacilitiesGrid(obj));

            const close = document.createElement('button');
            close.className = 'btn-close';
            close.innerText = "Tutup";
            close.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(close);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function openTrainingModal(obj) {
            switchToSoftMode();
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'modal';

            modal.appendChild(renderTrainingPrograms(obj));

            const close = document.createElement('button');
            close.className = 'btn-close';
            close.innerText = "Tutup";
            close.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(close);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        /* When rendering interfaces, instead of inlining global_quickpanel,
        create a button below the AI bubble that opens the modal. */

        /* Button "Lihat Panel Pintas MediSkill" + tombol panel konteks di sampingnya */
        function renderGlobalButton(globalObj, extraButtons = []) {
            const btnWrap = document.createElement('div');
            btnWrap.className = 'global-open-btn-wrap';

            // tombol utama: QuickPanel
            const openBtn = document.createElement('button');
            openBtn.className = 'global-open-btn';
            openBtn.innerText = 'Lihat Panel Pintas MediSkill AI';
            openBtn.onclick = () => openGlobalQuickpanelModal(globalObj);
            btnWrap.appendChild(openBtn);

            // tombol-tombol kecil di samping (Info Biaya, Fasilitas, Pelatihan)
            extraButtons.forEach(cfg => {
                const b = document.createElement('button');
                b.className = 'global-open-btn global-open-btn-secondary';
                b.innerText = cfg.label;
                b.onclick = cfg.onClick;
                btnWrap.appendChild(b);
            });

            return btnWrap;
        }

        function renderPanelButton(label, callback) {
            const btnWrap = document.createElement("div");
            btnWrap.style.display = "inline-block";
            btnWrap.style.marginLeft = "8px";

            const btn = document.createElement("button");
            btn.className = "global-open-btn"; 
            btn.innerText = label;
            btn.onclick = callback;

            btnWrap.appendChild(btn);
            return btnWrap;
        }

        /* --------------------------
        Render Fee & Packages table → jadi kartu paket menarik
        returns DOM node
        -------------------------- */
        function renderFeeTable(obj) {
            const card = document.createElement('div');
            card.className = 'card fee-card fee-card-modern';

            // HEADER
            const title = document.createElement('h4');
            title.innerText = obj.summary_card?.title || 'Biaya & Paket Layanan';
            card.appendChild(title);

            if (obj.summary_card?.subtitle) {
                const sub = document.createElement('p');
                sub.className = 'fee-subtitle';
                sub.innerText = obj.summary_card.subtitle;
                card.appendChild(sub);
            }

            // GRID PAKET
            const grid = document.createElement('div');
            grid.className = 'fee-plans-grid';

                // Ambil semua baris paket
                const rows = obj.table?.rows || [];

                // DEBUG (opsional): cek berapa banyak baris yang benar-benar diterima
                console.log("Jumlah paket yang diterima dari backend:", rows.length);

                // LOOP SEMUA baris, TANPA slice / limit
                rows.forEach((r, idx) => {
                    const plan = document.createElement('div');
                    plan.className = 'fee-plan-card';

                    // ==== HEADER NAMA + BADGE ====
                    const header = document.createElement('div');
                    header.className = 'fee-plan-header';

                    const name = document.createElement('div');
                    name.className = 'fee-plan-name';
                    name.innerText = r.service || 'Paket Layanan';

                    header.appendChild(name);

                    const badgeText = r.badge || r.tagline || (idx === 0 ? 'Rekomendasi' : '');
                    if (badgeText) {
                        const badge = document.createElement('div');
                        badge.className = 'fee-plan-badge';
                        badge.innerText = badgeText;
                        header.appendChild(badge);
                    }

                    plan.appendChild(header);

                    // ==== HARGA + DURASI ====
                    const priceWrap = document.createElement('div');
                    priceWrap.className = 'fee-price-wrap';

                    const priceMain = document.createElement('div');
                    priceMain.className = 'fee-plan-price-main';
                    priceMain.innerText = r.price ? formatCurrency(r.price) : 'Hubungi Admin';

                    const priceSub = document.createElement('div');
                    priceSub.className = 'fee-plan-price-sub';
                    priceSub.innerText = r.duration || '';

                    priceWrap.appendChild(priceMain);
                    if (priceSub.innerText) priceWrap.appendChild(priceSub);
                    plan.appendChild(priceWrap);

                    // ==== BENEFIT / INCLUDE ====
                    const incList = document.createElement('ul');
                    incList.className = 'fee-includes';

                    let includesArr = [];
                    if (Array.isArray(r.includes)) {
                        includesArr = r.includes;
                    } else if (typeof r.includes === 'string') {
                        includesArr = r.includes
                            .split(/[,;•\-]/)
                            .map(t => t.trim())
                            .filter(Boolean);
                    }

                    includesArr.forEach(i => {
                        const li = document.createElement('li');
                        li.innerText = i;
                        incList.appendChild(li);
                    });

                    if (includesArr.length) {
                        plan.appendChild(incList);
                    }

                    if (r.note) {
                        const note = document.createElement('div');
                        note.className = 'fee-note';
                        note.innerText = r.note;
                        plan.appendChild(note);
                    }

                    const actionKey = r.action || (obj.actions && obj.actions[0]?.action);
                        if (actionKey) {
                            const cta = document.createElement('button');
                            cta.className = 'fee-plan-cta';
                            cta.innerText = r.cta_label || 'Beli Paket Ini';
                            cta.onclick = () => {
                                // ⬇️ PENTING: parameter kedua harus NUMBER, yaitu r.price
                                showFeePurchaseForm(
                                    r.service,
                                    r.price,
                                    r.duration,
                                    includesArr,
                                    r.note
                                );
                            };
                            plan.appendChild(cta);
                        }
                    grid.appendChild(plan);
                });

            card.appendChild(grid);

            // ===== HIGHLIGHTS GLOBAL (tetap) =====
            if (obj.highlights && obj.highlights.length) {
                const hl = document.createElement('div');
                hl.className = 'highlights';
                obj.highlights.forEach(h => {
                    const p = document.createElement('p');
                    p.innerText = h.text;
                    hl.appendChild(p);
                });
                card.appendChild(hl);
            }

            // ===== ACTION BAR GLOBAL (Cek Asuransi) =====
            if (obj.actions && obj.actions.length) {
                const actbar = document.createElement('div');
                actbar.className = 'action-bar';

                obj.actions.forEach(a => {
                    const b = document.createElement('button');
                    b.className = 'btn';
                    b.innerText = a.label;

                    if (a.action === 'check_insurance') {
                        b.onclick = () => openInsuranceModal(obj);
                    } else {
                        // fallback: pakai handler umum
                        b.onclick = () => handleAction(a.action);
                    }

                    actbar.appendChild(b);
                });

                card.appendChild(actbar);
            }

            return card;
        }

        // ==== FORM BOOKING FASILITAS – GAYA "BELI PAKET" TANPA CABANG/LOKASI ====
        function openFacilityBookingModal(facility) {
            try {
                const meta = FACILITY_BOOKING_META[facility.key] || {
                    title: facility.title || 'Layanan',
                    icon: facility.icon || '🏥',
                    label: facility.short_desc || '',
                    availability: facility.availability || '',
                    note: facility.details || ''
                };

                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';

                const modal = document.createElement('div');
                modal.className = 'fee-form-modal';

                modal.innerHTML = `
                    <div class="fee-form-header">
                        <div class="fee-form-icon">${meta.icon}</div>
                        <div>
                            <h3 class="fee-form-title">Booking ${escapeHtml(meta.title)}</h3>
                            <p class="fee-form-subtitle">
                                Isi data berikut untuk mengatur jadwal kunjungan / sesi di fasilitas yang Anda pilih.
                            </p>
                        </div>
                    </div>

                    <div class="fee-form-summary">
                        <div class="fee-form-summary-main">
                            <div class="fee-form-summary-title">${escapeHtml(meta.title)}</div>
                            <div class="fee-form-summary-meta">
                                ${meta.availability ? `<span>${escapeHtml(meta.availability)}</span>` : ''}
                                ${meta.label ? `<span>${escapeHtml(meta.label)}</span>` : ''}
                            </div>
                        </div>
                        <div class="fee-form-summary-price">
                            <span>Paket Layanan</span>
                            <strong>${escapeHtml(meta.title)}</strong>
                        </div>
                    </div>

                    <form class="fee-form" id="facilityBookingForm">
                        <div class="fee-form-row">
                            <div class="fee-form-field">
                                <label>Nama Lengkap</label>
                                <input type="text" name="full_name" placeholder="Masukkan nama lengkap Anda" required>
                            </div>
                            <div class="fee-form-field">
                                <label>Kontak (WhatsApp / Email)</label>
                                <input type="text" name="contact" placeholder="08xxxxxxxx atau email aktif" required>
                            </div>
                        </div>

                        <div class="fee-form-row">
                            <div class="fee-form-field">
                                <label>Tanggal Kunjungan</label>
                                <input type="date" name="date" required>
                            </div>
                            <div class="fee-form-field">
                                <label>Perkiraan Jam</label>
                                <input type="time" name="time" required>
                            </div>
                        </div>

                        <div class="fee-form-field">
                            <label>Tujuan / Keluhan Utama</label>
                            <textarea
                                name="reason"
                                placeholder="Tuliskan tujuan booking, keluhan utama, atau jenis layanan yang Anda butuhkan."
                            ></textarea>
                        </div>

                        ${meta.note ? `
                        <div class="fee-form-note">
                            <strong>Catatan fasilitas:</strong> ${escapeHtml(meta.note)}
                        </div>` : ''}

                        <div class="fee-form-footer">
                            <div class="fee-form-note">
                                Tim kami akan menghubungi Anda untuk konfirmasi jadwal, ketersediaan dokter/terapis, dan estimasi biaya.
                            </div>
                            <div class="fee-form-actions">
                                <button type="button" class="btn-close">Batal</button>
                                <button type="submit" class="fee-form-submit">Kirim Permintaan Booking</button>
                            </div>
                        </div>
                    </form>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // tombol batal
                modal.querySelector('.btn-close').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });

                // submit form booking
                const form = modal.querySelector('#facilityBookingForm');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const formData = new FormData(form);
                    const payload = {
                        facility_key: facility.key,
                        facility_title: meta.title,
                        full_name: formData.get('full_name') || '',
                        contact: formData.get('contact') || '',
                        date: formData.get('date') || '',
                        time: formData.get('time') || '',
                        reason: formData.get('reason') || ''
                    };

                    console.log('Booking fasilitas (demo):', payload);

                    // TODO: kirim ke backend pakai fetch kalau sudah siap API

                    showBookingToast(`Permintaan booking ${meta.title} berhasil dikirim. Tim kami akan menghubungi Anda.`);
                    document.body.removeChild(overlay);
                });

            } catch (err) {
                console.error('openFacilityBookingModal error:', err);
            }
        }

        function showBookingToast(message) {
            const existing = document.querySelector('.fee-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'fee-toast';
            toast.textContent = message || 'Permintaan booking berhasil dikirim.';
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('hide'), 2600);
            setTimeout(() => toast.remove(), 3200);
        }

        // panggilan tetap sama: showFeePurchaseForm(r.service, r.price, r.duration, includesArr, r.note);
        function showFeePurchaseForm(serviceName, basePrice, duration, includes, note) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };

            const modal = document.createElement('div');
            modal.className = 'modal fee-purchase-modal';

            // --------- HTML STEP 1 + STEP 2 ---------
            modal.innerHTML = `
                <div class="tf-header">
                    <div class="tf-icon">🧾</div>
                    <div>
                        <h2 class="tf-title">Pembelian Paket Layanan</h2>
                        <p class="tf-subtitle">
                            Lengkapi data di bawah ini untuk memesan paket
                            <span>${escapeHtml(serviceName || '')}</span>.
                        </p>
                    </div>
                </div>

                <!-- STEP 1: FORM INPUT + METODE + DISKON -->
                <div id="step1-wrapper">
                    <div class="purchase-summary-box">
                        <div class="purchase-service-name">${escapeHtml(serviceName || '')}</div>
                        <div class="purchase-service-meta">
                            <span>${escapeHtml(duration || '')}</span>
                            ${note ? `<span>${escapeHtml(note)}</span>` : ''}
                        </div>
                        <div class="purchase-price-row">
                            <span>Total Paket</span>
                            <span class="purchase-price-main">${formatCurrency(basePrice || 0)}</span>
                        </div>
                    </div>

                    <form id="purchaseFormStep1" class="tf-form">
                        <div class="tf-field">
                            <label>Nama Lengkap</label>
                            <input type="text" name="name" placeholder="Masukkan nama lengkap Anda" required>
                        </div>

                        <div class="tf-field">
                            <label>Email</label>
                            <input type="email" name="email" placeholder="contoh@email.com">
                        </div>

                        <div class="tf-field">
                            <label>No. WhatsApp</label>
                            <input type="text" name="phone" placeholder="08xxxxxxxxxx" required>
                        </div>

                        <div class="tf-field">
                            <label>Tanggal Kunjungan</label>
                            <input type="date" name="date" required>
                        </div>

                        <div class="tf-field">
                            <label>Perkiraan Waktu Kunjungan</label>
                            <input type="time" name="time">
                        </div>

                        <div class="tf-field">
                            <label>Catatan Tambahan</label>
                            <textarea name="notes" placeholder="Keluhan singkat, preferensi jam, atau info lain yang perlu diketahui dokter / tim kami."></textarea>
                        </div>

                        <!-- METODE PEMBAYARAN -->
                        <div class="tf-field">
                            <label>Metode Pembayaran</label>
                            <div class="payment-options">
                                <!-- E-Wallet + provider -->
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="ewallet" checked>
                                    <div>
                                        <div class="payment-option-main">E-Wallet</div>
                                        <div class="payment-option-sub">Pilih salah satu: OVO, GoPay, Dana, ShopeePay</div>

                                        <div class="payment-ewallet-extra">
                                            <span class="payment-ewallet-label">E-Wallet yang digunakan:</span>
                                            <div class="payment-ewallet-list">
                                                <label>
                                                    <input type="radio" name="ewallet_provider" value="ovo" checked>
                                                    OVO
                                                </label>
                                                <label>
                                                    <input type="radio" name="ewallet_provider" value="gopay">
                                                    GoPay
                                                </label>
                                                <label>
                                                    <input type="radio" name="ewallet_provider" value="dana">
                                                    Dana
                                                </label>
                                                <label>
                                                    <input type="radio" name="ewallet_provider" value="shopeepay">
                                                    ShopeePay
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </label>

                                <!-- VA -->
                                <label class="payment-option">
                                    <input type="radio" name="payment_method" value="va_bank">
                                    <div>
                                        <div class="payment-option-main">Virtual Account Bank</div>
                                        <div class="payment-option-sub">BCA, BNI, BRI, Mandiri, dll</div>

                                        <div class="payment-va-extra">
                                            <span class="payment-va-label">Bank yang digunakan:</span>
                                            <div class="payment-va-list">
                                                <label>
                                                    <input type="radio" name="va_bank" value="bca" checked>
                                                    BCA
                                                </label>
                                                <label>
                                                    <input type="radio" name="va_bank" value="bni">
                                                    BNI
                                                </label>
                                                <label>
                                                    <input type="radio" name="va_bank" value="bri">
                                                    BRI
                                                </label>
                                                <label>
                                                    <input type="radio" name="va_bank" value="mandiri">
                                                    Mandiri
                                                </label>
                                                <label>
                                                    <input type="radio" name="va_bank" value="lainnya">
                                                    Bank Lainnya
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- KODE DISKON -->
                        <div class="tf-field">
                            <label>Kode Diskon (opsional)</label>
                            <input type="text" name="discount_code" placeholder="Masukkan kode promo jika ada">
                            <div class="discount-hint">Contoh: SEHAT10 untuk diskon 10%*</div>
                        </div>

                        <div class="tf-price-box">
                            <div>
                                <strong>Estimasi Total Bayar:</strong>
                                <div class="tf-price" id="estTotalStep1">
                                    ${formatCurrency(basePrice || 0)}
                                </div>
                            </div>
                            <p class="tf-price-note">
                                Total akan disesuaikan secara otomatis jika kode diskon valid.
                            </p>
                        </div>

                        <button type="button" class="tf-submit-btn" id="btnNextToReview">
                            Lanjut Pembelian
                        </button>
                    </form>
                </div>

                <!-- STEP 2: REVIEW PEMBELIAN -->
                <div id="step2-wrapper" style="display:none;">
                    <div class="review-header">
                        <h3>Review Pembelian</h3>
                        <p>Periksa kembali data dan paket layanan sebelum mengkonfirmasi pembelian.</p>
                    </div>

                    <div class="review-grid">
                        <div class="review-block">
                            <div class="review-title">Detail Layanan</div>
                            <div class="review-row"><span>Layanan</span><span id="revServiceName"></span></div>
                            <div class="review-row"><span>Durasi</span><span id="revDuration"></span></div>
                            <div class="review-row"><span>Metode Pembayaran</span><span id="revPayMethod"></span></div>
                            <div class="review-row"><span>Kode Diskon</span><span id="revDiscountCode"></span></div>
                        </div>

                        <div class="review-block">
                            <div class="review-title">Data Klien & Jadwal</div>
                            <div class="review-row"><span>Nama</span><span id="revName"></span></div>
                            <div class="review-row"><span>Email</span><span id="revEmail"></span></div>
                            <div class="review-row"><span>No. WhatsApp</span><span id="revPhone"></span></div>
                            <div class="review-row"><span>Tanggal</span><span id="revDate"></span></div>
                            <div class="review-row"><span>Waktu</span><span id="revTime"></span></div>
                        </div>
                    </div>

                    <div class="review-total-box">
                        <div class="review-total-label">Total Pembayaran</div>
                        <div class="review-total-amount" id="revTotal"></div>
                        <div class="review-total-note">
                            Dengan menekan tombol <strong>Konfirmasi Pembelian</strong>, Anda menyetujui ketentuan layanan
                            dan akan diarahkan ke instruksi pembayaran sesuai metode yang dipilih.
                        </div>
                    </div>

                    <div class="review-actions">
                        <button type="button" class="btn-close" id="btnBackToForm">Kembali</button>
                        <button type="button" class="tf-submit-btn" id="btnConfirmPurchase">
                            Konfirmasi Pembelian
                        </button>
                    </div>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // ================== LOGIC STEP 1 -> STEP 2 ==================
            const form = modal.querySelector('#purchaseFormStep1');
            const estTotalEl = modal.querySelector('#estTotalStep1');
            const step1 = modal.querySelector('#step1-wrapper');
            const step2 = modal.querySelector('#step2-wrapper');
            const btnNext = modal.querySelector('#btnNextToReview');
            const btnBack = modal.querySelector('#btnBackToForm');
            const btnConfirm = modal.querySelector('#btnConfirmPurchase');
            // === HANDLE UI METODE PEMBAYARAN ===
            const paymentMethodRadios   = form.querySelectorAll('input[name="payment_method"]');
            const ewalletExtra          = form.querySelector('.payment-ewallet-extra');
            const ewalletProviderRadios = form.querySelectorAll('input[name="ewallet_provider"]');

            const vaExtra      = form.querySelector('.payment-va-extra');
            const vaBankRadios = form.querySelectorAll('input[name="va_bank"]');

            function updatePaymentUI() {
                const checked = form.querySelector('input[name="payment_method"]:checked');
                const method  = checked ? checked.value : 'ewallet';

                // default: matikan semua extra
                if (ewalletExtra) ewalletExtra.classList.add('payment-extra-disabled');
                if (vaExtra)      vaExtra.classList.add('payment-extra-disabled');
                ewalletProviderRadios.forEach(r => r.disabled = true);
                vaBankRadios.forEach(r => r.disabled = true);

                if (method === 'ewallet') {
                    if (ewalletExtra) ewalletExtra.classList.remove('payment-extra-disabled');
                    ewalletProviderRadios.forEach(r => r.disabled = false);
                } else if (method === 'va_bank') {
                    if (vaExtra) vaExtra.classList.remove('payment-extra-disabled');
                    vaBankRadios.forEach(r => r.disabled = false);
                }
            }

            // panggil sekali saat awal
            updatePaymentUI();

            // update setiap user ganti metode
            paymentMethodRadios.forEach(r => {
                r.addEventListener('change', updatePaymentUI);
            });

            // fungsi hitung diskon sederhana (contoh SEHAT10 = 10%)
            // fungsi hitung diskon
            function computeTotal(base, code) {
                let total = base;
                let applied = null;

                if (code && code.trim().toUpperCase() === 'SEHAT10') {
                    total = Math.round(base * 0.9);
                    applied = 'SEHAT10 (diskon 10%)';
                }
                return { total, applied };
            }

            // --- DI STEP 1: update estimasi total ---
            form.discount_code.addEventListener('input', () => {
                const { total } = computeTotal(basePrice || 0, form.discount_code.value);
                estTotalEl.textContent = formatCurrency(total);   // ⬅️ HARUS "total"
            });

            // tombol Lanjut Pembelian
            btnNext.addEventListener('click', () => {
                if (!form.name.value.trim() || !form.phone.value.trim() || !form.date.value) {
                    alert('Nama, No. WhatsApp, dan Tanggal Kunjungan wajib diisi.');
                    return;
                }

                const pmInput = form.querySelector('input[name="payment_method"]:checked');
                const payMethod = pmInput ? pmInput.value : 'ewallet';

                let ewalletProvider = '';
                if (payMethod === 'ewallet') {
                    const provInput = form.querySelector('input[name="ewallet_provider"]:checked');
                    ewalletProvider = provInput ? provInput.value : '';
                }

                let vaBank = '';
                    if (payMethod === 'va_bank') {
                        const bankInput = form.querySelector('input[name="va_bank"]:checked');
                        vaBank = bankInput ? bankInput.value : '';
                    }

                const { total, applied } = computeTotal(basePrice || 0, form.discount_code.value);

                // simpan ke dataset di modal (biar bisa diambil di step 2 & receipt)
                modal._purchaseData = {
                    serviceName,
                    vaBank,
                    basePrice,
                    finalTotal: total,
                    discountCode: form.discount_code.value.trim(),
                    discountLabel: applied,
                    paymentMethod: payMethod,
                    ewalletProvider,
                    name: form.name.value.trim(),
                    email: form.email.value.trim(),
                    phone: form.phone.value.trim(),
                    date: form.date.value,
                    time: form.time.value,
                    notes: form.notes.value
                };

                // isi review
                modal.querySelector('#revServiceName').textContent = serviceName || '-';
                modal.querySelector('#revDuration').textContent = duration || '-';

                let methodLabel = 'E-Wallet';
                const ewalletLabelMap = { ovo: 'OVO', gopay: 'GoPay', dana: 'Dana', shopeepay: 'ShopeePay' };
                const vaBankLabelMap  = { bca: 'BCA', bni: 'BNI', bri: 'BRI', mandiri: 'Mandiri', lainnya: 'Bank lainnya' };

                if (payMethod === 'va_bank') {
                    const bankNice = vaBankLabelMap[vaBank] || 'Bank';
                    methodLabel = `Virtual Account ${bankNice}`;
                } else if (payMethod === 'transfer') {
                    methodLabel = 'Transfer Bank Manual';
                } else if (payMethod === 'ewallet' && ewalletProvider) {
                    methodLabel = `E-Wallet (${ewalletLabelMap[ewalletProvider] || 'e-wallet'})`;
                }

                modal.querySelector('#revPayMethod').textContent = methodLabel;
                modal.querySelector('#revDiscountCode').textContent = applied || (form.discount_code.value ? form.discount_code.value : '-');

                modal.querySelector('#revName').textContent = form.name.value || '-';
                modal.querySelector('#revEmail').textContent = form.email.value || '-';
                modal.querySelector('#revPhone').textContent = form.phone.value || '-';
                modal.querySelector('#revDate').textContent = form.date.value || '-';
                modal.querySelector('#revTime').textContent = form.time.value || '-';
                modal.querySelector('#revTotal').textContent = formatCurrency(total);

                // pindah ke step 2
                step1.style.display = 'none';
                step2.style.display = 'block';
            });

            // tombol Kembali
            btnBack.addEventListener('click', () => {
                step2.style.display = 'none';
                step1.style.display = 'block';
            });

            // tombol Konfirmasi Pembelian -> langsung ke bukti pembayaran (demo)
            btnConfirm.addEventListener('click', () => {
                const data = modal._purchaseData || {};

                // tutup modal pembelian
                document.body.removeChild(overlay);

                // buka bukti pembayaran (simulasi)
                showPaymentReceiptModal({
                    serviceName: data.serviceName,
                    total: data.finalTotal || data.basePrice,
                    discountCode: data.discountCode,
                    paymentMethod: data.paymentMethod,
                    ewalletProvider: data.ewalletProvider,
                    vaBank: data.vaBank,
                    customerName: data.name,
                    customerEmail: data.email,
                    visitDate: data.date,
                    visitTime: data.time
                });
            });
        }

        // Contoh manfaat asuransi per jenis perlindungan (ilustrasi umum)
        const INSURANCE_BENEFITS = {
            rawat_jalan: {
                title: "Manfaat Rawat Jalan",
                rows: [
                    { item: "Konsultasi dokter umum/spesialis", limit: "Sesuai tagihan s/d plafon per kunjungan", note: "Termasuk biaya administrasi & jasa dokter" },
                    { item: "Obat & resep", limit: "Sesuai formularium / plafon", note: "Obat di luar formularium mungkin dibatasi" },
                    { item: "Laboratorium & penunjang sederhana", limit: "Sesuai indikasi medis", note: "Tes penunjang dasar (darah, urine, rontgen sederhana)" }
                ]
            },
            rawat_inap: {
                title: "Manfaat Rawat Inap",
                rows: [
                    { item: "Kamar & akomodasi", limit: "Kelas kamar sesuai polis (misal: kelas I)", note: "Upgrade kelas kamar biasanya ada biaya selisih" },
                    { item: "Visit dokter & tindakan medis", limit: "Sesuai tagihan s/d limit tahunan", note: "Termasuk tindakan operasi bila di-cover polis" },
                    { item: "Obat & alat kesehatan selama dirawat", limit: "Sesuai indikasi medis", note: "Beberapa alat tertentu bisa membutuhkan persetujuan khusus" }
                ]
            },
            rawat_gigi: {
                title: "Manfaat Rawat Gigi",
                rows: [
                    { item: "Tambal gigi", limit: "Sesuai plafon tahunan", note: "Biasanya hanya untuk tindakan konservatif, bukan estetika" },
                    { item: "Cabut gigi", limit: "Sesuai plafon tahunan", note: "Cabut gigi karena indikasi medis" },
                    { item: "Scaling / pembersihan karang gigi", limit: "1–2x per tahun (tergantung polis)", note: "Frekuensi & plafon mengikuti ketentuan asuransi" }
                ]
            },
            kehamilan: {
                title: "Manfaat Kehamilan (Antenatal)",
                rows: [
                    { item: "Kontrol kehamilan rutin", limit: "Sesuai jadwal & plafon kunjungan", note: "Termasuk pemeriksaan fisik & konseling" },
                    { item: "USG kehamilan", limit: "Sesuai batas jumlah USG per trimester", note: "Jumlah maksimal USG mengikuti ketentuan polis" },
                    { item: "Obat & vitamin kehamilan", limit: "Sesuai indikasi medis", note: "Vitamin di luar standar bisa tidak di-cover" }
                ]
            },
            persalinan: {
                title: "Manfaat Persalinan",
                rows: [
                    { item: "Biaya persalinan normal", limit: "Sesuai limit paket persalinan", note: "Termasuk kamar bersalin & jasa dokter/bidan" },
                    { item: "Biaya operasi sesar (SC)", limit: "Sesuai limit yang tercantum di polis", note: "Biasanya perlu indikasi medis atau persetujuan asuransi" },
                    { item: "Biaya bayi baru lahir", limit: "Kadang terpisah dari manfaat ibu", note: "Termasuk observasi awal & imunisasi dasar (jika di-cover)" }
                ]
            },
            nifas: {
                title: "Manfaat Perawatan Nifas",
                rows: [
                    { item: "Kontrol nifas ibu", limit: "Kunjungan kontrol sesuai ketentuan polis", note: "Evaluasi kondisi ibu pasca persalinan" },
                    { item: "Penanganan komplikasi nifas", limit: "Sesuai manfaat rawat jalan/inap", note: "Misal perdarahan, infeksi, atau keluhan lain" },
                    { item: "Konseling laktasi / KB pasca persalinan", limit: "Bergantung benefit polis", note: "Sebagian polis memasukkan ke dalam manfaat kehamilan" }
                ]
            }
        };

        function openInsuranceModal(feeObj) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };

            const modal = document.createElement('div');
            modal.className = 'modal fee-form-modal';

            modal.innerHTML = `
                <div class="fee-form-header">
                    <div class="fee-form-icon">🛡️</div>
                    <div>
                        <h2 class="fee-form-title">Cek Asuransi Rekanan</h2>
                        <p class="fee-form-subtitle">
                            Isi data berikut untuk kami bantu cek apakah polis asuransi Anda bisa digunakan secara
                            <strong>cashless</strong> atau <strong>reimburse</strong> di layanan kami, serta kisaran
                            limit dan biaya pribadi yang mungkin muncul.
                        </p>
                    </div>
                </div>

                <form class="fee-form" id="insuranceForm">
                    <div class="fee-form-field">
                        <label>Nama Perusahaan Asuransi</label>
                        <input type="text" name="provider" placeholder="Contoh: BPJS, Prudential, Allianz" required>
                    </div>

                    <div class="fee-form-row">
                        <div class="fee-form-field">
                            <label class="tooltip-label">
                                Nomor Polis / ID Peserta
                                <span class="tooltip-icon" data-tooltip="Nomor identitas asuransi Anda yang terdapat di kartu asuransi atau aplikasi resmi penyedia asuransi. Contoh: nomor peserta BPJS atau nomor polis asuransi swasta.">
                                    ❓
                                </span>
                            </label>
                            <input type="text" name="policy" placeholder="Masukkan nomor polis / kartu peserta" required>
                        </div>
                        <div class="fee-form-field">
                            <label>Nama Lengkap</label>
                            <input type="text" name="name" placeholder="Nama sesuai kartu identitas" required>
                        </div>
                    </div>

                    <div class="fee-form-row">
                        <div class="fee-form-field">
                            <label>Kontak (WhatsApp / Email)</label>
                            <input type="text" name="contact" placeholder="08xxxxxxxxxx atau email aktif" required>
                        </div>
                        <div class="fee-form-field">
                            <label>Jenis Perlindungan yang Ingin Dicek</label>
                            <select name="plan" id="insuranceBenefitSelect" required>
                                <option value="">Pilih jenis perlindungan...</option>
                                <option value="rawat_jalan">Rawat Jalan</option>
                                <option value="rawat_inap">Rawat Inap</option>
                                <option value="rawat_gigi">Rawat Gigi</option>
                                <option value="kehamilan">Kehamilan (Antenatal)</option>
                                <option value="persalinan">Persalinan</option>
                                <option value="nifas">Perawatan Nifas</option>
                            </select>
                        </div>
                    </div>

                    <div class="fee-form-field">
                        <label>Catatan Tambahan</label>
                        <textarea name="notes" placeholder="Keluhan singkat, rencana tindakan, atau info lain yang perlu diketahui."></textarea>
                    </div>

                    <!-- BOX MANFAAT ASURANSI -->
                    <div class="insurance-benefits-box">
                        <div class="insurance-benefits-placeholder">
                            Pilih jenis perlindungan di atas untuk melihat <strong>contoh manfaat dan limit</strong>
                            yang <em>biasanya</em> ada di polis asuransi. Data ini hanya ilustrasi umum, bukan hasil cek polis Anda.
                        </div>
                        <div class="insurance-benefits-content" style="display:none;"></div>
                    </div>

                    <div class="fee-form-footer">
                        <div class="fee-form-note">
                            Tim kami akan memeriksa benefit asuransi Anda dan menghubungi kembali untuk konfirmasi
                            <strong>cover, limit, dan estimasi biaya pribadi</strong>. Informasi manfaat di atas bersifat ilustrasi umum —
                            detail akhir mengikuti polis dan ketentuan masing-masing perusahaan asuransi.
                        </div>
                        <div class="fee-form-actions">
                            <button type="button" class="btn-close fee-form-cancel">Batal</button>
                            <button type="submit" class="fee-form-submit">Kirim Permintaan</button>
                        </div>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const form = modal.querySelector('#insuranceForm');
            const select = modal.querySelector('#insuranceBenefitSelect');
            const placeholder = modal.querySelector('.insurance-benefits-placeholder');
            const contentBox = modal.querySelector('.insurance-benefits-content');

            // handle perubahan pilihan benefit
            select.addEventListener('change', () => {
                const val = select.value;
                if (!val || !INSURANCE_BENEFITS[val]) {
                    placeholder.style.display = 'block';
                    contentBox.style.display = 'none';
                    contentBox.innerHTML = '';
                    return;
                }

                const data = INSURANCE_BENEFITS[val];
                placeholder.style.display = 'none';
                contentBox.style.display = 'block';

                contentBox.innerHTML = renderInsuranceBenefitsTable(data);
            });

            modal.querySelector('.fee-form-cancel').onclick = () => {
                document.body.removeChild(overlay);
            };

            form.onsubmit = (e) => {
                e.preventDefault();

                const fd = new FormData(form);
                const payload = {
                    provider: fd.get('provider') || '',
                    policy:   fd.get('policy')   || '',
                    name:     fd.get('name')     || '',
                    contact:  fd.get('contact')  || '',
                    plan:     fd.get('plan')     || '',
                    notes:    fd.get('notes')    || ''
                };

                // TODO: di sini nanti bisa ditambah fetch() ke backend

                document.body.removeChild(overlay);

                // tampilkan ringkasan + edukasi supaya user paham
                openInsuranceSummaryModal(payload);

                sendMessageFlow(
                "Saya baru mengisi form cek asuransi. Tolong jelaskan dengan bahasa sederhana apa yang perlu saya pahami tentang penggunaan asuransi kesehatan saya.",
                "ask_insurance_help"
                );
            };
        }

        function openInsuranceSummaryModal(data) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };

            const modal = document.createElement('div');
            modal.className = 'modal fee-form-modal';

            // translasi plan ke teks lebih ramah
            const planMap = {
                rawat_jalan:  'Rawat Jalan',
                rawat_inap:   'Rawat Inap',
                rawat_gigi:   'Rawat Gigi',
                kehamilan:    'Kehamilan (Antenatal)',
                persalinan:   'Persalinan',
                nifas:        'Perawatan Nifas'
            };
            const planLabel = planMap[data.plan] || 'Belum dipilih';

            modal.innerHTML = `
                <div class="fee-form-header">
                    <div class="fee-form-icon">✅</div>
                    <div>
                        <h2 class="fee-form-title">Permintaan Cek Asuransi Diterima</h2>
                        <p class="fee-form-subtitle">
                            Terima kasih, ${escapeHtml(data.name || 'Pasien')}. Data cek asuransi kamu sudah kami terima.
                            Tim kami akan memeriksa detail polis dan menghubungi kamu melalui kontak yang kamu isi.
                        </p>
                    </div>
                </div>

                <div class="insurance-summary-box">
                    <div class="insurance-summary-title">Ringkasan Data yang Kamu Kirim</div>
                    <div class="insurance-summary-grid">
                        <div class="insurance-summary-row"><span>Perusahaan Asuransi</span><span>${escapeHtml(data.provider || '-')}</span></div>
                        <div class="insurance-summary-row"><span>Nomor Polis / ID Peserta</span><span>${escapeHtml(data.policy || '-')}</span></div>
                        <div class="insurance-summary-row"><span>Nama Peserta</span><span>${escapeHtml(data.name || '-')}</span></div>
                        <div class="insurance-summary-row"><span>Kontak</span><span>${escapeHtml(data.contact || '-')}</span></div>
                        <div class="insurance-summary-row"><span>Jenis Perlindungan Dicek</span><span>${escapeHtml(planLabel)}</span></div>
                    </div>
                </div>

                <div class="insurance-edu-section">
                    <div class="insurance-edu-title">Apa yang akan kami cek?</div>
                    <ul class="insurance-edu-list">
                        <li>Apakah polis kamu <strong>masih aktif</strong> dan jenis perlindungan yang diminta memang ada di polis.</li>
                        <li>Apakah layanan di klinik kami bisa ditanggung secara <strong>cashless</strong> (langsung gesek kartu / tunjuk kartu) atau harus <strong>reimburse</strong>.</li>
                        <li>Perkiraan <strong>limit pertanggungan</strong> dan berapa estimasi <strong>biaya pribadi</strong> yang mungkin perlu kamu bayar.</li>
                    </ul>
                </div>

                <div class="insurance-edu-section">
                    <div class="insurance-edu-title">Apa yang perlu kamu siapkan?</div>
                    <ul class="insurance-edu-list">
                        <li>Foto / scan <strong>kartu asuransi</strong> dan <strong>KTP</strong> (kalau diminta oleh admin).</li>
                        <li>Jika sudah ada rencana tindakan (misal operasi, fisioterapi, persalinan), siapkan <strong>ringkasan medis</strong> atau hasil pemeriksaan sebelumnya.</li>
                        <li>Pastikan nomor WhatsApp atau email yang kamu tulis <strong>aktif</strong> supaya tim kami mudah menghubungi.</li>
                    </ul>
                </div>

                <div class="fee-form-footer">
                    <div class="fee-form-note">
                        Hasil cek asuransi <strong>bukan persetujuan klaim final</strong>. Persetujuan akhir tetap mengikuti
                        kebijakan perusahaan asuransi dan hasil verifikasi berkas. Jika kamu masih bingung tentang istilah
                        <em>cashless</em> vs <em>reimburse</em>, kamu bisa menanyakannya langsung ke MediSkill AI di kolom chat.
                    </div>
                    <div class="fee-form-actions">
                        <button type="button" class="btn-close insurance-summary-close">Tutup</button>
                    </div>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            modal.querySelector('.insurance-summary-close').onclick = () => {
                document.body.removeChild(overlay);
            };
        }

        function renderInsuranceBenefitsTable(benefitData) {
            if (!benefitData || !benefitData.rows) return '';

            const rowsHtml = benefitData.rows.map(row => `
                <tr>
                    <td>${escapeHtml(row.item)}</td>
                    <td>${escapeHtml(row.limit)}</td>
                    <td>${escapeHtml(row.note || '')}</td>
                </tr>
            `).join('');

            return `
                <div class="insurance-benefits-header">
                    <strong>${escapeHtml(benefitData.title)}</strong>
                    <span>Rangkuman contoh manfaat (ilustrasi umum)</span>
                </div>
                <table class="insurance-benefits-table">
                    <thead>
                        <tr>
                            <th>Manfaat</th>
                            <th>Batas / Limit Umum</th>
                            <th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            `;
        }

        function openFeeDetailsRequestModal(feeObj) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };

            const modal = document.createElement('div');
            modal.className = 'modal fee-form-modal';

            // buat opsi paket dari feeObj
            const rows = (feeObj && feeObj.table && feeObj.table.rows) ? feeObj.table.rows : [];
            const optionsHtml = rows.map(r => {
                const name = r.service || 'Paket Layanan';
                const priceLabel = r.price ? ` — ${formatCurrency(r.price)}` : '';
                return `<option value="${escapeHtml(name)}">${escapeHtml(name + priceLabel)}</option>`;
            }).join('');

            modal.innerHTML = `
                <div class="fee-form-header">
                    <div class="fee-form-icon">📄</div>
                    <div>
                        <h2 class="fee-form-title">Minta Rincian Biaya</h2>
                        <p class="fee-form-subtitle">
                            Kami akan mengirimkan rincian biaya detail sesuai paket dan kondisi Anda.
                        </p>
                    </div>
                </div>

                <form class="fee-form" id="feeDetailsForm">
                    <div class="fee-form-field">
                        <label>Pilih Paket</label>
                        <select name="package" required>
                            <option value="">Pilih paket yang ingin dirinci...</option>
                            ${optionsHtml}
                        </select>
                    </div>

                    <div class="fee-form-row">
                        <div class="fee-form-field">
                            <label>Nama Lengkap</label>
                            <input type="text" name="name" placeholder="Masukkan nama lengkap Anda" required>
                        </div>
                        <div class="fee-form-field">
                            <label>Kontak (WhatsApp / Email)</label>
                            <input type="text" name="contact" placeholder="08xxxxxxxxxx atau email aktif" required>
                        </div>
                    </div>

                    <div class="fee-form-field">
                        <label>Detail Tambahan / Kondisi Saat Ini</label>
                        <textarea name="notes" placeholder="Tuliskan keluhan, hasil lab sebelumnya, atau informasi yang perlu dipertimbangkan dalam estimasi biaya."></textarea>
                    </div>

                    <div class="fee-form-footer">
                        <div class="fee-form-note">
                            Rincian biaya akan berisi <strong>komponen biaya, estimasi tindakan, dan kisaran total</strong>.
                            Estimasi akhir tetap menyesuaikan dengan pemeriksaan dokter di fasilitas.
                        </div>
                        <div class="fee-form-actions">
                            <button type="button" class="btn-close fee-form-cancel">Batal</button>
                            <button type="submit" class="fee-form-submit">Kirim Permintaan</button>
                        </div>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const form = modal.querySelector('#feeDetailsForm');

            modal.querySelector('.fee-form-cancel').onclick = () => {
                document.body.removeChild(overlay);
            };

            form.onsubmit = (e) => {
                e.preventDefault();
                // TODO: kirim ke backend kalau mau

                document.body.removeChild(overlay);
                showInfoToast('Permintaan rincian biaya berhasil dikirim. Rincian akan dikirim melalui kontak yang Anda cantumkan.');
            };
        }

        // toast kecil di bawah layar
        function showFeeSuccessToast(planTitle) {
            const toast = document.createElement('div');
            toast.className = 'fee-toast';
            toast.innerHTML = `✅ Pembelian paket <strong>${escapeHtml(planTitle)}</strong> berhasil dikirim. Tim kami akan menghubungi Anda.`;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 250);
            }, 3500);
        }

        function showInfoToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fee-toast';
            toast.innerHTML = escapeHtml(message);

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 250);
            }, 3500);
        }

        /* --------------------------
        Render Facilities Grid (versi modern & rapi)
        -------------------------- */
        function renderFacilitiesGrid(obj) {
            // otomatis pindah ke tab medis
            switchToMedisMode();

            const card = document.createElement('div');
            card.className = 'card facilities-card';

            const title = document.createElement('h4');
            title.innerText = obj.summary_card?.title || 'Fasilitas & Layanan';
            card.appendChild(title);

            if (obj.summary_card?.subtitle) {
                const sub = document.createElement('p');
                sub.className = 'facility-subtitle';
                sub.innerText = obj.summary_card.subtitle;
                card.appendChild(sub);
            }

            const grid = document.createElement('div');
            grid.className = 'fac-grid';

            (obj.grid || []).forEach(item => {
                const it = document.createElement('div');
                it.className = 'fac-item';

                // ===== BODY ATAS CARD =====
                const body = document.createElement('div');
                body.className = 'fac-body';

                // header icon + title
                const header = document.createElement('div');
                header.className = 'fac-header';

                const icon = document.createElement('div');
                icon.className = 'fac-icon-circle';
                icon.textContent = item.icon || '🏥';

                const titleEl = document.createElement('div');
                titleEl.className = 'fac-title';
                titleEl.innerText = item.title || '';

                header.appendChild(icon);
                header.appendChild(titleEl);
                body.appendChild(header);

                // tagline / availability badge kecil di bawah judul
                if (item.availability) {
                    const tag = document.createElement('div');
                    tag.className = 'fac-tagline';
                    tag.innerText = item.availability;
                    body.appendChild(tag);
                }

                // deskripsi singkat
                if (item.short_desc) {
                    const desc = document.createElement('div');
                    desc.className = 'fac-desc';
                    desc.innerText = item.short_desc;
                    body.appendChild(desc);
                }

                // sample package (kalau ada)
                if (item.sample_package) {
                    const sp = document.createElement('div');
                    sp.className = 'fac-sample';
                    sp.innerText = `${item.sample_package.name} — ${formatCurrency(item.sample_package.price)}`;
                    body.appendChild(sp);
                }

                // benefit list (array string dari JSON)
                let benefitsArr = item.benefits;
                if (Array.isArray(benefitsArr) && benefitsArr.length) {
                    const ul = document.createElement('ul');
                    ul.className = 'fac-benefits';
                    benefitsArr.forEach(b => {
                        const li = document.createElement('li');
                        li.innerText = b;
                        ul.appendChild(li);
                    });
                    body.appendChild(ul);
                }

                // link "Lihat detail fasilitas" → buka modal detail lama
                const detailLink = document.createElement('button');
                detailLink.type = 'button';
                detailLink.className = 'fac-detail-link';
                detailLink.innerText = 'Lihat detail fasilitas';
                detailLink.onclick = () => showFacilityDetail(item, obj.detail_templates?.[item.key]);
                body.appendChild(detailLink);

                it.appendChild(body);

                // ===== TOMBOL BOOKING PALING BAWAH =====
                let bookingLabel = `Booking ${item.title || 'Layanan'}`;

                const bookBtn = document.createElement('button');
                bookBtn.className = 'fac-book-btn';
                bookBtn.innerText = bookingLabel;

                // cukup panggil fungsi global
                bookBtn.onclick = () => openFacilityBookingModal(item);

                it.appendChild(bookBtn);
                grid.appendChild(it);
            });

            card.appendChild(grid);

            // jangan render obj.actions global lagi (Lihat Detail / Booking Layanan)
            return card;
        }

        function showFacilityDetail(item, template) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };

            const modal = document.createElement('div');
            modal.className = 'modal';

            const title = document.createElement('h3');
            title.innerText = item.title;
            const desc = document.createElement('p');
            desc.innerHTML = escapeHtml(
                item.details ||
                (template?.content || item.short_desc || '')
            );

            modal.appendChild(title);
            modal.appendChild(desc);

            if (item.sample_package) {
                const sp = document.createElement('p');
                sp.className = 'sample-package';
                sp.innerText = `${item.sample_package.name} — ${formatCurrency(item.sample_package.price)}`;
                modal.appendChild(sp);
            }

            // ⬇️ DI SINI: hanya tombol Tutup, TANPA loop item.actions
            const footer = document.createElement('div');
            footer.className = 'action-bar';

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn-close';
            closeBtn.innerText = 'Tutup';
            closeBtn.onclick = () => document.body.removeChild(overlay);

            footer.appendChild(closeBtn);
            modal.appendChild(footer);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function getFacilityPurposePlaceholder(title) {
            const t = (title || '').toLowerCase();

            if (t.includes('fisioterapi')) {
                return 'Contoh: nyeri punggung bawah sejak 2 minggu, cedera olahraga, atau keluhan lain yang ingin ditangani.';
            }
            if (t.includes('psikolog') || t.includes('konseling')) {
                return 'Contoh: keluhan cemas, sulit tidur, overthinking, stres kerja/kuliah, atau hal lain yang ingin dibahas.';
            }
            if (t.includes('klinik tidur')) {
                return 'Contoh: sulit tidur, sering terbangun malam hari, mendengkur keras, atau rasa ngantuk berat di siang hari.';
            }
            if (t.includes('pelatihan soft skills')) {
                return 'Contoh: training untuk tim kantor, pelatihan komunikasi, manajemen stres, atau program pengembangan karyawan.';
            }

            return 'Tuliskan tujuan booking, keluhan utama, atau jenis layanan yang Anda butuhkan.';
        }

        /* ===============================
        GLOBAL CONFIG / MAPPING
        ================================ */

        const FACILITY_FLOW = {
            telemedicine: 'pay_first',
            laboratorium: 'pay_first',
            klinik_umum: 'booking_only',
            klinik_umum_dan_bpjs: 'booking_only',
            fisioterapi: 'booking_only',
            psikolog: 'booking_only',
            konseling_psikolog: 'booking_only',
            klinik_tidur: 'booking_only',
            sleep_clinic: 'booking_only',
            klinik_gizi: 'booking_only',
            klinik_gizi_nutrisi: 'booking_only'
        };

        // === MODAL BOOKING FASILITAS (otomatis jelaskan alur biaya) ===
        function openFacilityBookingModal(item) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            // pakai class yang sama dengan modal pembelian paket
            modal.className = 'modal purchase-modal';

            const title        = item.title || 'Layanan';
            const icon         = item.icon || '🏥';
            const availability = item.availability || '';
            const shortDesc    = item.short_desc || '';
            const samplePrice  = item.sample_package?.price
                ? formatCurrency(item.sample_package.price)
                : null;
            const sampleName   = item.sample_package?.name || '';

            // tipe alur booking berdasar key
            const flowType = FACILITY_FLOW[item.key] || 'booking_only';
            const isPayFirst = flowType === 'pay_first';

            // teks dinamis untuk bagian "Biaya & Pembayaran"
            const paymentTitle = isPayFirst
                ? 'Biaya & Pembayaran (bayar sebelum kunjungan)'
                : 'Biaya & Pembayaran';

            const paymentDesc = isPayFirst
                ? 'Untuk fasilitas ini, jadwal akan dikonfirmasi setelah kamu menyelesaikan pembayaran. Tim kami akan menghubungi kamu dengan instruksi pembayaran (link / virtual account) setelah form terkirim.'
                : 'Tidak ada biaya untuk mengunci jadwal. Pembayaran layanan dilakukan setelah pemeriksaan / tindakan di fasilitas, sesuai jenis layanan yang kamu ambil.';

            const estimateHtml = samplePrice
                ? `<div class="pay-info-estimate">
                        Perkiraan biaya awal:
                        <strong>${samplePrice}</strong>
                        ${sampleName ? `<span class="pay-info-estimate-note">(${escapeHtml(sampleName)})</span>` : ''}
                </div>`
                : '<div class="pay-info-estimate pay-info-estimate-note">Perkiraan biaya akan dijelaskan oleh tim kami setelah verifikasi kebutuhanmu.</div>';

            // manfaat booking (umum, bisa kamu sesuaikan per fasilitas)
            const benefitsHtml = `
                <ul class="pay-benefits-list">
                    <li>Slot jadwal kamu disiapkan terlebih dahulu sehingga waktu tunggu lebih singkat.</li>
                    <li>Tim bisa menyiapkan dokter/terapis & alat sesuai keluhan yang kamu tuliskan.</li>
                    <li>Ringkasan booking tersimpan rapi sehingga kunjungan berikutnya lebih mudah.</li>
                </ul>
            `;

            const confirmHtml = isPayFirst
                ? `
                <label class="pay-confirm-check">
                    <input type="checkbox" name="confirm_payment" required>
                    <span>Saya paham bahwa untuk fasilitas ini saya perlu menyelesaikan pembayaran sebelum jadwal dikonfirmasi.</span>
                </label>`
                : '';

            modal.innerHTML = `
                <div class="pay-header">
                    <div class="pay-header-left">
                        <div class="pay-header-icon">${icon}</div>
                        <div>
                            <div class="pay-header-title">Booking ${escapeHtml(title)}</div>
                            <div class="pay-header-sub">
                                Isi data berikut untuk mengatur jadwal kunjungan / sesi layanan yang kamu pilih.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- kartu ringkasan layanan -->
                <div class="pay-summary">
                    <div class="pay-summary-main">
                        <div class="pay-summary-service">
                            ${escapeHtml(title)}
                        </div>
                        <div class="pay-summary-meta">
                            ${availability ? `<span class="meta-pill">${escapeHtml(availability)}</span>` : ''}
                            ${shortDesc ? `<span class="meta-pill meta-soft">${escapeHtml(shortDesc)}</span>` : ''}
                        </div>
                        ${
                            samplePrice
                                ? `<div class="pay-summary-price-hint">
                                        Perkiraan paket: <strong>${escapeHtml(sampleName)}</strong> — ${samplePrice}
                                </div>`
                                : ''
                        }
                    </div>
                    <div class="pay-summary-side">
                        <div class="pay-summary-side-label">Jenis Layanan</div>
                        <div class="pay-summary-side-value">${escapeHtml(title)}</div>
                    </div>
                </div>

                <!-- FORM BOOKING -->
                <form id="facilityBookingForm" class="pay-form">
                    <div class="pay-grid-2">
                        <div class="pay-field">
                            <label>Nama Lengkap</label>
                            <input type="text" name="name" placeholder="Masukkan nama lengkap kamu" required />
                        </div>
                        <div class="pay-field">
                            <label>Kontak (WhatsApp / Email)</label>
                            <input type="text" name="contact" placeholder="08xxxxxxxx atau email aktif" required />
                        </div>
                    </div>

                    <div class="pay-grid-2">
                        <div class="pay-field">
                            <label>Tanggal Kunjungan</label>
                            <input type="date" name="date" required />
                        </div>
                        <div class="pay-field">
                            <label>Perkiraan Jam</label>
                            <input type="time" name="time" required />
                        </div>
                    </div>

                    <div class="pay-field">
                        <label>Tujuan / Keluhan Utama</label>
                        <textarea name="notes" rows="3"
                            placeholder="Tuliskan tujuan booking, keluhan utama, atau jenis layanan yang kamu butuhkan."
                            required></textarea>
                    </div>

                    <!-- BLOK BIAYA & PEMBAYARAN -->
                    <div class="pay-info-block">
                        <div class="pay-info-title">${paymentTitle}</div>
                        <div class="pay-info-text">${paymentDesc}</div>
                        ${estimateHtml}
                        ${benefitsHtml}
                        ${confirmHtml}
                    </div>

                    <div class="pay-note">
                        Tim kami akan menghubungi kamu untuk konfirmasi jadwal, ketersediaan dokter/terapis,
                        dan penjelasan biaya lebih detail sebelum kunjungan dimulai.
                    </div>

                    <div class="pay-actions">
                        <button type="button" class="btn-secondary btn-cancel">Batal</button>
                        <button type="submit" class="btn-primary">
                            Kirim Permintaan Booking
                        </button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // tutup modal
            function closeModal() {
                if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
            }

            modal.querySelector('.btn-cancel').onclick = closeModal;
            overlay.onclick = (e) => { if (e.target === overlay) closeModal(); };

            // submit form booking
            const form = modal.querySelector('#facilityBookingForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();

                const data = Object.fromEntries(new FormData(form).entries());

                console.log('Booking fasilitas dikirim:', {
                    facility_key: item.key,
                    facility_title: item.title,
                    flow_type: flowType,
                    ...data
                });

                closeModal();

                // tampilkan Bukti Booking, bukan alert biasa
                showBookingReceiptModal({
                    facilityTitle: item.title,
                    icon: item.icon,
                    name: data.name,
                    contact: data.contact,
                    date: data.date,
                    time: data.time,
                    notes: data.notes
                });
            });
        }

        // ganti fungsi lama showTrainingDetail dengan yang ini
        function showTrainingDetail(item) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };

            const modal = document.createElement('div');
            modal.className = 'modal training-detail-modal';

            // HEADER DETAIL PELATIHAN
            modal.innerHTML = `
                <div class="td-header">
                    <div class="td-icon">${item.icon || "📘"}</div>
                    <div class="td-header-text">
                        <h3 class="td-title">${item.title}</h3>
                        <p class="td-subtitle">${item.details || item.short_desc || ""}</p>
                    </div>
                </div>

                <div class="td-section-title">Program Tersedia</div>
            `;

            // LIST PROGRAM
            (item.programs || []).forEach(p => {
                const card = document.createElement('div');
                card.className = 'tp-card';   // card tiap program

                // tentukan badge mode
                const mode = (p.mode || "").toLowerCase();
                let modeClass = "tp-badge-neutral";
                if (mode.includes("online"))  modeClass = "tp-badge-online";
                if (mode.includes("offline")) modeClass = "tp-badge-offline";

                card.innerHTML = `
                    <div class="tp-top-row">
                        <div>
                            <div class="tp-name">${p.name}</div>
                            <div class="tp-meta">
                                <span><strong>Durasi:</strong> ${p.duration}</span>
                            </div>
                        </div>
                        <div class="tp-mode-pill ${modeClass}">
                            ${p.mode || "Mode Fleksibel"}
                        </div>
                    </div>

                    <ul class="tp-includes">
                        ${(p.includes || []).map(i => `<li>${i}</li>`).join("")}
                    </ul>

                    <div class="tp-bottom-row">
                        <div class="tp-price-group">
                            <span class="tp-price-label"><strong>Harga</strong></span>
                            <span class="tp-price">${formatCurrency(p.price)}</span>
                        </div>
                        <button class="tp-cta-btn">Daftar Sekarang</button>
                    </div>
                `;

                // klik tombol daftar → buka form pendaftaran cantik yang sudah kamu punya
                card.querySelector('.tp-cta-btn').onclick = () => showTrainingForm(p);

                modal.appendChild(card);
            });

            // tombol tutup di bawah
            const close = document.createElement('button');
            close.className = 'btn-close td-close';
            close.innerText = "Tutup";
            close.onclick = () => document.body.removeChild(overlay);
            modal.appendChild(close);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function showTrainingForm(program) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            const modal = document.createElement('div');
            modal.className = 'modal training-form-modal';

            modal.innerHTML = `
                <div class="tf-header">
                    <div class="tf-icon">📘</div>
                    <div>
                        <h2 class="tf-title">Pendaftaran Pelatihan</h2>
                        <p class="tf-subtitle">${program.name} — <span>${program.mode}</span></p>
                    </div>
                </div>

                <form id="trainingForm" class="tf-form">
                    <div class="tf-field">
                        <label>Nama Lengkap</label>
                        <input type="text" name="name" placeholder="Masukkan nama lengkap Anda" required>
                    </div>

                    <div class="tf-field">
                        <label>Email</label>
                        <input type="email" name="email" placeholder="contoh@email.com" required>
                    </div>

                    <div class="tf-field">
                        <label>Nomor WhatsApp</label>
                        <input type="text" name="phone" placeholder="08xxxxxxxxxx" required>
                    </div>

                    <div class="tf-field">
                        <label>Catatan Tambahan</label>
                        <textarea name="notes" placeholder="Tuliskan kebutuhan atau pertanyaan Anda..."></textarea>
                    </div>

                    <div class="tf-price-box">
                        <div>
                            <strong>Total Biaya:</strong>
                            <div class="tf-price">${formatCurrency(program.price)}</div>
                        </div>
                        <p class="tf-price-note">*Biaya dapat berubah sesuai ketentuan pelatihan.</p>
                    </div>

                    <button type="submit" class="tf-submit-btn">Kirim Pendaftaran</button>
                </form>

                <button class="btn-close tf-close">Tutup</button>
            `;

            modal.querySelector('.tf-close').onclick = () => document.body.removeChild(overlay);

            modal.querySelector('#trainingForm').onsubmit = (e) => {
                e.preventDefault();
                alert("Pendaftaran berhasil dikirim! Kami akan menghubungi Anda via email/WhatsApp.");
                document.body.removeChild(overlay);
            };

            overlay.appendChild(modal);
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };
            document.body.appendChild(overlay);
        }

        function showBookingReceiptModal(opts) {
            const {
                facilityTitle,
                icon,
                name,
                contact,
                date,
                time,
                notes
            } = opts || {};

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };

            const modal = document.createElement('div');
            // pakai class yang sama dengan bukti pembayaran biar 1 gaya
            modal.className = 'modal payment-receipt-modal';

            const prettyDate = date || '-';
            const prettyTime = time || '-';

            modal.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-icon">${icon || '📅'}</div>
                    <div>
                        <h2 class="receipt-title">Bukti Booking Layanan</h2>
                        <p class="receipt-subtitle">
                            Permintaan booking untuk layanan
                            <strong>${escapeHtml(facilityTitle || '')}</strong> berhasil dikirim.
                        </p>
                    </div>
                </div>

                <div class="receipt-body">
                    <!-- HIGHLIGHT STATUS -->
                    <div class="receipt-highlight">
                        <div class="receipt-highlight-method">
                            Booking ${escapeHtml(facilityTitle || '')}
                        </div>
                        <div class="receipt-highlight-amount">
                            Menunggu Konfirmasi Jadwal
                        </div>
                    </div>

                    <!-- DETAIL BOOKING -->
                    <div class="receipt-section">
                        <div class="receipt-section-title">Detail Booking</div>
                        <div class="receipt-detail-grid">
                            <div class="receipt-detail-row">
                                <span>Nama Pemesan</span>
                                <span>${escapeHtml(name || '-')}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Kontak</span>
                                <span>${escapeHtml(contact || '-')}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Tanggal Kunjungan</span>
                                <span>${prettyDate}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Perkiraan Waktu</span>
                                <span>${prettyTime}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Layanan</span>
                                <span>${escapeHtml(facilityTitle || '-')}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Tujuan / Keluhan</span>
                                <span>${escapeHtml(notes || '-')}</span>
                            </div>
                        </div>
                    </div>

                    <!-- STATUS & TINDAK LANJUT -->
                    <div class="receipt-section">
                        <div class="receipt-section-title">Status & Tindak Lanjut</div>
                        <div class="receipt-instruction">
                            <p>
                                ✅ <strong>Permintaan booking kamu sudah tercatat di sistem.</strong>
                            </p>
                            <p>
                                Berikut yang akan terjadi selanjutnya:
                            </p>
                            <ol class="receipt-steps">
                                <li>Tim kami akan menghubungi kamu melalui kontak yang kamu tulis (WhatsApp / email) untuk konfirmasi jadwal dan ketersediaan dokter/terapis.</li>
                                <li>Kamu bisa menanyakan ulang estimasi biaya, lama tindakan, atau hal lain sebelum menyetujui jadwal.</li>
                                <li>Jika perlu perubahan jadwal, cukup balas pesan konfirmasi dari tim kami.</li>
                            </ol>
                            <p class="receipt-small-note">
                                Simpan bukti booking ini sebagai catatan, terutama jika kamu menghubungi kami lewat kanal lain (telepon / WhatsApp).
                            </p>
                        </div>
                    </div>
                </div>

                <div class="receipt-footer-actions">
                    <button type="button" class="receipt-download-btn">
                        ⬇️ Download Bukti Booking
                    </button>
                    <button type="button" class="receipt-close-btn">
                        Tutup
                    </button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // tombol tutup
            const closeBtn = modal.querySelector('.receipt-close-btn');
            if (closeBtn) {
                closeBtn.onclick = () => document.body.removeChild(overlay);
            }

            // tombol download (simulasi saja dulu)
            const downloadBtn = modal.querySelector('.receipt-download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    const toast = document.createElement('div');
                    toast.className = 'receipt-toast';
                    toast.textContent = 'Bukti booking berhasil diunduh sebagai png.';

                    overlay.appendChild(toast);
                    requestAnimationFrame(() => {
                        toast.classList.add('visible');
                    });
                    setTimeout(() => {
                        toast.classList.remove('visible');
                        setTimeout(() => toast.remove(), 300);
                    }, 2500);
                };
            }
        }

        function showPaymentReceiptModal(opts) {
            const {
                serviceName,
                total,
                discountCode,
                paymentMethod,
                customerName,
                customerEmail,
                visitDate,
                visitTime,
                ewalletProvider,
                vaBank
            } = opts || {};

            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) document.body.removeChild(overlay);
            };

            const modal = document.createElement('div');
            modal.className = 'modal payment-receipt-modal';

            const ref = generatePaymentRef(
                paymentMethod === 'va_bank'   ? 'VA'
            : paymentMethod === 'transfer' ? 'TRF'
            : 'EW'
            );

            const formattedTotal = formatCurrency(total || 0);
            const prettyDate = visitDate || '-';
            const prettyTime = visitTime || '-';

            const ewalletLabelMap = {
                ovo: 'OVO',
                gopay: 'GoPay',
                dana: 'Dana',
                shopeepay: 'ShopeePay'
            };
            const vaBankLabelMap = {
                bca: 'BCA',
                bni: 'BNI',
                bri: 'BRI',
                mandiri: 'Mandiri',
                lainnya: 'Bank lainnya'
            };

            const ewalletNiceName = ewalletLabelMap[ewalletProvider] || 'e-wallet pilihan Anda';
            const vaBankNiceName  = vaBankLabelMap[vaBank] || 'bank pilihan Anda';

            let methodLabel =
                paymentMethod === 'va_bank'   ? `Virtual Account ${vaBankNiceName}`
            : paymentMethod === 'transfer' ? 'Transfer Bank Manual'
            : 'E-Wallet';

            if (paymentMethod === 'ewallet') {
                methodLabel = `E-Wallet (${ewalletNiceName})`;
            }

            let methodIcon = '💳';
            let methodInfoHTML = '';
            let highlightTitle = '';

            // === INSTRUKSI E-WALLET (contoh GoPay) ===
            if (paymentMethod === 'ewallet') {
                methodIcon    = '📱';
                highlightTitle = `Pembayaran via ${ewalletNiceName}`;

                const payCode = generatePaymentRef('EWPAY');

                methodInfoHTML = `
                    <p>
                        Anda memilih pembayaran melalui <strong>${ewalletNiceName}</strong>.
                        Ikuti langkah berikut di aplikasi e-wallet Anda:
                    </p>
                    <ol class="receipt-steps">
                        <li>Buka aplikasi <strong>${ewalletNiceName}</strong> di ponsel Anda.</li>
                        <li>Pilih menu <strong>Scan</strong> atau <strong>Bayar</strong>.</li>
                        <li>Jika diminta, masukkan atau scan <strong>kode pembayaran</strong> berikut:</li>
                    </ol>
                    <div class="receipt-va-box">
                        <div class="receipt-va-bank">Kode Pembayaran</div>
                        <div class="receipt-va-number">${payCode}</div>
                    </div>
                    <p class="receipt-small-note">
                        Di implementasi produksi, kode ini akan digantikan oleh kode dari sistem pembayaran resmi.
                    </p>
                `;
            } else if (paymentMethod === 'va_bank') {
                methodIcon    = '🏦';
                highlightTitle = `Pembayaran via Virtual Account ${vaBankNiceName}`;

                const vaNumber = generatePaymentRef(
                    (vaBankNiceName || 'VA').split(' ')[0].toUpperCase()
                );

                methodInfoHTML = `
                    <p>
                        Anda memilih pembayaran melalui <strong>Virtual Account ${vaBankNiceName}</strong>.
                        Ikuti langkah berikut:
                    </p>
                    <ol class="receipt-steps">
                        <li>Buka aplikasi mobile banking / internet banking / ATM <strong>${vaBankNiceName}</strong>.</li>
                        <li>Pilih menu <strong>Pembayaran &gt; Virtual Account</strong> atau menu serupa.</li>
                        <li>Masukkan <strong>Nomor Virtual Account</strong> berikut, lalu cek nama dan nominal:</li>
                    </ol>
                    <div class="receipt-va-box">
                        <div class="receipt-va-bank">No. Virtual Account</div>
                        <div class="receipt-va-number">${vaNumber}</div>
                    </div>
                    <p class="receipt-small-note">
                        Setelah pembayaran berhasil, simpan bukti transaksi Anda.
                        Tim kami akan melakukan verifikasi dan mengonfirmasi jadwal kunjungan melalui WhatsApp / email.
                    </p>
                `;
            } else if (paymentMethod === 'transfer') {
                methodIcon    = '🏧';
                highlightTitle = 'Pembayaran via Transfer Bank Manual';

                methodInfoHTML = `
                    <p>
                        Anda memilih <strong>Transfer Bank Manual</strong>. Silakan transfer sebesar
                        <strong>${formattedTotal}</strong> ke rekening resmi klinik kami.
                    </p>
                    <ol class="receipt-steps">
                        <li>Lakukan transfer melalui ATM / mobile banking / internet banking ke nomor rekening yang akan kami kirimkan.</li>
                        <li>Setelah transfer, simpan bukti pembayaran (screenshot / foto struk).</li>
                        <li>Kirim bukti ke kontak admin yang tertera agar jadwal kunjungan bisa dikonfirmasi.</li>
                    </ol>
                    <p class="receipt-small-note">
                        Detail nomor rekening dan kontak admin dapat dikirim secara terpisah melalui WhatsApp / email.
                    </p>
                `;
            }
            // === VA BANK & TRANSFER manual tetap seperti sebelumnya ===
            // ... (blok va_bank & transfer di sini, tidak saya ulang biar singkat)

            modal.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-icon">${methodIcon}</div>
                    <div>
                        <h2 class="receipt-title">Bukti Pemesanan & Pembayaran</h2>
                        <p class="receipt-subtitle">
                            Pesanan untuk layanan <strong>${escapeHtml(serviceName || '')}</strong> berhasil dibuat.
                        </p>
                    </div>
                </div>

                <div class="receipt-body">
                    <!-- highlight utama -->
                    <div class="receipt-highlight">
                        <div class="receipt-highlight-method">${methodLabel}</div>
                        <div class="receipt-highlight-amount">${formattedTotal}</div>
                    </div>

                    <!-- DETAIL PEMESANAN -->
                    <div class="receipt-section">
                        <div class="receipt-section-title">Detail Pemesanan</div>
                        <div class="receipt-detail-grid">
                            <div class="receipt-detail-row">
                                <span>Nama Pemesan</span>
                                <span>${escapeHtml(customerName || '-')}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Email</span>
                                <span>${escapeHtml(customerEmail || '-')}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Tanggal Kunjungan</span>
                                <span>${prettyDate || '-'}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Perkiraan Waktu</span>
                                <span>${prettyTime || '-'}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Layanan</span>
                                <span>${escapeHtml(serviceName || '-')}</span>
                            </div>
                        </div>
                    </div>

                    <!-- DETAIL PEMBAYARAN -->
                    <div class="receipt-section">
                        <div class="receipt-section-title">Detail Pembayaran</div>
                        <div class="receipt-detail-grid">
                            <div class="receipt-detail-row">
                                <span>Metode</span>
                                <span>${methodLabel}</span>
                            </div>
                            ${discountCode ? `
                            <div class="receipt-detail-row">
                                <span>Kode Promo</span>
                                <span>${escapeHtml(discountCode)}</span>
                            </div>
                            ` : `
                            <div class="receipt-detail-row">
                                <span>Kode Promo</span>
                                <span>-</span>
                            </div>
                            `}
                            <div class="receipt-detail-row">
                                <span>Total Dibayar</span>
                                <span class="receipt-detail-total">${formattedTotal}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Kode Referensi</span>
                                <span>${ref}</span>
                            </div>
                            <div class="receipt-detail-row">
                                <span>Status</span>
                                <span class="receipt-status-chip">Menunggu Pembayaran</span>
                            </div>
                        </div>
                    </div>

                    <!-- INSTRUKSI SESUAI METODE -->
                    <div class="receipt-section">
                        <div class="receipt-section-title">Instruksi Pembayaran</div>
                        <div class="receipt-instruction">
                            ${methodInfoHTML}
                        </div>
                    </div>
                </div>

                <div class="receipt-footer-actions">
                    <button type="button" class="receipt-download-btn">
                        ⬇️ Download Bukti Pembayaran
                    </button>
                    <button type="button" class="receipt-close-btn">
                        Tutup
                    </button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // tombol tutup
            const closeBtn = modal.querySelector('.receipt-close-btn');
            if (closeBtn) {
                closeBtn.onclick = () => document.body.removeChild(overlay);
            }

            // tombol download (simulasi)
            const downloadBtn = modal.querySelector('.receipt-download-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    // buat toast notifikasi di atas card
                    const toast = document.createElement('div');
                    toast.className = 'receipt-toast';
                    toast.textContent = 'Bukti pembayaran berhasil diunduh sebagai jpg.';

                    overlay.appendChild(toast);

                    // animasi muncul
                    requestAnimationFrame(() => {
                        toast.classList.add('visible');
                    });

                    // hilang setelah 2.5 detik
                    setTimeout(() => {
                        toast.classList.remove('visible');
                        setTimeout(() => toast.remove(), 300);
                    }, 2500);
                };
            }
        }

        /* ===============================
        Render Training Programs Grid
        =============================== */
        function renderTrainingPrograms(obj) {
            // otomatis pindah tab ke Soft Skills
            switchToSoftMode();

            const card = document.createElement('div');
            card.className = 'card training-card';

            // Header
            const title = document.createElement('h4');
            title.innerText = obj.summary_card?.title || "Pelatihan Soft Skills";
            card.appendChild(title);

            if (obj.summary_card?.subtitle) {
                const sub = document.createElement('p');
                sub.className = 'training-subtitle';
                sub.innerText = obj.summary_card.subtitle;
                card.appendChild(sub);
            }

            const grid = document.createElement('div');
            grid.className = 'training-grid';

            (obj.grid || []).forEach(item => {
                const it = document.createElement('div');
                it.className = 'training-item';

                // ambil program pertama sebagai highlight
                const programs = item.programs || [];
                const firstProgram = programs[0] || {};
                const includesPreview = Array.isArray(firstProgram.includes)
                    ? firstProgram.includes.slice(0, 3)
                    : [];

                // ===== HEADER (icon + judul + meta) =====
                const headerRow = document.createElement('div');
                headerRow.className = 'training-header-row';

                const iconBadge = document.createElement('div');
                iconBadge.className = 'training-icon-badge';
                iconBadge.textContent = item.icon || '📘';

                const headerTextWrap = document.createElement('div');

                const h = document.createElement('h5');
                h.className = 'training-title';
                h.innerText = item.title;
                headerTextWrap.appendChild(h);

                const meta = document.createElement('div');
                meta.className = 'training-meta';

                const modeSpan = document.createElement('span');
                modeSpan.className = 'training-mode-pill';
                modeSpan.innerText = firstProgram.mode || 'Online & Offline Fleksibel';
                meta.appendChild(modeSpan);

                if (firstProgram.duration) {
                    const durSpan = document.createElement('span');
                    durSpan.className = 'training-duration';
                    durSpan.innerText = firstProgram.duration;
                    meta.appendChild(durSpan);
                }

                headerTextWrap.appendChild(meta);

                headerRow.appendChild(iconBadge);
                headerRow.appendChild(headerTextWrap);
                it.appendChild(headerRow);

                // ===== DESKRIPSI SINGKAT =====
                const p = document.createElement('p');
                p.className = 'training-desc';
                p.innerText = item.short_desc || "";
                it.appendChild(p);

                // ===== PREVIEW BENEFIT / MATERI =====
                if (includesPreview.length) {
                    const ul = document.createElement('ul');
                    ul.className = 'training-benefits-mini';

                    includesPreview.forEach(txt => {
                        const li = document.createElement('li');
                        li.innerText = txt;
                        ul.appendChild(li);
                    });

                    it.appendChild(ul);
                }

                // ===== FOOTER: harga mini + tombol detail =====
                const footer = document.createElement('div');
                footer.className = 'training-footer';

                const priceTag = document.createElement('div');
                priceTag.className = 'training-price-tag';

                if (firstProgram.price != null) {
                    priceTag.innerHTML = `Mulai dari <span>${formatCurrency(firstProgram.price)}</span>`;
                } else {
                    priceTag.textContent = 'Detail harga tersedia di halaman berikutnya.';
                }

                const btn = document.createElement('button');
                btn.className = 'training-detail-btn';
                btn.innerText = 'Lihat Detail Program';
                btn.onclick = () => showTrainingDetail(item);

                footer.appendChild(priceTag);
                footer.appendChild(btn);

                it.appendChild(footer);
                grid.appendChild(it);
            });

            card.appendChild(grid);

            // footer actions global (misalnya "Lihat Jadwal Pelatihan")
            if (obj.actions && obj.actions.length) {
                const actbar = document.createElement('div');
                actbar.className = 'action-bar';
                obj.actions.forEach(a => {
                    const b = document.createElement('button');
                    b.className = 'btn';
                    b.innerText = a.label;
                    b.onclick = () => handleAction(a.action);
                    actbar.appendChild(b);
                });
                card.appendChild(actbar);
            }

            return card;
        }

        /* --------------------------
        Render Location Directory
        returns DOM node
        -------------------------- */
        function renderLocationDirectory(obj) {
            const card = document.createElement('div');
            card.className = 'card loc-card';
            const title = document.createElement('h4');
            title.innerText = obj.summary_card?.title || 'Lokasi';
            card.appendChild(title);

            // preview table
            const table = document.createElement('table');
            table.className = 'loc-table';
            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            (obj.columns || []).forEach(c => { const th = document.createElement('th'); th.innerText = c; trh.appendChild(th); });
            thead.appendChild(trh); 
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const rows = obj.rows || [];
            const maxPreview = (obj.render_options && obj.render_options.max_rows_preview) ? obj.render_options.max_rows_preview : 3;
            rows.slice(0, maxPreview).forEach(r => {
                const tr = document.createElement('tr');
                const vals = [r.branch, r.city, r.address, r.hours, (r.services || []).join(", "), r.contact];
                vals.forEach(v => { const td = document.createElement('td'); td.innerText = v || ''; tr.appendChild(td); });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            card.appendChild(table);

            // events
            if (obj.events && obj.events.length) {
                const evwrap = document.createElement('div');
                evwrap.className = 'events';
                obj.events.forEach(e => {
                    const ecard = document.createElement('div');
                    ecard.className = 'event-card';
                    const h = document.createElement('strong');
                    h.innerText = `${e.title} — ${e.date} (${e.branch})`;
                    const p = document.createElement('p');
                    p.innerText = e.description || '';
                    const b = document.createElement('button');
                    b.className = 'btn-small';
                    b.innerText = e.registration_action?.label || 'Daftar';
                    b.onclick = () => handleAction(e.registration_action?.action);
                    ecard.appendChild(h); 
                    ecard.appendChild(p); 
                    ecard.appendChild(b);
                    evwrap.appendChild(ecard);
                });
                card.appendChild(evwrap);
            }

            // actions
            if (obj.actions && obj.actions.length) {
                const ab = document.createElement('div');
                ab.className = 'action-bar';
                obj.actions.forEach(a => {
                    const b = document.createElement('button');
                    b.className = 'btn';
                    b.innerText = a.label;
                    b.onclick = () => {
                        if (a.action === 'open_maps') {
                            window.open('https://www.google.com/maps', '_blank');
                        } else {
                            handleAction(a.action);
                        }
                    };
                    ab.appendChild(b);
                });
                card.appendChild(ab);
            }

            return card;
        }

        /* --------------------------
        Actions Handler
        -------------------------- */
        function handleAction(actionKey) {
            if (!actionKey) return;
            switch (actionKey) {
                case 'book_now':
                case 'book_branch':
                case 'book_physio':
                case 'book_psych':
                    alert('Booking flow: redirect to booking page (implement endpoint). Action=' + actionKey);
                    break;

                case 'check_insurance':
                    alert('Cek Asuransi: buka modal atau halaman Cek Asuransi');
                    break;

                case 'view_training_schedule':
                    alert('Lihat jadwal pelatihan (implement view).');
                    break;

                case 'open_maps':
                    window.open('https://www.google.com/maps', '_blank');
                    break;

                default:
                    alert('Action: ' + actionKey);
            }
        }

        /* --------------------------
        Misc utilities
        -------------------------- */
        function formatCurrency(n) {
            if (!n && n !== 0) return '';
            try {
                return n.toLocaleString('id-ID') + ' IDR';
            } catch (e) {
                return String(n) + ' IDR';
            }
        }

        function generatePaymentRef(prefix = 'AUR') {
            const now = Date.now().toString(36).toUpperCase();
            const rand = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `${prefix}-${now}-${rand}`;
        }

        function onTanyaDokterClick() {
            switchToMedisMode();
            currentTopic  = 'Tanya Dokter';
            const label   = 'Tanya Dokter';
            sendMessageFlow(label, 'ask_doctor');
        }

        function onPelatihanSoftSkillsClick() {
            switchToSoftMode();
            currentTopic  = 'Pelatihan Soft Skills';
            const label   = 'Pelatihan Soft Skills';
            sendMessageFlow(label, 'ask_training');
        }

        function onBantuanClick() {
            // kalau mau default di Medis:
            switchToMedisMode();
            currentTopic  = 'Bantuan';
            const label   = 'Bantuan';
            sendMessageFlow(label, 'ask_help');
        }

        function getFacilityBookingBenefits(item) {
            const title = (item.title || '').toLowerCase();

            // contoh spesifik per jenis (boleh kamu edit sesuka hati)
            if (title.includes('psikolog') || title.includes('konseling')) {
                return [
                    {
                        benefit: 'Jadwal konseling yang pasti',
                        reason: 'Psikolog biasanya punya slot terbatas dan cepat penuh.',
                        example: 'Anda langsung mendapatkan slot jam tertentu dan konfirmasi sebelum datang.'
                    },
                    {
                        benefit: 'Waktu sesi lebih terencana',
                        reason: 'Topik dan tujuan sesi bisa disiapkan lebih dulu.',
                        example: 'Psikolog sudah membaca catatan singkat Anda sehingga sesi lebih fokus.'
                    },
                    {
                        benefit: 'Privasi & kerahasiaan lebih terjaga',
                        reason: 'Tim bisa mengatur ruangan sesuai kebutuhan.',
                        example: 'Anda tidak perlu menunggu lama di ruang tunggu umum.'
                    }
                ];
            }

            if (title.includes('fisioterapi')) {
                return [
                    {
                        benefit: 'Penyesuaian jadwal dengan terapis & alat',
                        reason: 'Beberapa tindakan butuh alat dan durasi khusus.',
                        example: 'Terapis dan alat sudah disiapkan sesuai keluhan (punggung, lutut, dll).'
                    },
                    {
                        benefit: 'Estimasi sesi & rencana terapi',
                        reason: 'Rencana sesi bisa dijelaskan sejak awal.',
                        example: 'Perkiraan berapa kali sesi dan fokus terapi diinformasikan saat konfirmasi.'
                    },
                    {
                        benefit: 'Mengurangi waktu tunggu di fasilitas',
                        reason: 'Slot Anda sudah terjadwal.',
                        example: 'Anda tinggal datang mendekati jam yang disepakati.'
                    }
                ];
            }

            if (title.includes('tidur') || title.includes('sleep')) {
                return [
                    {
                        benefit: 'Penjadwalan pemeriksaan yang kompleks',
                        reason: 'Pemeriksaan tidur sering butuh alat & durasi panjang (misal tidur malam penuh).',
                        example: 'Anda mendapat jadwal khusus untuk pemeriksaan polisomnografi atau screening tidur.'
                    },
                    {
                        benefit: 'Briefing prosedur sebelum datang',
                        reason: 'Ada persiapan khusus (obat, pola tidur, dsb).',
                        example: 'Anda dikirimkan panduan apa saja yang perlu dilakukan sebelum hari H.'
                    }
                ];
            }

            if (title.includes('gizi') || title.includes('nutrisi')) {
                return [
                    {
                        benefit: 'Waktu konsultasi lebih fokus',
                        reason: 'Ahli gizi bisa menyiapkan format asesmen sesuai tujuan Anda.',
                        example: 'Misal program penurunan berat badan, kehamilan, atau penyakit tertentu.'
                    },
                    {
                        benefit: 'Rencana diet lebih personal',
                        reason: 'Data awal (berat, tinggi, pola makan) bisa dikumpulkan sebelum sesi.',
                        example: 'Saat datang, Anda langsung diskusi rencana menu harian.'
                    }
                ];
            }

            // default – fasilitas umum/klinik umum
            return [
                {
                    benefit: 'Kepastian jadwal & dokter/terapis',
                    reason: 'Anda tidak perlu antre lama tanpa kepastian.',
                    example: 'Anda mendapat konfirmasi jam & nama tenaga kesehatan sebelum datang.'
                },
                {
                    benefit: 'Estimasi biaya awal',
                    reason: 'Perkiraan biaya bisa disampaikan sebelum kunjungan.',
                    example: 'Tim akan memberi rentang biaya berdasarkan keluhan & polis asuransi (jika ada).'
                },
                {
                    benefit: 'Waktu tunggu lebih singkat',
                    reason: 'Fasilitas dapat mengatur alur pasien berdasarkan booking.',
                    example: 'Anda hanya perlu datang sedikit sebelum jadwal yang disepakati.'
                },
                {
                    benefit: 'Keluhan awal tercatat rapi',
                    reason: 'Dokter/terapis membaca ringkasan keluhan sebelum bertemu.',
                    example: 'Sesi konsultasi lebih efektif dan tidak banyak waktu terbuang di awal.'
                }
            ];
        }

        function buildBookingBenefitsTable(item) {
            const rows = getFacilityBookingBenefits(item);
            if (!rows || !rows.length) return '';

            const body = rows.map(r => `
                <tr>
                    <td>${escapeHtml(r.benefit)}</td>
                    <td>${escapeHtml(r.reason)}</td>
                    <td>${escapeHtml(r.example)}</td>
                </tr>
            `).join('');

            return `
                <div class="booking-benefits">
                    <div class="booking-benefits-title">
                        Manfaat booking ${escapeHtml(item.title || 'layanan')} melalui MediSkill
                    </div>
                    <table class="booking-benefits-table">
                        <thead>
                            <tr>
                                <th>Manfaat</th>
                                <th>Kenapa Penting</th>
                                <th>Contoh Konkret</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${body}
                        </tbody>
                    </table>
                </div>
            `;
        }
    </script>
    
</body>
</html>
